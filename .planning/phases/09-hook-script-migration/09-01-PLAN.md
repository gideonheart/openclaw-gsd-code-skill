---
phase: 09-hook-script-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/notification-idle-hook.sh
  - scripts/notification-permission-hook.sh
  - scripts/session-end-hook.sh
autonomous: true
requirements: [HOOK-14, HOOK-15, HOOK-16]

must_haves:
  truths:
    - "notification-idle-hook.sh writes one JSONL record per invocation with trigger=idle_prompt"
    - "notification-permission-hook.sh writes one JSONL record per invocation with trigger=permission_prompt"
    - "session-end-hook.sh writes one JSONL record per invocation with trigger=session_end and state=terminated"
    - "All three scripts source lib/hook-utils.sh before any guard exit"
    - "All existing debug_log calls remain unchanged — .log files continue in parallel"
    - "Guard exits (no TMUX, no registry) do NOT emit JSONL records"
  artifacts:
    - path: "scripts/notification-idle-hook.sh"
      provides: "JSONL-emitting idle prompt hook"
      contains: "deliver_async_with_logging"
    - path: "scripts/notification-permission-hook.sh"
      provides: "JSONL-emitting permission prompt hook"
      contains: "deliver_async_with_logging"
    - path: "scripts/session-end-hook.sh"
      provides: "JSONL-emitting session end hook"
      contains: "deliver_async_with_logging"
  key_links:
    - from: "scripts/notification-idle-hook.sh"
      to: "lib/hook-utils.sh"
      via: "source at top of script before guards"
      pattern: "source.*hook-utils\\.sh"
    - from: "scripts/notification-idle-hook.sh"
      to: "logs/{SESSION_NAME}.jsonl"
      via: "deliver_async_with_logging call"
      pattern: "deliver_async_with_logging"
---

<objective>
Migrate the three simplest hook scripts (notification-idle-hook.sh, notification-permission-hook.sh, session-end-hook.sh) to emit structured JSONL records using deliver_async_with_logging() from lib/hook-utils.sh.

Purpose: Validate the JSONL migration pattern on the simplest hooks first — all three are async-only with no bidirectional branch. This establishes the migration template for the remaining hooks.

Output: Three modified hook scripts, each with: lib sourced at top, HOOK_ENTRY_MS after stdin, JSONL_FILE alongside GSD_HOOK_LOG, deliver_async_with_logging() replacing bare openclaw call, old debug_log calls preserved.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-jsonl-logging-foundation/08-02-SUMMARY.md
@lib/hook-utils.sh
@scripts/notification-idle-hook.sh
@scripts/notification-permission-hook.sh
@scripts/session-end-hook.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate notification-idle-hook.sh and notification-permission-hook.sh to JSONL</name>
  <files>scripts/notification-idle-hook.sh, scripts/notification-permission-hook.sh</files>
  <action>
Apply these 5 changes to BOTH scripts (they are nearly identical):

**Change 1: Move lib source to top of script.** After the debug_log function definition and the "FIRED" log line, add:
```bash
# Source shared library BEFORE any guard exits (Phase 9 requirement)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_PATH="${SCRIPT_DIR}/../lib/hook-utils.sh"
if [ -f "$LIB_PATH" ]; then
  source "$LIB_PATH"
else
  debug_log "FATAL: hook-utils.sh not found at $LIB_PATH"
  exit 0
fi
```

**Change 2: Add HOOK_ENTRY_MS after stdin consumption.** Immediately after `STDIN_JSON=$(cat)`, add:
```bash
HOOK_ENTRY_MS=$(date +%s%3N)
```

**Change 3: Add JSONL_FILE in Phase 2 redirect block.** After `GSD_HOOK_LOG="${SKILL_LOG_DIR}/${SESSION_NAME}.log"`, add:
```bash
JSONL_FILE="${SKILL_LOG_DIR}/${SESSION_NAME}.jsonl"
```

**Change 4: Delete the mid-script LIB_PATH + source block.** Remove the existing block in section 4 (after REGISTRY_PATH check) that sets SCRIPT_DIR, LIB_PATH, and sources hook-utils.sh. Keep the REGISTRY_PATH check and the lookup_agent_in_registry call and everything after. Remove the now-redundant SCRIPT_DIR assignment in section 4 as well (SCRIPT_DIR was already set at the top).

**Change 5: Replace bare openclaw delivery with deliver_async_with_logging().** For each script:
- Set TRIGGER and CONTENT_SOURCE variables before the delivery block:
  - notification-idle-hook.sh: `TRIGGER="idle_prompt"`, `CONTENT_SOURCE="pane"`
  - notification-permission-hook.sh: `TRIGGER="permission_prompt"`, `CONTENT_SOURCE="pane"`
- Replace the async `else` branch:
  ```bash
  # Old:
  openclaw agent --session-id "$OPENCLAW_SESSION_ID" --message "$WAKE_MESSAGE" >> "$GSD_HOOK_LOG" 2>&1 &
  debug_log "DELIVERED (async, bg PID=$!)"
  ```
  With:
  ```bash
  deliver_async_with_logging \
    "$OPENCLAW_SESSION_ID" "$WAKE_MESSAGE" "$JSONL_FILE" "$HOOK_ENTRY_MS" \
    "$HOOK_SCRIPT_NAME" "$SESSION_NAME" "$AGENT_ID" \
    "$TRIGGER" "$STATE" "$CONTENT_SOURCE"
  debug_log "DELIVERED (async with JSONL logging)"
  ```
- For the bidirectional branch (`if [ "$HOOK_MODE" = "bidirectional" ]`), add a write_hook_event_record() call after RESPONSE is captured:
  ```bash
  write_hook_event_record \
    "$JSONL_FILE" "$HOOK_ENTRY_MS" "$HOOK_SCRIPT_NAME" "$SESSION_NAME" \
    "$AGENT_ID" "$OPENCLAW_SESSION_ID" "$TRIGGER" "$STATE" \
    "$CONTENT_SOURCE" "$WAKE_MESSAGE" "$RESPONSE" "sync_delivered"
  ```
  Add it right after the `debug_log "RESPONSE: ${RESPONSE:0:200}"` line, before the decision parsing block.

Keep ALL existing debug_log calls. Do NOT remove any. JSONL is additive.
  </action>
  <verify>
Run: `bash -n scripts/notification-idle-hook.sh && bash -n scripts/notification-permission-hook.sh` (syntax check passes).
Run: `grep -c 'deliver_async_with_logging' scripts/notification-idle-hook.sh` returns 1.
Run: `grep -c 'deliver_async_with_logging' scripts/notification-permission-hook.sh` returns 1.
Run: `grep -c 'write_hook_event_record' scripts/notification-idle-hook.sh` returns 1.
Run: `grep -c 'write_hook_event_record' scripts/notification-permission-hook.sh` returns 1.
Run: `grep -c 'HOOK_ENTRY_MS' scripts/notification-idle-hook.sh` returns 1.
Run: `grep -c 'JSONL_FILE' scripts/notification-idle-hook.sh` returns 2 (assignment + usage).
Verify lib is sourced BEFORE first guard: `grep -n 'source.*hook-utils' scripts/notification-idle-hook.sh` shows line < first guard exit line.
Verify old mid-script source block is removed: only one `source "$LIB_PATH"` in each file.
  </verify>
  <done>Both notification hooks source lib at top, set HOOK_ENTRY_MS after stdin, set JSONL_FILE in Phase 2 redirect, use deliver_async_with_logging for async path, use write_hook_event_record for bidirectional path, and preserve all debug_log calls.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate session-end-hook.sh to JSONL</name>
  <files>scripts/session-end-hook.sh</files>
  <action>
Apply the same 5-change pattern as Task 1 with these session-end-specific values:

**Change 1: Move lib source to top.** Same pattern as Task 1 — after debug_log definition and "FIRED" log line, add SCRIPT_DIR and source block.

**Change 2: Add HOOK_ENTRY_MS.** Immediately after `STDIN_JSON=$(cat)`, add `HOOK_ENTRY_MS=$(date +%s%3N)`.

**Change 3: Add JSONL_FILE in Phase 2 redirect.** After `GSD_HOOK_LOG="${SKILL_LOG_DIR}/${SESSION_NAME}.log"`, add `JSONL_FILE="${SKILL_LOG_DIR}/${SESSION_NAME}.jsonl"`.

**Change 4: Delete mid-script LIB_PATH + source block.** Remove the block in section 4 that sets SCRIPT_DIR, LIB_PATH, and sources hook-utils.sh. Keep REGISTRY_PATH check and lookup.

**Change 5: Replace bare openclaw delivery.** session-end-hook.sh is ALWAYS async (no bidirectional branch). Set:
```bash
TRIGGER="session_end"
STATE="terminated"
CONTENT_SOURCE="none"
```
Note: session-end-hook.sh does NOT have a hook_settings extraction block and does NOT have a STATE detection block — STATE is always "terminated". Set TRIGGER, STATE, and CONTENT_SOURCE just before the delivery call.

Replace the bare openclaw call:
```bash
# Old:
openclaw agent --session-id "$OPENCLAW_SESSION_ID" --message "$WAKE_MESSAGE" >> "$GSD_HOOK_LOG" 2>&1 &
debug_log "DELIVERED (async, bg PID=$!)"
```
With:
```bash
TRIGGER="session_end"
STATE="terminated"
CONTENT_SOURCE="none"
deliver_async_with_logging \
  "$OPENCLAW_SESSION_ID" "$WAKE_MESSAGE" "$JSONL_FILE" "$HOOK_ENTRY_MS" \
  "$HOOK_SCRIPT_NAME" "$SESSION_NAME" "$AGENT_ID" \
  "$TRIGGER" "$STATE" "$CONTENT_SOURCE"
debug_log "DELIVERED (async with JSONL logging)"
```

Keep the pane state file cleanup (section 7) AFTER delivery — it is unrelated to JSONL.
Keep ALL debug_log calls.
  </action>
  <verify>
Run: `bash -n scripts/session-end-hook.sh` (syntax check passes).
Run: `grep -c 'deliver_async_with_logging' scripts/session-end-hook.sh` returns 1.
Run: `grep -c 'HOOK_ENTRY_MS' scripts/session-end-hook.sh` returns 1.
Run: `grep -c 'JSONL_FILE' scripts/session-end-hook.sh` returns 2.
Verify TRIGGER="session_end" is set.
Verify STATE="terminated" is set.
Verify CONTENT_SOURCE="none" is set.
Verify lib sourced before first guard exit.
Verify only one `source "$LIB_PATH"` in the file.
  </verify>
  <done>session-end-hook.sh sources lib at top, sets HOOK_ENTRY_MS, sets JSONL_FILE, uses deliver_async_with_logging with trigger=session_end, state=terminated, content_source=none. Pane cleanup preserved. All debug_log calls preserved.</done>
</task>

</tasks>

<verification>
For all three modified scripts:
1. `bash -n scripts/notification-idle-hook.sh && bash -n scripts/notification-permission-hook.sh && bash -n scripts/session-end-hook.sh` — all pass syntax check
2. Each file has exactly ONE `source "$LIB_PATH"` call (no double-sourcing)
3. The source call appears BEFORE the first `exit 0` guard (line number verification)
4. `HOOK_ENTRY_MS=$(date +%s%3N)` appears immediately after `STDIN_JSON=$(cat)` in each file
5. `JSONL_FILE` is assigned in the Phase 2 redirect block of each file
6. `deliver_async_with_logging` appears in each file
7. All existing `debug_log` calls remain (count must not decrease)
8. Guard exits (TMUX check, SESSION_NAME check, REGISTRY check, AGENT_DATA check) do NOT call deliver_async_with_logging or write_hook_event_record
</verification>

<success_criteria>
All three simple hooks emit structured JSONL records via deliver_async_with_logging() while preserving all existing plain-text debug_log behavior. Source ordering correct (lib before guards). No double-sourcing. Syntax-valid bash.
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-script-migration/09-01-SUMMARY.md`
</output>
