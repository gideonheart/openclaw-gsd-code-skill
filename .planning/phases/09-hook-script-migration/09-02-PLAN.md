---
phase: 09-hook-script-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/pre-tool-use-hook.sh
  - scripts/pre-compact-hook.sh
autonomous: true
requirements: [HOOK-13, HOOK-17, ASK-04]

must_haves:
  truths:
    - "pre-tool-use-hook.sh writes one JSONL record per invocation with trigger=ask_user_question and content_source=questions"
    - "pre-tool-use-hook.sh JSONL record's wake_message field contains the full [ASK USER QUESTION] section with questions, options, and headers (satisfies ASK-04 questions_forwarded requirement)"
    - "pre-compact-hook.sh writes one JSONL record per invocation with trigger=pre_compact"
    - "pre-compact-hook.sh bidirectional branch writes JSONL via write_hook_event_record() with outcome=sync_delivered"
    - "Both scripts source lib/hook-utils.sh before any guard exit"
    - "All existing debug_log calls remain unchanged"
    - "Guard exits do NOT emit JSONL records"
  artifacts:
    - path: "scripts/pre-tool-use-hook.sh"
      provides: "JSONL-emitting AskUserQuestion forwarding hook"
      contains: "deliver_async_with_logging"
    - path: "scripts/pre-compact-hook.sh"
      provides: "JSONL-emitting pre-compact hook with bidirectional support"
      contains: "deliver_async_with_logging"
  key_links:
    - from: "scripts/pre-tool-use-hook.sh"
      to: "lib/hook-utils.sh"
      via: "source at top of script before guards"
      pattern: "source.*hook-utils\\.sh"
    - from: "scripts/pre-tool-use-hook.sh"
      to: "logs/{SESSION_NAME}.jsonl"
      via: "deliver_async_with_logging with wake_message containing questions data"
      pattern: "deliver_async_with_logging"
    - from: "scripts/pre-compact-hook.sh"
      to: "lib/hook-utils.sh"
      via: "write_hook_event_record in bidirectional branch"
      pattern: "write_hook_event_record"
---

<objective>
Migrate pre-tool-use-hook.sh and pre-compact-hook.sh to emit structured JSONL records. pre-tool-use-hook.sh satisfies ASK-04 by carrying the full [ASK USER QUESTION] section in the wake_message field (Option B from research — no function signature change needed). pre-compact-hook.sh has a bidirectional branch requiring inline write_hook_event_record().

Purpose: Complete JSONL migration for the two medium-complexity hooks. pre-tool-use is async-only but has the ASK-04 questions_forwarded requirement. pre-compact has a bidirectional branch like stop-hook.sh but simpler (no dynamic content source).

Output: Two modified hook scripts with JSONL logging, ASK-04 satisfied via wake_message, and bidirectional JSONL support for pre-compact.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-jsonl-logging-foundation/08-02-SUMMARY.md
@lib/hook-utils.sh
@scripts/pre-tool-use-hook.sh
@scripts/pre-compact-hook.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate pre-tool-use-hook.sh to JSONL with ASK-04 questions_forwarded</name>
  <files>scripts/pre-tool-use-hook.sh</files>
  <action>
Apply the standard 5-change migration pattern with these pre-tool-use-specific values:

**Change 1: Move lib source to top.** After debug_log definition and "FIRED" log line, add SCRIPT_DIR and source block (same pattern as Plan 09-01). Note: pre-tool-use-hook.sh has a `debug_log "sourced lib/hook-utils.sh"` inside the old mid-script block — this should move up to the new top-level source block.

**Change 2: Add HOOK_ENTRY_MS.** After `STDIN_JSON=$(cat)`, add `HOOK_ENTRY_MS=$(date +%s%3N)`.

**Change 3: Add JSONL_FILE in Phase 2 redirect.** After `GSD_HOOK_LOG="${SKILL_LOG_DIR}/${SESSION_NAME}.log"`, add `JSONL_FILE="${SKILL_LOG_DIR}/${SESSION_NAME}.jsonl"`.

**Change 4: Delete mid-script LIB_PATH + source block.** Remove the block in section 4 (after REGISTRY_PATH check) that sets SCRIPT_DIR, LIB_PATH, and sources hook-utils.sh. Keep REGISTRY_PATH check and lookup_agent_in_registry call.

**Change 5: Replace bare openclaw delivery with deliver_async_with_logging().**

Set trigger and content_source variables before the delivery section:
```bash
TRIGGER="ask_user_question"
CONTENT_SOURCE="questions"
STATE="awaiting_user_input"
```

Replace the bare openclaw call in section 8:
```bash
# Old:
openclaw agent --session-id "$OPENCLAW_SESSION_ID" --message "$WAKE_MESSAGE" \
  >> "$GSD_HOOK_LOG" 2>&1 &
debug_log "DELIVERED (async AskUserQuestion forward, bg PID=$!)"
```
With:
```bash
deliver_async_with_logging \
  "$OPENCLAW_SESSION_ID" "$WAKE_MESSAGE" "$JSONL_FILE" "$HOOK_ENTRY_MS" \
  "$HOOK_SCRIPT_NAME" "$SESSION_NAME" "$AGENT_ID" \
  "$TRIGGER" "$STATE" "$CONTENT_SOURCE"
debug_log "DELIVERED (async AskUserQuestion forward with JSONL logging)"
```

**ASK-04 Design Decision (Option B):** The wake_message already contains the full [ASK USER QUESTION] section with formatted questions, options, and headers. No changes to write_hook_event_record() or deliver_async_with_logging() signatures are needed. The `wake_message` field in the JSONL record IS the `questions_forwarded` data — queryable via `jq '.wake_message'` on records where `trigger == "ask_user_question"` and `content_source == "questions"`.

Keep ALL existing debug_log calls. Keep exit 0 at the end. Keep all CRITICAL comments about async behavior.
  </action>
  <verify>
Run: `bash -n scripts/pre-tool-use-hook.sh` (syntax check passes).
Run: `grep -c 'deliver_async_with_logging' scripts/pre-tool-use-hook.sh` returns 1.
Run: `grep -c 'HOOK_ENTRY_MS' scripts/pre-tool-use-hook.sh` returns 1.
Run: `grep -c 'JSONL_FILE' scripts/pre-tool-use-hook.sh` returns 2 (assignment + usage in deliver call).
Run: `grep 'TRIGGER=' scripts/pre-tool-use-hook.sh` contains "ask_user_question".
Run: `grep 'CONTENT_SOURCE=' scripts/pre-tool-use-hook.sh` contains "questions".
Verify lib sourced before first guard exit.
Verify only one `source "$LIB_PATH"` in the file.
Verify no bare `openclaw agent` call remains.
  </verify>
  <done>pre-tool-use-hook.sh emits JSONL with trigger=ask_user_question, content_source=questions, and wake_message carrying the full ASK USER QUESTION section (satisfying ASK-04). All debug_log calls preserved. Exit 0 behavior unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate pre-compact-hook.sh to JSONL with bidirectional support</name>
  <files>scripts/pre-compact-hook.sh</files>
  <action>
Apply the standard 5-change migration pattern with bidirectional branch handling:

**Change 1: Move lib source to top.** After debug_log definition and "FIRED" log line, add SCRIPT_DIR and source block.

**Change 2: Add HOOK_ENTRY_MS.** After `STDIN_JSON=$(cat)`, add `HOOK_ENTRY_MS=$(date +%s%3N)`.

**Change 3: Add JSONL_FILE in Phase 2 redirect.** After `GSD_HOOK_LOG="${SKILL_LOG_DIR}/${SESSION_NAME}.log"`, add `JSONL_FILE="${SKILL_LOG_DIR}/${SESSION_NAME}.jsonl"`.

**Change 4: Delete mid-script LIB_PATH + source block.** Remove the existing source block in section 4. Keep REGISTRY_PATH check and lookup.

**Change 5: Replace delivery with JSONL-aware versions.**

Set trigger and content_source before delivery:
```bash
TRIGGER="pre_compact"
CONTENT_SOURCE="pane"
```

**Bidirectional branch:** After the synchronous openclaw call and `debug_log "RESPONSE: ..."`, add write_hook_event_record() call:
```bash
write_hook_event_record \
  "$JSONL_FILE" "$HOOK_ENTRY_MS" "$HOOK_SCRIPT_NAME" "$SESSION_NAME" \
  "$AGENT_ID" "$OPENCLAW_SESSION_ID" "$TRIGGER" "$STATE" \
  "$CONTENT_SOURCE" "$WAKE_MESSAGE" "$RESPONSE" "sync_delivered"
```
Keep the existing `exit 0` after this.

**Async branch:** Replace bare openclaw call:
```bash
deliver_async_with_logging \
  "$OPENCLAW_SESSION_ID" "$WAKE_MESSAGE" "$JSONL_FILE" "$HOOK_ENTRY_MS" \
  "$HOOK_SCRIPT_NAME" "$SESSION_NAME" "$AGENT_ID" \
  "$TRIGGER" "$STATE" "$CONTENT_SOURCE"
debug_log "DELIVERED (async with JSONL logging)"
```

Keep ALL existing debug_log calls. Do NOT modify the pane capture command (pre-compact uses `-t "$SESSION_NAME:0.0" -p -S` which differs from other hooks — leave it).
  </action>
  <verify>
Run: `bash -n scripts/pre-compact-hook.sh` (syntax check passes).
Run: `grep -c 'deliver_async_with_logging' scripts/pre-compact-hook.sh` returns 1.
Run: `grep -c 'write_hook_event_record' scripts/pre-compact-hook.sh` returns 1.
Run: `grep -c 'HOOK_ENTRY_MS' scripts/pre-compact-hook.sh` returns 1.
Run: `grep -c 'JSONL_FILE' scripts/pre-compact-hook.sh` returns 3 (assignment + async usage + sync usage).
Verify TRIGGER="pre_compact" is set.
Verify CONTENT_SOURCE="pane" is set.
Verify lib sourced before first guard exit.
Verify only one `source "$LIB_PATH"` in the file.
Verify bidirectional branch has write_hook_event_record call with outcome "sync_delivered".
Verify no bare `openclaw agent` call remains in async branch.
  </verify>
  <done>pre-compact-hook.sh emits JSONL via deliver_async_with_logging (async path) and write_hook_event_record (bidirectional path). Trigger=pre_compact, content_source=pane. Pane capture command untouched. All debug_log calls preserved.</done>
</task>

</tasks>

<verification>
For both modified scripts:
1. `bash -n scripts/pre-tool-use-hook.sh && bash -n scripts/pre-compact-hook.sh` — syntax check passes
2. Each file has exactly ONE `source "$LIB_PATH"` call
3. Source call appears BEFORE first `exit 0` guard
4. HOOK_ENTRY_MS set immediately after STDIN_JSON=$(cat)
5. JSONL_FILE assigned in Phase 2 redirect block
6. deliver_async_with_logging appears in each file's async delivery path
7. pre-compact-hook.sh has write_hook_event_record in bidirectional branch with outcome "sync_delivered"
8. pre-tool-use-hook.sh has TRIGGER="ask_user_question" and CONTENT_SOURCE="questions"
9. All debug_log calls preserved (count unchanged)
10. Guard exits do NOT call any JSONL functions
</verification>

<success_criteria>
pre-tool-use-hook.sh emits JSONL with questions data in wake_message (ASK-04 satisfied). pre-compact-hook.sh emits JSONL in both async and bidirectional paths. Source ordering correct, no double-sourcing, syntax-valid bash, all debug_log preserved.
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-script-migration/09-02-SUMMARY.md`
</output>
