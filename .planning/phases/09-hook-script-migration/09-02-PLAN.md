---
phase: 09-hook-script-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/hook-utils.sh
  - tests/test-write-hook-event-record.sh
  - scripts/pre-tool-use-hook.sh
  - scripts/pre-compact-hook.sh
autonomous: true
requirements: [HOOK-13, HOOK-17, ASK-04]

must_haves:
  truths:
    - "write_hook_event_record() accepts optional 13th parameter extra_fields_json that gets merged into the JSONL record via jq --argjson"
    - "deliver_async_with_logging() accepts optional 11th parameter extra_fields_json and passes it through to write_hook_event_record()"
    - "Existing 12-parameter call sites continue to work unchanged — 13th parameter defaults to empty string"
    - "pre-tool-use-hook.sh writes one JSONL record per invocation with trigger=ask_user_question and content_source=questions"
    - "pre-tool-use-hook.sh JSONL record contains a top-level questions_forwarded field queryable via jq '.questions_forwarded' (satisfies ASK-04)"
    - "pre-compact-hook.sh writes one JSONL record per invocation with trigger=pre_compact"
    - "pre-compact-hook.sh bidirectional branch writes JSONL via write_hook_event_record() with outcome=sync_delivered"
    - "Both scripts source lib/hook-utils.sh before any guard exit"
    - "All existing debug_log calls remain unchanged"
    - "Guard exits do NOT emit JSONL records"
    - "tests/test-write-hook-event-record.sh includes test for 13th parameter extra_fields_json with questions_forwarded field"
  artifacts:
    - path: "lib/hook-utils.sh"
      provides: "Extended write_hook_event_record() with optional extra_fields_json parameter"
      contains: "extra_fields_json"
    - path: "tests/test-write-hook-event-record.sh"
      provides: "Test coverage for 13th parameter extra_fields_json"
      contains: "questions_forwarded"
    - path: "scripts/pre-tool-use-hook.sh"
      provides: "JSONL-emitting AskUserQuestion forwarding hook with questions_forwarded field"
      contains: "deliver_async_with_logging"
    - path: "scripts/pre-compact-hook.sh"
      provides: "JSONL-emitting pre-compact hook with bidirectional support"
      contains: "deliver_async_with_logging"
  key_links:
    - from: "scripts/pre-tool-use-hook.sh"
      to: "lib/hook-utils.sh"
      via: "source at top of script before guards"
      pattern: "source.*hook-utils\\.sh"
    - from: "scripts/pre-tool-use-hook.sh"
      to: "logs/{SESSION_NAME}.jsonl"
      via: "deliver_async_with_logging with extra_fields_json containing questions_forwarded"
      pattern: "deliver_async_with_logging"
    - from: "lib/hook-utils.sh write_hook_event_record()"
      to: "JSONL record"
      via: "jq --argjson extra_fields merges extra_fields_json into the record object"
      pattern: "extra_fields_json"
    - from: "scripts/pre-compact-hook.sh"
      to: "lib/hook-utils.sh"
      via: "write_hook_event_record in bidirectional branch"
      pattern: "write_hook_event_record"
---

<objective>
Extend write_hook_event_record() and deliver_async_with_logging() with an optional extra_fields_json parameter, then migrate pre-tool-use-hook.sh and pre-compact-hook.sh to emit structured JSONL records. pre-tool-use-hook.sh satisfies ASK-04 by passing a `questions_forwarded` field via the new extra_fields_json parameter — the JSONL record will contain a top-level `questions_forwarded` key queryable via `jq '.questions_forwarded'`. pre-compact-hook.sh has a bidirectional branch requiring inline write_hook_event_record().

Purpose: Satisfy ASK-04's requirement for a dedicated `questions_forwarded` JSON field in the JSONL record (Option A from research). The lib extension is backward-compatible — the 13th parameter defaults to empty via `${13:-""}`, so existing 12-parameter call sites (Plans 09-01, 09-03) continue to work without modification. Complete JSONL migration for the two medium-complexity hooks.

Output: Extended lib/hook-utils.sh with extra_fields_json support, updated test file, two modified hook scripts with JSONL logging, ASK-04 satisfied via dedicated questions_forwarded field.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-jsonl-logging-foundation/08-02-SUMMARY.md
@lib/hook-utils.sh
@tests/test-write-hook-event-record.sh
@scripts/pre-tool-use-hook.sh
@scripts/pre-compact-hook.sh
</context>

<tasks>

<task type="auto">
  <name>Task 0: Extend write_hook_event_record() and deliver_async_with_logging() with optional extra_fields_json parameter</name>
  <files>lib/hook-utils.sh, tests/test-write-hook-event-record.sh</files>
  <action>
**Part A: Extend write_hook_event_record() in lib/hook-utils.sh**

Add a 13th optional parameter `extra_fields_json` to `write_hook_event_record()`. This parameter accepts a JSON object string (e.g., `'{"questions_forwarded":"..."}'`) that gets merged into the JSONL record.

1. Update the function's docblock comment to document the 13th parameter:
```
#   $13 - extra_fields_json:     (optional) JSON object string to merge into record, e.g. '{"questions_forwarded":"..."}'
```

2. After the existing `local outcome="${12}"` line, add:
```bash
local extra_fields_json="${13:-}"
```

3. Modify the jq record construction. If `extra_fields_json` is non-empty, add `--argjson extra_fields "$extra_fields_json"` to the jq arguments and append `+ $extra_fields` to the jq expression to merge the extra fields into the record object. If empty, construct the record exactly as before (no merge).

The modified construction should be:
```bash
local record
if [ -n "$extra_fields_json" ]; then
  record=$(jq -cn \
    --arg timestamp "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
    --arg hook_script "$hook_script" \
    --arg session_name "$session_name" \
    --arg agent_id "$agent_id" \
    --arg openclaw_session_id "$openclaw_session_id" \
    --arg trigger "$trigger" \
    --arg state "$state" \
    --arg content_source "$content_source" \
    --arg wake_message "$wake_message" \
    --arg response "$response" \
    --arg outcome "$outcome" \
    --argjson duration_ms "$duration_ms" \
    --argjson extra_fields "$extra_fields_json" \
    '{
      timestamp: $timestamp,
      hook_script: $hook_script,
      session_name: $session_name,
      agent_id: $agent_id,
      openclaw_session_id: $openclaw_session_id,
      trigger: $trigger,
      state: $state,
      content_source: $content_source,
      wake_message: $wake_message,
      response: $response,
      outcome: $outcome,
      duration_ms: $duration_ms
    } + $extra_fields' 2>/dev/null) || return 0
else
  record=$(jq -cn \
    --arg timestamp "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
    --arg hook_script "$hook_script" \
    --arg session_name "$session_name" \
    --arg agent_id "$agent_id" \
    --arg openclaw_session_id "$openclaw_session_id" \
    --arg trigger "$trigger" \
    --arg state "$state" \
    --arg content_source "$content_source" \
    --arg wake_message "$wake_message" \
    --arg response "$response" \
    --arg outcome "$outcome" \
    --argjson duration_ms "$duration_ms" \
    '{
      timestamp: $timestamp,
      hook_script: $hook_script,
      session_name: $session_name,
      agent_id: $agent_id,
      openclaw_session_id: $openclaw_session_id,
      trigger: $trigger,
      state: $state,
      content_source: $content_source,
      wake_message: $wake_message,
      response: $response,
      outcome: $outcome,
      duration_ms: $duration_ms
    }' 2>/dev/null) || return 0
fi
```

**Important:** The `else` branch is identical to the current implementation — no regression for 12-parameter call sites.

**Part B: Extend deliver_async_with_logging() in lib/hook-utils.sh**

Add an 11th optional parameter `extra_fields_json` to `deliver_async_with_logging()` and pass it through to write_hook_event_record().

1. Update the docblock to document the 11th parameter:
```
#   $11 - extra_fields_json:     (optional) JSON object string to merge into JSONL record
```

2. After `local content_source="${10}"`, add:
```bash
local extra_fields_json="${11:-}"
```

3. In the backgrounded subshell, update the write_hook_event_record call to pass the extra_fields_json as the 13th argument:
```bash
write_hook_event_record \
  "$jsonl_file" "$hook_entry_ms" "$hook_script" "$session_name" \
  "$agent_id" "$openclaw_session_id" "$trigger" "$state" \
  "$content_source" "$wake_message" "$response" "$outcome" \
  "$extra_fields_json"
```

**Part C: Add test coverage in tests/test-write-hook-event-record.sh**

Add two new tests after the existing Test D (before the Summary section):

**Test E — 13th parameter extra_fields_json with questions_forwarded:**
```bash
# --------------------------------------------------------------------------
# Test E — 13th parameter extra_fields_json with questions_forwarded
# --------------------------------------------------------------------------
printf '\n--- Test E: extra_fields_json with questions_forwarded ---\n'

HOOK_ENTRY_MS=$(date +%s%3N)
QUESTIONS_DATA="Question: What should I do?\nOptions:\n  1. Option A\n  2. Option B"

write_hook_event_record \
  "$JSONL_FILE" "$HOOK_ENTRY_MS" "pre-tool-use-hook.sh" "test-session" \
  "test-agent" "test-id-123" "ask_user_question" "awaiting_user_input" \
  "questions" "wake message with questions" "" "delivered" \
  "{\"questions_forwarded\":\"$QUESTIONS_DATA\"}"

assert_line_count "exactly 4 lines after Test E" 4 "$JSONL_FILE"

LAST_RECORD_FILE="${TEST_LOG_DIR}/last-record-e.json"
tail -1 "$JSONL_FILE" > "$LAST_RECORD_FILE"

assert_jq "record has questions_forwarded field" '.questions_forwarded != null' "$LAST_RECORD_FILE"
assert_jq "questions_forwarded contains question text" '.questions_forwarded | contains("What should I do")' "$LAST_RECORD_FILE"
assert_jq "trigger is ask_user_question" '.trigger == "ask_user_question"' "$LAST_RECORD_FILE"
assert_jq "base fields still present" '.hook_script == "pre-tool-use-hook.sh"' "$LAST_RECORD_FILE"
assert_jq "duration_ms still a number" '.duration_ms | type == "number"' "$LAST_RECORD_FILE"
```

**Test F — 12-parameter call still works (backward compatibility):**
```bash
# --------------------------------------------------------------------------
# Test F — 12-parameter call backward compatibility (no 13th param)
# --------------------------------------------------------------------------
printf '\n--- Test F: 12-parameter backward compatibility ---\n'

HOOK_ENTRY_MS=$(date +%s%3N)

write_hook_event_record \
  "$JSONL_FILE" "$HOOK_ENTRY_MS" "stop-hook.sh" "test-session" \
  "test-agent" "test-id-123" "response_complete" "working" \
  "transcript" "Hello" '{"ok":true}' "delivered"

assert_line_count "exactly 5 lines after Test F" 5 "$JSONL_FILE"

LAST_RECORD_FILE="${TEST_LOG_DIR}/last-record-f.json"
tail -1 "$JSONL_FILE" > "$LAST_RECORD_FILE"

assert_jq "no extra fields in record" '.questions_forwarded == null' "$LAST_RECORD_FILE"
assert_jq "base record is valid" '.hook_script == "stop-hook.sh"' "$LAST_RECORD_FILE"
assert_jq "outcome is delivered" '.outcome == "delivered"' "$LAST_RECORD_FILE"
```

Update Test D's total record count from 3 to 5, and the Summary line count check from 3 to 5.

**Run the test to confirm:** `bash tests/test-write-hook-event-record.sh` — all tests pass.
  </action>
  <verify>
Run: `bash -n lib/hook-utils.sh` (syntax check passes).
Run: `bash tests/test-write-hook-event-record.sh` — all tests pass including new Test E and Test F.
Run: `grep -c 'extra_fields_json' lib/hook-utils.sh` returns at least 4 (docblock + local assignment in both functions).
Run: `grep 'questions_forwarded' tests/test-write-hook-event-record.sh` confirms test coverage.
Verify 12-parameter calls still work by checking Test A/B/C/F pass (no extra fields in output).
Verify Test E has a top-level `questions_forwarded` field queryable by jq.
  </verify>
  <done>write_hook_event_record() accepts optional 13th parameter extra_fields_json merged into JSONL record. deliver_async_with_logging() accepts optional 11th parameter and passes through. Existing 12-parameter call sites backward-compatible. Test coverage confirms questions_forwarded field and backward compatibility.</done>
</task>

<task type="auto">
  <name>Task 1: Migrate pre-tool-use-hook.sh to JSONL with ASK-04 questions_forwarded field</name>
  <files>scripts/pre-tool-use-hook.sh</files>
  <action>
Apply the standard 5-change migration pattern with these pre-tool-use-specific values:

**Change 1: Move lib source to top.** After debug_log definition and "FIRED" log line, add SCRIPT_DIR and source block (same pattern as Plan 09-01). Note: pre-tool-use-hook.sh has a `debug_log "sourced lib/hook-utils.sh"` inside the old mid-script block — this should move up to the new top-level source block.

**Change 2: Add HOOK_ENTRY_MS.** After `STDIN_JSON=$(cat)`, add `HOOK_ENTRY_MS=$(date +%s%3N)`.

**Change 3: Add JSONL_FILE in Phase 2 redirect.** After `GSD_HOOK_LOG="${SKILL_LOG_DIR}/${SESSION_NAME}.log"`, add `JSONL_FILE="${SKILL_LOG_DIR}/${SESSION_NAME}.jsonl"`.

**Change 4: Delete mid-script LIB_PATH + source block.** Remove the block in section 4 (after REGISTRY_PATH check) that sets SCRIPT_DIR, LIB_PATH, and sources hook-utils.sh. Keep REGISTRY_PATH check and lookup_agent_in_registry call.

**Change 5: Replace bare openclaw delivery with deliver_async_with_logging() and pass extra_fields_json for ASK-04.**

Set trigger and content_source variables before the delivery section:
```bash
TRIGGER="ask_user_question"
CONTENT_SOURCE="questions"
STATE="awaiting_user_input"
```

Build the extra_fields_json containing the questions_forwarded field. The formatted questions text is already available in the wake message construction area (the TOOL_INPUT variable contains the raw JSON, and the formatted output from format_ask_user_questions is used in the wake message). Capture the formatted questions into a variable and build the extra_fields JSON:
```bash
FORMATTED_QUESTIONS=$(format_ask_user_questions "$TOOL_INPUT")
EXTRA_FIELDS_JSON=$(jq -cn --arg questions_forwarded "$FORMATTED_QUESTIONS" '{"questions_forwarded": $questions_forwarded}')
```

Replace the bare openclaw call in section 8:
```bash
# Old:
openclaw agent --session-id "$OPENCLAW_SESSION_ID" --message "$WAKE_MESSAGE" \
  >> "$GSD_HOOK_LOG" 2>&1 &
debug_log "DELIVERED (async AskUserQuestion forward, bg PID=$!)"
```
With:
```bash
deliver_async_with_logging \
  "$OPENCLAW_SESSION_ID" "$WAKE_MESSAGE" "$JSONL_FILE" "$HOOK_ENTRY_MS" \
  "$HOOK_SCRIPT_NAME" "$SESSION_NAME" "$AGENT_ID" \
  "$TRIGGER" "$STATE" "$CONTENT_SOURCE" \
  "$EXTRA_FIELDS_JSON"
debug_log "DELIVERED (async AskUserQuestion forward with JSONL logging)"
```

Note the 11th argument `"$EXTRA_FIELDS_JSON"` which passes through to write_hook_event_record()'s 13th parameter, resulting in a JSONL record with a top-level `questions_forwarded` field.

Keep ALL existing debug_log calls. Keep exit 0 at the end. Keep all CRITICAL comments about async behavior.
  </action>
  <verify>
Run: `bash -n scripts/pre-tool-use-hook.sh` (syntax check passes).
Run: `grep -c 'deliver_async_with_logging' scripts/pre-tool-use-hook.sh` returns 1.
Run: `grep -c 'HOOK_ENTRY_MS' scripts/pre-tool-use-hook.sh` returns 1.
Run: `grep -c 'JSONL_FILE' scripts/pre-tool-use-hook.sh` returns 2 (assignment + usage in deliver call).
Run: `grep 'TRIGGER=' scripts/pre-tool-use-hook.sh` contains "ask_user_question".
Run: `grep 'CONTENT_SOURCE=' scripts/pre-tool-use-hook.sh` contains "questions".
Run: `grep 'EXTRA_FIELDS_JSON' scripts/pre-tool-use-hook.sh` confirms extra_fields_json is built and passed.
Run: `grep 'questions_forwarded' scripts/pre-tool-use-hook.sh` confirms the field name appears in the jq construction.
Verify lib sourced before first guard exit.
Verify only one `source "$LIB_PATH"` in the file.
Verify no bare `openclaw agent` call remains.
  </verify>
  <done>pre-tool-use-hook.sh emits JSONL with trigger=ask_user_question, content_source=questions, and a top-level questions_forwarded field containing formatted question text (satisfying ASK-04 via jq '.questions_forwarded'). All debug_log calls preserved. Exit 0 behavior unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate pre-compact-hook.sh to JSONL with bidirectional support</name>
  <files>scripts/pre-compact-hook.sh</files>
  <action>
Apply the standard 5-change migration pattern with bidirectional branch handling:

**Change 1: Move lib source to top.** After debug_log definition and "FIRED" log line, add SCRIPT_DIR and source block.

**Change 2: Add HOOK_ENTRY_MS.** After `STDIN_JSON=$(cat)`, add `HOOK_ENTRY_MS=$(date +%s%3N)`.

**Change 3: Add JSONL_FILE in Phase 2 redirect.** After `GSD_HOOK_LOG="${SKILL_LOG_DIR}/${SESSION_NAME}.log"`, add `JSONL_FILE="${SKILL_LOG_DIR}/${SESSION_NAME}.jsonl"`.

**Change 4: Delete mid-script LIB_PATH + source block.** Remove the existing source block in section 4. Keep REGISTRY_PATH check and lookup.

**Change 5: Replace delivery with JSONL-aware versions.**

Set trigger and content_source before delivery:
```bash
TRIGGER="pre_compact"
CONTENT_SOURCE="pane"
```

**Bidirectional branch:** After the synchronous openclaw call and `debug_log "RESPONSE: ..."`, add write_hook_event_record() call:
```bash
write_hook_event_record \
  "$JSONL_FILE" "$HOOK_ENTRY_MS" "$HOOK_SCRIPT_NAME" "$SESSION_NAME" \
  "$AGENT_ID" "$OPENCLAW_SESSION_ID" "$TRIGGER" "$STATE" \
  "$CONTENT_SOURCE" "$WAKE_MESSAGE" "$RESPONSE" "sync_delivered"
```
Keep the existing `exit 0` after this.

**Async branch:** Replace bare openclaw call:
```bash
deliver_async_with_logging \
  "$OPENCLAW_SESSION_ID" "$WAKE_MESSAGE" "$JSONL_FILE" "$HOOK_ENTRY_MS" \
  "$HOOK_SCRIPT_NAME" "$SESSION_NAME" "$AGENT_ID" \
  "$TRIGGER" "$STATE" "$CONTENT_SOURCE"
debug_log "DELIVERED (async with JSONL logging)"
```

Note: pre-compact-hook.sh does NOT pass extra_fields_json — the 10-parameter call to deliver_async_with_logging() and 12-parameter call to write_hook_event_record() work as before (backward compatible).

Keep ALL existing debug_log calls. Do NOT modify the pane capture command (pre-compact uses `-t "$SESSION_NAME:0.0" -p -S` which differs from other hooks — leave it).
  </action>
  <verify>
Run: `bash -n scripts/pre-compact-hook.sh` (syntax check passes).
Run: `grep -c 'deliver_async_with_logging' scripts/pre-compact-hook.sh` returns 1.
Run: `grep -c 'write_hook_event_record' scripts/pre-compact-hook.sh` returns 1.
Run: `grep -c 'HOOK_ENTRY_MS' scripts/pre-compact-hook.sh` returns 1.
Run: `grep -c 'JSONL_FILE' scripts/pre-compact-hook.sh` returns 3 (assignment + async usage + sync usage).
Verify TRIGGER="pre_compact" is set.
Verify CONTENT_SOURCE="pane" is set.
Verify lib sourced before first guard exit.
Verify only one `source "$LIB_PATH"` in the file.
Verify bidirectional branch has write_hook_event_record call with outcome "sync_delivered".
Verify no bare `openclaw agent` call remains in async branch.
  </verify>
  <done>pre-compact-hook.sh emits JSONL via deliver_async_with_logging (async path) and write_hook_event_record (bidirectional path). Trigger=pre_compact, content_source=pane. Pane capture command untouched. All debug_log calls preserved.</done>
</task>

</tasks>

<verification>
For lib/hook-utils.sh:
1. `bash -n lib/hook-utils.sh` — syntax check passes
2. `bash tests/test-write-hook-event-record.sh` — all tests pass (A through F)
3. write_hook_event_record() has 13th optional parameter extra_fields_json
4. deliver_async_with_logging() has 11th optional parameter extra_fields_json
5. Existing 12-parameter call sites produce records WITHOUT extra fields (Test F confirms)
6. 13-parameter call site produces record WITH extra fields merged at top level (Test E confirms)

For both modified hook scripts:
7. `bash -n scripts/pre-tool-use-hook.sh && bash -n scripts/pre-compact-hook.sh` — syntax check passes
8. Each file has exactly ONE `source "$LIB_PATH"` call
9. Source call appears BEFORE first `exit 0` guard
10. HOOK_ENTRY_MS set immediately after STDIN_JSON=$(cat)
11. JSONL_FILE assigned in Phase 2 redirect block
12. deliver_async_with_logging appears in each file's async delivery path
13. pre-compact-hook.sh has write_hook_event_record in bidirectional branch with outcome "sync_delivered"
14. pre-tool-use-hook.sh has TRIGGER="ask_user_question", CONTENT_SOURCE="questions", and passes EXTRA_FIELDS_JSON with questions_forwarded
15. All debug_log calls preserved (count unchanged)
16. Guard exits do NOT call any JSONL functions
</verification>

<success_criteria>
write_hook_event_record() and deliver_async_with_logging() extended with backward-compatible extra_fields_json parameter. pre-tool-use-hook.sh emits JSONL with a dedicated questions_forwarded field queryable via jq '.questions_forwarded' (ASK-04 satisfied). pre-compact-hook.sh emits JSONL in both async and bidirectional paths. Tests pass. Source ordering correct, no double-sourcing, syntax-valid bash, all debug_log preserved.
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-script-migration/09-02-SUMMARY.md`
</output>
