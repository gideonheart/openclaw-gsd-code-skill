---
phase: 02-shared-library
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - lib/gateway.mjs
  - lib/index.mjs
autonomous: true
requirements: [ARCH-02, ARCH-05, ARCH-06]

must_haves:
  truths:
    - "wakeAgentViaGateway() invokes openclaw agent --session-id with content and prompt arguments"
    - "wakeAgentViaGateway() sends last_assistant_message as content, event prompt as prompt, and event metadata in the message"
    - "A single import from lib/index.mjs provides resolveAgentFromSession, wakeAgentViaGateway, extractJsonField, retryWithBackoff, and appendJsonlEntry"
    - "Running node -e \"import('./lib/index.mjs')\" succeeds without error"
  artifacts:
    - path: "lib/gateway.mjs"
      provides: "Wake agent via OpenClaw gateway CLI"
      exports: ["wakeAgentViaGateway"]
    - path: "lib/index.mjs"
      provides: "Unified entry point re-exporting all lib modules"
      exports: ["resolveAgentFromSession", "wakeAgentViaGateway", "extractJsonField", "retryWithBackoff", "appendJsonlEntry"]
  key_links:
    - from: "lib/gateway.mjs"
      to: "openclaw agent --session-id"
      via: "execFileSync with argument array"
      pattern: "execFileSync.*openclaw"
    - from: "lib/gateway.mjs"
      to: "lib/logger.mjs"
      via: "import appendJsonlEntry for delivery logging"
      pattern: "import.*logger"
    - from: "lib/index.mjs"
      to: "lib/agent-resolver.mjs"
      via: "re-export"
      pattern: "export.*agent-resolver"
    - from: "lib/index.mjs"
      to: "lib/gateway.mjs"
      via: "re-export"
      pattern: "export.*gateway"
    - from: "lib/index.mjs"
      to: "lib/json-extractor.mjs"
      via: "re-export"
      pattern: "export.*json-extractor"
---

<objective>
Build the gateway delivery module and the unified lib entry point. The gateway module wraps `openclaw agent --session-id` to wake agents with content, prompt, and event metadata. The index module re-exports all five lib modules from a single import path.

Purpose: Complete the shared lib so event handlers (Phase 3/4) can import everything they need from one entry point and wake agents via the OpenClaw gateway.
Output: lib/gateway.mjs and lib/index.mjs — the shared lib is fully usable.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-shared-library/02-CONTEXT.md
@.planning/phases/02-shared-library/02-01-SUMMARY.md
@bin/launch-session.mjs
@config/agent-registry.example.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gateway delivery module</name>
  <files>lib/gateway.mjs</files>
  <action>
**lib/gateway.mjs** — Wake agent via OpenClaw gateway CLI.

Create a single exported function `wakeAgentViaGateway(wakeParameters)` that:
1. Imports `execFileSync` from `node:child_process` and `readFileSync` from `node:fs` and `resolve`, `dirname` from `node:path` and `fileURLToPath` from `node:url`
2. Imports `appendJsonlEntry` from `./logger.mjs`
3. Accepts a `wakeParameters` object with these fields:
   - `openclawSessionId` (string, required) — the agent's OpenClaw session UUID
   - `messageContent` (string, required) — the `last_assistant_message` (trimmed whitespace only, no truncation)
   - `promptFilePath` (string, required) — absolute path to the `.md` prompt file for this event type
   - `eventMetadata` (object, required) — `{ eventType, sessionName, timestamp }` included for agent context
   - `sessionName` (string, optional) — for JSONL logging context

4. Guard clause: if `openclawSessionId` is falsy, throw an Error with message 'wakeAgentViaGateway: openclawSessionId is required'
5. Guard clause: if `messageContent` is not a string, throw an Error with message 'wakeAgentViaGateway: messageContent must be a string'
6. Guard clause: if `promptFilePath` is falsy, throw an Error with message 'wakeAgentViaGateway: promptFilePath is required'

7. Read the prompt file content: `readFileSync(promptFilePath, 'utf8').trim()`
8. Build the combined message to send to the agent. The message is a single string that combines all three pieces the agent needs:
   ```
   ## Event Metadata
   - Event: ${eventMetadata.eventType}
   - Session: ${eventMetadata.sessionName}
   - Timestamp: ${eventMetadata.timestamp}

   ## Last Assistant Message
   ${messageContent}

   ## Instructions
   ${promptContent}
   ```

9. Build the CLI argument array for `openclaw agent`:
   ```javascript
   const openclawArguments = [
     'agent',
     '--session-id', openclawSessionId,
     '--message', combinedMessage,
   ];
   ```

10. Call `execFileSync('openclaw', openclawArguments, { stdio: 'pipe', timeout: 120000 })` — 2 minute timeout matches the reasonable upper bound for a gateway turn. Use `execFileSync` with argument array (Phase 01.1 pattern — never string interpolation into shell).

11. Log the successful delivery via `appendJsonlEntry`:
    ```javascript
    appendJsonlEntry({
      level: 'info',
      source: 'wakeAgentViaGateway',
      message: 'Agent wake delivered',
      openclaw_session_id: openclawSessionId,
      event_type: eventMetadata.eventType,
    }, sessionName);
    ```

12. On execFileSync error: let the error propagate (the caller — typically retryWithBackoff — handles retries). Log the failure before re-throwing:
    ```javascript
    appendJsonlEntry({
      level: 'error',
      source: 'wakeAgentViaGateway',
      message: 'Gateway delivery failed',
      openclaw_session_id: openclawSessionId,
      event_type: eventMetadata.eventType,
      error: caughtError.message,
    }, sessionName);
    ```

Key design notes:
- This function is intentionally NOT wrapped with retryWithBackoff internally. Per context decision, retry is a separate utility — the caller wraps with `retryWithBackoff(() => wakeAgentViaGateway(params))` when retry is desired.
- The prompt file is read at call time (not cached) so that prompt updates take effect immediately without restarting.
- The combined message format puts event metadata first, then content, then instructions — the agent sees context before instructions.
- Uses `execFileSync` with argument arrays (Phase 01.1 mandatory pattern) — never template string shell interpolation.
  </action>
  <verify>
Run `node --check lib/gateway.mjs` — passes syntax check.
Run `node -e "import('./lib/gateway.mjs').then(m => { try { m.wakeAgentViaGateway({}) } catch(e) { console.log(e.message) } })"` — prints "wakeAgentViaGateway: openclawSessionId is required" (guard clause works).
  </verify>
  <done>
lib/gateway.mjs exports wakeAgentViaGateway that invokes openclaw agent --session-id via execFileSync with content, prompt file, and event metadata combined into a single message. Guard clauses validate all required parameters. Errors propagate for retry wrapper to handle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unified entry point and verify full lib</name>
  <files>lib/index.mjs</files>
  <action>
**lib/index.mjs** — Unified re-export entry point.

This file ONLY re-exports. No logic, no side effects, no imports beyond the lib modules.

Create lib/index.mjs with exactly these re-exports:

```javascript
export { appendJsonlEntry } from './logger.mjs';
export { extractJsonField } from './json-extractor.mjs';
export { retryWithBackoff } from './retry.mjs';
export { resolveAgentFromSession } from './agent-resolver.mjs';
export { wakeAgentViaGateway } from './gateway.mjs';
```

That is the entire file. No additional code, no default export, no side effects.

After creating the file, verify the full lib by running the Phase 2 success criteria checks:

1. `node -e "import('./lib/index.mjs').then(() => console.log('import OK'))"` — succeeds without error
2. `node -e "import('./lib/index.mjs').then(m => console.log(Object.keys(m).sort().join(', ')))"` — prints all five function names
3. `node -e "import('./lib/index.mjs').then(m => { const result = m.extractJsonField('{\"hook_event_name\":\"Stop\"}', 'hook_event_name'); console.log(result) })"` — prints "Stop"
4. `node -e "import('./lib/index.mjs').then(m => { const agent = m.resolveAgentFromSession('nonexistent'); console.log(agent) })"` — prints "null"

Also update `package.json` to add lib/index.mjs to the `exports` field so consumers can import from the package:

Add to package.json:
```json
"exports": {
  ".": "./lib/index.mjs",
  "./lib/*": "./lib/*"
}
```

This ensures both `import('gsd-code-skill')` and `import('gsd-code-skill/lib/logger.mjs')` work for in-repo consumers.
  </action>
  <verify>
Run `node --check lib/index.mjs` — passes syntax check.
Run `node -e "import('./lib/index.mjs').then(() => console.log('SUCCESS: lib/index.mjs imports cleanly'))"` — prints success message.
Run `node -e "import('./lib/index.mjs').then(m => { const names = Object.keys(m).sort(); console.log(names.length === 5 ? 'SUCCESS: 5 exports' : 'FAIL: ' + names.length + ' exports'); console.log(names.join(', ')) })"` — prints "SUCCESS: 5 exports" and all function names.
Run `node -e "import('./lib/index.mjs').then(m => console.log(m.extractJsonField('{\"a\":1}', 'a') === 1 ? 'PASS' : 'FAIL'))"` — prints "PASS".
Run `node --check lib/*.mjs` — all lib files pass syntax check.
  </verify>
  <done>
lib/index.mjs re-exports all five functions from a single entry point. Running `node -e "import('./lib/index.mjs')"` succeeds. Event handlers can import { resolveAgentFromSession, wakeAgentViaGateway, extractJsonField, retryWithBackoff, appendJsonlEntry } from one path. package.json exports field points to the entry point.
  </done>
</task>

</tasks>

<verification>
1. All six lib files pass `node --check lib/*.mjs` (logger, json-extractor, retry, agent-resolver, gateway, index)
2. `node -e "import('./lib/index.mjs')"` succeeds without error (Phase 2 success criterion 1)
3. All five functions are available from the single import (ARCH-05)
4. wakeAgentViaGateway throws on missing required parameters (guard clauses)
5. Full round-trip: extractJsonField parses JSON, resolveAgentFromSession looks up agents, gateway builds correct CLI args
6. package.json exports field configured for lib entry point
7. No external dependencies added — only node: built-in modules
8. Every function uses execFileSync with argument arrays, not template strings
</verification>

<success_criteria>
The complete shared lib at lib/ is usable from a single import path. wakeAgentViaGateway correctly invokes openclaw agent --session-id. lib/index.mjs re-exports all five functions. No code duplication exists across modules — each module has a single responsibility.
</success_criteria>

<output>
After completion, create `.planning/phases/02-shared-library/02-02-SUMMARY.md`
</output>
