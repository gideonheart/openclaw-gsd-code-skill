---
phase: 16-hook-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/pre-compact-hook.sh
  - scripts/pre-tool-use-hook.sh
  - scripts/post-tool-use-hook.sh
  - scripts/session-end-hook.sh
autonomous: true
requirements:
  - HOOK-21
  - HOOK-22
  - HOOK-23
  - HOOK-24

must_haves:
  truths:
    - "pre-compact-hook.sh wake message contains [ACTION REQUIRED] loaded from pre-compact template"
    - "pre-tool-use-hook.sh wake message contains [ACTION REQUIRED] loaded from ask-user-question template"
    - "post-tool-use-hook.sh wake message contains [ACTION REQUIRED] loaded from answer-submitted template (previously had no action section)"
    - "session-end-hook.sh wake message contains [ACTION REQUIRED] loaded from session-end template (previously had no action section)"
    - "None of the four hooks contain [AVAILABLE ACTIONS] anywhere in their source"
    - "If a template file is missing, the hook still fires and delivers the wake message"
  artifacts:
    - path: "scripts/pre-compact-hook.sh"
      provides: "Pre-compact wake with [ACTION REQUIRED] from template"
      contains: "load_hook_prompt"
    - path: "scripts/pre-tool-use-hook.sh"
      provides: "Ask-user-question wake with [ACTION REQUIRED] from template"
      contains: "load_hook_prompt"
    - path: "scripts/post-tool-use-hook.sh"
      provides: "Answer-submitted wake with [ACTION REQUIRED] from template"
      contains: "load_hook_prompt"
    - path: "scripts/session-end-hook.sh"
      provides: "Session-end wake with [ACTION REQUIRED] from template"
      contains: "load_hook_prompt"
  key_links:
    - from: "scripts/pre-compact-hook.sh"
      to: "scripts/prompts/pre-compact.md"
      via: "load_hook_prompt call"
      pattern: 'load_hook_prompt "pre-compact"'
    - from: "scripts/pre-tool-use-hook.sh"
      to: "scripts/prompts/ask-user-question.md"
      via: "load_hook_prompt call"
      pattern: 'load_hook_prompt "ask-user-question"'
    - from: "scripts/post-tool-use-hook.sh"
      to: "scripts/prompts/answer-submitted.md"
      via: "load_hook_prompt call"
      pattern: 'load_hook_prompt "answer-submitted"'
    - from: "scripts/session-end-hook.sh"
      to: "scripts/prompts/session-end.md"
      via: "load_hook_prompt call"
      pattern: 'load_hook_prompt "session-end"'
---

<objective>
Migrate pre-compact-hook.sh and pre-tool-use-hook.sh from hardcoded [AVAILABLE ACTIONS] to template-loaded [ACTION REQUIRED], and add new [ACTION REQUIRED] sections to post-tool-use-hook.sh and session-end-hook.sh (which currently have no action section at all).

Purpose: Completes the migration of all 7 hooks. The two hooks that previously had no action section (post-tool-use, session-end) now gain [ACTION REQUIRED] sections, giving the driving agent specific instructions for those trigger contexts.

Output: Four modified hook scripts, each calling load_hook_prompt() with their specific template name and emitting [ACTION REQUIRED].
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/pre-compact-hook.sh
@scripts/pre-tool-use-hook.sh
@scripts/post-tool-use-hook.sh
@scripts/session-end-hook.sh
@lib/hook-utils.sh
@scripts/prompts/pre-compact.md
@scripts/prompts/ask-user-question.md
@scripts/prompts/answer-submitted.md
@scripts/prompts/session-end.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate pre-compact-hook.sh and pre-tool-use-hook.sh (replace existing [AVAILABLE ACTIONS])</name>
  <files>scripts/pre-compact-hook.sh, scripts/pre-tool-use-hook.sh</files>
  <action>
**pre-compact-hook.sh:**
Before the WAKE_MESSAGE construction (before section 9, around line 80), add:
```bash
MENU_DRIVER_PATH="${_GSD_SKILL_ROOT}/scripts/menu-driver.sh"
SCRIPT_DIR="${_GSD_SKILL_ROOT}/scripts"
ACTION_PROMPT=$(load_hook_prompt "pre-compact" "$SESSION_NAME" "$MENU_DRIVER_PATH" "$SCRIPT_DIR")
```

Replace the [AVAILABLE ACTIONS] block (lines 100-107) in WAKE_MESSAGE with:
```
[ACTION REQUIRED]
${ACTION_PROMPT}
```

Do NOT change any other part of the wake message. Do NOT change the bidirectional/async delivery logic (sections 10 onward).

**pre-tool-use-hook.sh:**
Before the WAKE_MESSAGE construction (before section 7, around line 83), add:
```bash
MENU_DRIVER_PATH="${_GSD_SKILL_ROOT}/scripts/menu-driver.sh"
SCRIPT_DIR="${_GSD_SKILL_ROOT}/scripts"
ACTION_PROMPT=$(load_hook_prompt "ask-user-question" "$SESSION_NAME" "$MENU_DRIVER_PATH" "$SCRIPT_DIR")
```

Replace the [AVAILABLE ACTIONS] block (lines 100-107) in WAKE_MESSAGE with:
```
[ACTION REQUIRED]
${ACTION_PROMPT}
```

Do NOT change the async delivery logic (section 8). Do NOT change the CRITICAL exit 0 behavior. Do NOT add any stdout output.
  </action>
  <verify>
Run: grep -c "AVAILABLE ACTIONS" scripts/pre-compact-hook.sh (must return 0)
Run: grep -c "ACTION REQUIRED" scripts/pre-compact-hook.sh (must return 1)
Run: grep 'load_hook_prompt "pre-compact"' scripts/pre-compact-hook.sh (must match)
Run: grep -c "AVAILABLE ACTIONS" scripts/pre-tool-use-hook.sh (must return 0)
Run: grep -c "ACTION REQUIRED" scripts/pre-tool-use-hook.sh (must return 1)
Run: grep 'load_hook_prompt "ask-user-question"' scripts/pre-tool-use-hook.sh (must match)
Run: bash -n scripts/pre-compact-hook.sh && bash -n scripts/pre-tool-use-hook.sh (syntax check passes)
  </verify>
  <done>pre-compact-hook.sh loads "pre-compact" template and pre-tool-use-hook.sh loads "ask-user-question" template. Both emit [ACTION REQUIRED]. Zero [AVAILABLE ACTIONS] in either file. Both pass bash syntax check.</done>
</task>

<task type="auto">
  <name>Task 2: Add [ACTION REQUIRED] to post-tool-use-hook.sh and session-end-hook.sh (new action sections)</name>
  <files>scripts/post-tool-use-hook.sh, scripts/session-end-hook.sh</files>
  <action>
These two hooks currently have NO action section in their wake messages. Add [ACTION REQUIRED] to each.

**post-tool-use-hook.sh:**
Before the WAKE_MESSAGE construction (before section 6, around line 85), add:
```bash
MENU_DRIVER_PATH="${_GSD_SKILL_ROOT}/scripts/menu-driver.sh"
SCRIPT_DIR="${_GSD_SKILL_ROOT}/scripts"
ACTION_PROMPT=$(load_hook_prompt "answer-submitted" "$SESSION_NAME" "$MENU_DRIVER_PATH" "$SCRIPT_DIR")
```

Append to the end of WAKE_MESSAGE (after the "[STATE HINT]\nstate: answer_submitted" line, before the closing quote):
```

[ACTION REQUIRED]
${ACTION_PROMPT}
```

Note: The answer-submitted.md template is informational ("No action is needed"), but the [ACTION REQUIRED] header must still be present for consistency across all 7 hooks.

Do NOT change the async delivery logic (section 7). Do NOT change the CRITICAL exit 0 behavior.

**session-end-hook.sh:**
Before the WAKE_MESSAGE construction (before section 5, around line 55), add:
```bash
MENU_DRIVER_PATH="${_GSD_SKILL_ROOT}/scripts/menu-driver.sh"
SCRIPT_DIR="${_GSD_SKILL_ROOT}/scripts"
ACTION_PROMPT=$(load_hook_prompt "session-end" "$SESSION_NAME" "$MENU_DRIVER_PATH" "$SCRIPT_DIR")
```

Append to the end of WAKE_MESSAGE (after the "[STATE HINT]\nstate: terminated" line, before the closing quote):
```

[ACTION REQUIRED]
${ACTION_PROMPT}
```

Do NOT change the delivery logic or the pane state file cleanup (sections 6-7).
  </action>
  <verify>
Run: grep -c "ACTION REQUIRED" scripts/post-tool-use-hook.sh (must return 1)
Run: grep 'load_hook_prompt "answer-submitted"' scripts/post-tool-use-hook.sh (must match)
Run: grep -c "ACTION REQUIRED" scripts/session-end-hook.sh (must return 1)
Run: grep 'load_hook_prompt "session-end"' scripts/session-end-hook.sh (must match)
Run: bash -n scripts/post-tool-use-hook.sh && bash -n scripts/session-end-hook.sh (syntax check passes)
  </verify>
  <done>post-tool-use-hook.sh and session-end-hook.sh both have [ACTION REQUIRED] sections loaded from their respective templates ("answer-submitted" and "session-end"). Both scripts pass bash syntax check. These hooks now have action sections where previously they had none.</done>
</task>

</tasks>

<verification>
Cross-hook verification for Plan 02 (and full Phase 16):
1. grep -rc "AVAILABLE ACTIONS" scripts/pre-compact-hook.sh scripts/pre-tool-use-hook.sh scripts/post-tool-use-hook.sh scripts/session-end-hook.sh — all four must return 0
2. grep -c "ACTION REQUIRED" scripts/pre-compact-hook.sh scripts/pre-tool-use-hook.sh scripts/post-tool-use-hook.sh scripts/session-end-hook.sh — all four must return 1
3. grep "load_hook_prompt" scripts/pre-compact-hook.sh scripts/pre-tool-use-hook.sh scripts/post-tool-use-hook.sh scripts/session-end-hook.sh — all four must show correct template name

Full Phase 16 cross-check (after both plans complete):
4. grep -r "AVAILABLE ACTIONS" scripts/*-hook.sh — must return zero matches across ALL 7 hook scripts
5. grep -c "load_hook_prompt" scripts/*-hook.sh — must return exactly 1 per hook (7 total)
6. bash -n on all four scripts — no syntax errors
</verification>

<success_criteria>
- pre-compact-hook.sh loads "pre-compact" template and emits [ACTION REQUIRED]
- pre-tool-use-hook.sh loads "ask-user-question" template and emits [ACTION REQUIRED]
- post-tool-use-hook.sh loads "answer-submitted" template and gains new [ACTION REQUIRED] section
- session-end-hook.sh loads "session-end" template and gains new [ACTION REQUIRED] section
- Zero occurrences of [AVAILABLE ACTIONS] across all four scripts
- All four scripts pass bash -n syntax check
- Combined with Plan 01: all 7 hooks use load_hook_prompt(), zero generic action blocks remain
</success_criteria>

<output>
After completion, create `.planning/phases/16-hook-migration/16-02-SUMMARY.md`
</output>
