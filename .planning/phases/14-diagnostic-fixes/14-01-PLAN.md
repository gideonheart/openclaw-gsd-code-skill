---
phase: 14-diagnostic-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/diagnose-hooks.sh
autonomous: true
requirements:
  - FIX-01
  - FIX-02
must_haves:
  truths:
    - "diagnose-hooks.sh Step 7 uses startswith prefix-match identical to lookup_agent_in_registry() in hook-utils.sh"
    - "diagnose-hooks.sh Step 2 checks all 7 hook scripts including pre-tool-use-hook.sh and post-tool-use-hook.sh"
    - "A session named 'gideon-2' correctly resolves to agent 'gideon' in Step 7 instead of reporting a lookup failure"
    - "A missing pre-tool-use-hook.sh or post-tool-use-hook.sh is flagged as FAIL in Step 2"
  artifacts:
    - path: "scripts/diagnose-hooks.sh"
      provides: "Diagnostic script with prefix-match lookup and full 7-hook script list"
      contains: "startswith"
  key_links:
    - from: "scripts/diagnose-hooks.sh"
      to: "lib/hook-utils.sh"
      via: "identical jq prefix-match pattern"
      pattern: "startswith.*agent_id"
---

<objective>
Fix two diagnostic accuracy bugs in diagnose-hooks.sh so it correctly reflects actual hook behavior.

Purpose: diagnose-hooks.sh is the primary debugging tool for hook issues. When its checks don't match actual hook behavior, it reports false failures (Step 7 exact-match vs hook prefix-match) and misses real failures (Step 2 omits 2 of 7 scripts).

Output: Updated scripts/diagnose-hooks.sh with both fixes applied.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@scripts/diagnose-hooks.sh
@lib/hook-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Step 7 to use prefix-match lookup</name>
  <files>scripts/diagnose-hooks.sh</files>
  <action>
    Replace the Step 7 jq query (lines 263-264) that uses exact match on tmux_session_name:

    Current (WRONG -- exact match):
    ```
    '.agents[] | select(.tmux_session_name == $session) | {agent_id, openclaw_session_id}'
    ```

    Replace with prefix-match identical to lookup_agent_in_registry() in lib/hook-utils.sh:
    ```
    '.agents[] | . as $agent | select($session | startswith($agent.agent_id + "-")) | {agent_id, openclaw_session_id}'
    ```

    This matches the actual hook behavior where a session named "gideon-2" resolves to agent "gideon" via prefix match on agent_id.

    Update the Step 7 section comment to clarify it uses prefix-match (not exact tmux_session_name match).
  </action>
  <verify>
    Run `grep 'startswith' scripts/diagnose-hooks.sh` -- should match the Step 7 jq query.
    Run `grep 'tmux_session_name ==' scripts/diagnose-hooks.sh` -- should return 0 matches (exact match removed).
    Run `bash -n scripts/diagnose-hooks.sh` -- syntax valid.
  </verify>
  <done>
    Step 7 uses `$session | startswith($agent.agent_id + "-")` prefix-match -- identical pattern to lookup_agent_in_registry() in lib/hook-utils.sh.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Step 2 to check all 7 hook scripts</name>
  <files>scripts/diagnose-hooks.sh</files>
  <action>
    Update the HOOK_SCRIPTS array (lines 99-105) to include all 7 hook scripts.

    Current (INCOMPLETE -- 5 scripts):
    ```bash
    HOOK_SCRIPTS=(
      "stop-hook.sh"
      "notification-idle-hook.sh"
      "notification-permission-hook.sh"
      "session-end-hook.sh"
      "pre-compact-hook.sh"
    )
    ```

    Replace with all 7 scripts:
    ```bash
    HOOK_SCRIPTS=(
      "stop-hook.sh"
      "notification-idle-hook.sh"
      "notification-permission-hook.sh"
      "session-end-hook.sh"
      "pre-compact-hook.sh"
      "pre-tool-use-hook.sh"
      "post-tool-use-hook.sh"
    )
    ```

    The array order matches the hook registration order in register-hooks.sh: lifecycle hooks first, then tool-use hooks.
  </action>
  <verify>
    Run `grep -c 'hook.sh' scripts/diagnose-hooks.sh` in the HOOK_SCRIPTS array context -- should show 7 entries.
    Run `grep 'pre-tool-use-hook.sh\|post-tool-use-hook.sh' scripts/diagnose-hooks.sh` -- both present.
    Run `bash -n scripts/diagnose-hooks.sh` -- syntax valid.
  </verify>
  <done>
    HOOK_SCRIPTS array contains all 7 hook scripts. Missing pre-tool-use-hook.sh or post-tool-use-hook.sh will be flagged as FAIL.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/diagnose-hooks.sh` passes (syntax valid)
2. `grep 'startswith' scripts/diagnose-hooks.sh` matches Step 7 jq query
3. `grep -c 'hook.sh"' scripts/diagnose-hooks.sh` in HOOK_SCRIPTS array returns 7
4. `grep 'tmux_session_name ==' scripts/diagnose-hooks.sh` returns 0 matches
5. Step 7 jq pattern matches lookup_agent_in_registry() in lib/hook-utils.sh
</verification>

<success_criteria>
- diagnose-hooks.sh Step 7 uses prefix-match with startswith (matching lib/hook-utils.sh behavior)
- diagnose-hooks.sh Step 2 HOOK_SCRIPTS array lists all 7 hook scripts
- Both changes pass bash -n syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/14-diagnostic-fixes/14-01-SUMMARY.md`
</output>
