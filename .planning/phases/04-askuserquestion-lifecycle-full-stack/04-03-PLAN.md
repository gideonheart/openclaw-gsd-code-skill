---
phase: 04-askuserquestion-lifecycle-full-stack
plan: 03
type: execute
wave: 3
depends_on:
  - "04-01"
  - "04-02"
files_modified:
  - events/post_tool_use/event_post_tool_use.mjs
  - events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs
  - events/post_tool_use/ask_user_question/prompt_post_ask_mismatch.md
autonomous: true
requirements:
  - ASK-03
  - ASK-04

must_haves:
  truths:
    - "PostToolUse router reads tool_name from hook payload and dispatches AskUserQuestion to the verification handler"
    - "PostToolUse handler reads pending-answer file, compares with tool_response.answers, and deletes both metadata files on completion"
    - "Match case (95%): handler logs verified, deletes question + pending-answer files, exits 0 — zero tokens burned, agent never woken"
    - "Mismatch case (5%): handler wakes OpenClaw agent with specific mismatch details (intended vs actual, question text, tool_use_id), then deletes both files and exits 0"
    - "Missing/stale pending-answer file: handler logs warning and exits 0 — self-healing, no crash, no block"
    - "Mismatch prompt instructs agent to correct on NEXT AskUserQuestion via Chat about this or Type something"
  artifacts:
    - path: "events/post_tool_use/event_post_tool_use.mjs"
      provides: "PostToolUse router — readHookContext, dispatch by tool_name"
      min_lines: 25
    - path: "events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs"
      provides: "AskUserQuestion PostToolUse verification handler"
      exports:
        - handlePostAskUserQuestion
    - path: "events/post_tool_use/ask_user_question/prompt_post_ask_mismatch.md"
      provides: "Agent prompt for AskUserQuestion mismatch correction"
  key_links:
    - from: "events/post_tool_use/event_post_tool_use.mjs"
      to: "events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs"
      via: "import and dispatch by tool_name match"
      pattern: "handlePostAskUserQuestion"
    - from: "events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs"
      to: "lib/ask-user-question.mjs"
      via: "readPendingAnswer + compareAnswerWithIntent + deletePendingAnswer + deleteQuestionMetadata"
      pattern: "import.*(readPendingAnswer|compareAnswerWithIntent|deletePendingAnswer|deleteQuestionMetadata)"
    - from: "events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs"
      to: "lib/gateway.mjs"
      via: "wakeAgentWithRetry for mismatch notification only"
      pattern: "wakeAgentWithRetry"
---

<objective>
Build the PostToolUse verification handler — the closed-loop feedback that confirms the TUI driver's answer was recorded correctly by Claude Code.

Purpose: This plan closes the PreToolUse -> PostToolUse verification loop. After the TUI driver submits an answer, Claude Code processes it and fires PostToolUse. The handler reads the pending-answer file (what we intended), compares with tool_response.answers (what Claude Code recorded), and either silently confirms (95% match = zero tokens) or wakes the agent with mismatch details (5% case). This makes the autonomous answering loop self-correcting.

Output: 3 new files in events/post_tool_use/ completing the AskUserQuestion lifecycle.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-askuserquestion-lifecycle-full-stack/04-CONTEXT.md
@.planning/phases/04-askuserquestion-lifecycle-full-stack/04-RESEARCH.md
@.planning/phases/04-askuserquestion-lifecycle-full-stack/04-01-SUMMARY.md
@.planning/phases/04-askuserquestion-lifecycle-full-stack/04-02-SUMMARY.md
@events/stop/event_stop.mjs
@events/pre_tool_use/event_pre_tool_use.mjs
@lib/hook-context.mjs
@lib/gateway.mjs
@lib/ask-user-question.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostToolUse router and AskUserQuestion verification handler</name>
  <files>
    events/post_tool_use/event_post_tool_use.mjs
    events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs
  </files>
  <action>
**File 1: events/post_tool_use/event_post_tool_use.mjs**

Router handler — mirrors PreToolUse router exactly (same structure, same guard pattern). This is the file registered in settings.json for PostToolUse events.

```javascript
// Structure (not verbatim):
import { readHookContext, appendJsonlEntry } from '../../lib/index.mjs';
import { handlePostAskUserQuestion } from './ask_user_question/handle_post_ask_user_question.mjs';

async function main() {
  const hookContext = readHookContext('event_post_tool_use');
  if (!hookContext) process.exit(0);
  const { hookPayload, sessionName, resolvedAgent } = hookContext;

  const toolName = hookPayload.tool_name;

  if (toolName === 'AskUserQuestion') {
    await handlePostAskUserQuestion({ hookPayload, sessionName, resolvedAgent });
    process.exit(0);
  }

  // No handler for this tool
  appendJsonlEntry({
    level: 'debug',
    source: 'event_post_tool_use',
    message: `No handler for tool_name: ${toolName}`,
    session: sessionName,
  }, sessionName);
  process.exit(0);
}

main().catch((error) => {
  process.stderr.write(`[event_post_tool_use] Error: ${error.message}\n`);
  process.exit(1);
});
```

**File 2: events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs**

Verification handler — reads pending answer file, compares with tool_response, handles all 3 outcomes. Handlers are thin plumbing — domain logic is in lib/ask-user-question.mjs.

Export a single async function `handlePostAskUserQuestion({ hookPayload, sessionName, resolvedAgent })`.

**Steps:**

1. Read pending answer: `readPendingAnswer(sessionName)`. If null:
   - Log warning: "No pending-answer file for session {sessionName} — TUI driver may not have been called or file was already cleaned up"
   - Delete question metadata just in case: `deleteQuestionMetadata(sessionName)` (cleanup, ignore if missing)
   - Return (exit 0 via caller) — self-healing behavior per CONTEXT.md

2. Extract tool response: `toolResponse = hookPayload.tool_response`. `toolInput = hookPayload.tool_input`. If `toolResponse` is falsy or `toolResponse.answers` is falsy:
   - Log warning: "PostToolUse payload missing tool_response.answers"
   - Delete both files (cleanup)
   - Return

3. Compare: `comparisonResult = compareAnswerWithIntent(pendingAnswer, toolResponse, toolInput)`

4. **Match path** (`comparisonResult.matched === true`):
   - Log info: "AskUserQuestion verified — answer matches intent" with session, tool_use_id
   - Delete pending-answer file: `deletePendingAnswer(sessionName)`
   - Delete question metadata: `deleteQuestionMetadata(sessionName)`
   - Return

5. **Mismatch path** (`comparisonResult.matched === false`):
   - Build mismatch message content using data from pendingAnswer, toolResponse, comparisonResult, and toolInput. Format:
     ```
     ## AskUserQuestion Verification — MISMATCH

     **Session:** {sessionName}
     **tool_use_id:** {pendingAnswer.tool_use_id}

     **You intended:** {describe intended answer from pendingAnswer}
     **Claude Code received:** {describe actual answer from toolResponse.answers}
     **Reason:** {comparisonResult.reason}

     ### Original Question
     {format the question text and options from toolInput for context}
     ```
   - Build promptFilePath = `resolve(SKILL_ROOT, 'events', 'post_tool_use', 'ask_user_question', 'prompt_post_ask_mismatch.md')`
   - Wake agent: `await wakeAgentWithRetry({ resolvedAgent, messageContent: mismatchMessage, promptFilePath, eventType: 'PostToolUse', sessionName })`
   - Log warn: "AskUserQuestion mismatch detected" with reason, session, tool_use_id
   - Delete both files (cleanup happens regardless of match/mismatch)
   - Return

**Imports:** `resolve` from `node:path`, `SKILL_ROOT` from `../../../lib/paths.mjs`, `readPendingAnswer`, `deletePendingAnswer`, `deleteQuestionMetadata`, `compareAnswerWithIntent`, `wakeAgentWithRetry`, `appendJsonlEntry` from `../../../lib/index.mjs`.

**Style:** Guard clauses with early returns. Self-explanatory names. JSDoc on the exported function. Log entries with consistent `source: 'handle_post_ask_user_question'`.
  </action>
  <verify>
Verify file structure: `ls events/post_tool_use/event_post_tool_use.mjs events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs` — both files must exist.

Run `node -e "import('./events/post_tool_use/event_post_tool_use.mjs')"` — must not throw import errors (will exit due to no stdin, but import chain must resolve).

Run `node -e "import('./events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs').then(m => { if (!m.handlePostAskUserQuestion) process.exit(1); console.log('OK'); })"` — must export handlePostAskUserQuestion function.
  </verify>
  <done>PostToolUse router dispatches by tool_name. Verification handler implements all 3 outcomes: match (silent, zero tokens), mismatch (wake agent with details), missing file (warn and self-heal). Both metadata files deleted on all paths.</done>
</task>

<task type="auto">
  <name>Task 2: Create PostToolUse mismatch prompt</name>
  <files>events/post_tool_use/ask_user_question/prompt_post_ask_mismatch.md</files>
  <action>
Create the mismatch correction prompt — this is the Instructions section appended to the mismatch notification message. Only fires in the 5% mismatch case. Per CONTEXT.md: "Immediate OpenClaw agent notification on mismatch — agent corrects on NEXT AskUserQuestion via Chat about this or Type something."

Content:

```markdown
# AskUserQuestion Verification — MISMATCH

Your answer was not submitted correctly. The details above show what you intended versus what Claude Code actually recorded.

## What happened
The TUI driver typed keys into the tmux session, but Claude Code recorded a different answer than what you intended. This can happen when:
1. **TUI cursor position was wrong** — the navigation key count was off (most common for new question layouts)
2. **Option labels shifted** — Claude Code rendered options differently than expected
3. **Timing issue** — keystroke reached tmux before the TUI was ready

## What to do
On the **next** AskUserQuestion that fires (which may be coming soon — Claude Code continues after receiving an answer):
1. If the mismatch was minor (close to correct), proceed normally with the new question
2. If the mismatch was significant (wrong answer entirely), use **"Chat about this"** on the next question to tell Claude Code: "My previous answer was wrong. I meant to select [X]. Please adjust your approach accordingly."
3. If you need to type a correction, use **"Type something"** to provide the correct direction

## Do NOT
- Do not try to re-answer the already-answered question — it is done
- Do not panic — Claude Code will ask more questions if it needs clarification
- The mismatch is logged for debugging. If it keeps happening, the TUI driver navigation counts need adjustment.
```

This prompt is concise, actionable, and follows the CONTEXT.md mismatch correction example format. The mismatch details (question, intended, actual, reason) are in the messageContent above this prompt in the combined gateway message.
  </action>
  <verify>
`ls events/post_tool_use/ask_user_question/prompt_post_ask_mismatch.md` — file must exist.

`wc -l events/post_tool_use/ask_user_question/prompt_post_ask_mismatch.md` — should be 15-25 lines (concise but complete).

Verify content starts with "# AskUserQuestion Verification": `head -1 events/post_tool_use/ask_user_question/prompt_post_ask_mismatch.md`
  </verify>
  <done>Mismatch prompt exists and instructs agent to correct on next AskUserQuestion via Chat or Type. Prompt is concise, explains what happened, and tells agent what to do and what not to do.</done>
</task>

</tasks>

<verification>
1. `ls events/post_tool_use/event_post_tool_use.mjs events/post_tool_use/ask_user_question/handle_post_ask_user_question.mjs events/post_tool_use/ask_user_question/prompt_post_ask_mismatch.md` — all 3 files exist
2. PostToolUse router mirrors PreToolUse router structure exactly
3. Verification handler implements all 3 outcomes from CONTEXT.md: match (silent), mismatch (wake), missing (warn)
4. Both question-{session}.json and pending-answer-{session}.json deleted on ALL paths (match, mismatch, missing)
5. Mismatch wake includes specific details: intended answer, actual answer, reason, original question context
6. Mismatch prompt instructs correction on next AskUserQuestion, not re-answering current one
7. No new npm dependencies
</verification>

<success_criteria>
- PostToolUse router dispatches AskUserQuestion to verification handler
- Match case: silent verification + cleanup, zero agent tokens burned
- Mismatch case: agent woken with specific details + cleanup
- Missing file case: warning logged + graceful exit
- Mismatch prompt provides actionable correction instructions
- Full PreToolUse -> PostToolUse verification loop is closed
</success_criteria>

<output>
After completion, create `.planning/phases/04-askuserquestion-lifecycle-full-stack/04-03-SUMMARY.md`
</output>
