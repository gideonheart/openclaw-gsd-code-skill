---
phase: 01.1-refactor-phase-1-code-based-on-code-review-findings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/launch-session.mjs
  - config/agent-registry.example.json
  - config/SCHEMA.md
  - SKILL.md
  - README.md
autonomous: true
requirements: [REV-3.3, REV-3.4, REV-3.5, REV-3.6, REV-3.7, REV-3.8, REV-3.11]

must_haves:
  truths:
    - "launch-session.mjs uses execFileSync with argument arrays for all tmux commands, eliminating shell injection"
    - "launch-session.mjs uses node:util parseArgs instead of a custom argument parser"
    - "launch-session.mjs main() is async and uses a Promise-based timer instead of execSync sleep"
    - "launch-session.mjs reads skip_permissions from agent registry to conditionally include --dangerously-skip-permissions"
    - "launch-session.mjs safely escapes system prompt text using single-quote escaping before passing to tmux send-keys"
    - "agent-registry.example.json contains no _comment keys and field documentation lives in config/SCHEMA.md"
    - "SKILL.md lists bin/launch-session.mjs in its Scripts section"
    - "README.md separates current structure from planned structure"
  artifacts:
    - path: "bin/launch-session.mjs"
      provides: "Refactored session launcher with execFileSync, parseArgs, async main, and per-agent permissions"
      contains: "execFileSync"
    - path: "config/agent-registry.example.json"
      provides: "Clean example registry with skip_permissions field and no _comment keys"
      contains: "skip_permissions"
    - path: "config/SCHEMA.md"
      provides: "Agent registry schema documentation"
      contains: "agent_id"
    - path: "SKILL.md"
      provides: "Updated skill description listing all scripts"
      contains: "launch-session.mjs"
    - path: "README.md"
      provides: "Accurate directory structure with current vs planned separation"
      contains: "Current Structure"
  key_links:
    - from: "bin/launch-session.mjs"
      to: "config/agent-registry.json"
      via: "readAgentRegistry reads skip_permissions field"
      pattern: "skip_permissions"
    - from: "bin/launch-session.mjs"
      to: "tmux"
      via: "execFileSync with argument arrays"
      pattern: "execFileSync"
    - from: "config/SCHEMA.md"
      to: "config/agent-registry.example.json"
      via: "documents the same fields"
      pattern: "agent_id"
---

<objective>
Refactor launch-session.mjs to eliminate shell injection, use stdlib parseArgs, async sleep, and per-agent permission control. Clean up agent-registry.example.json and fix documentation accuracy.

Purpose: Address code review findings REV-3.3 through REV-3.8 and REV-3.11 — the security and best-practices issues in the session launcher and supporting files.
Output: Hardened bin/launch-session.mjs, clean config/agent-registry.example.json, new config/SCHEMA.md, accurate SKILL.md and README.md.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/quick/1-analyse-phase-1-implementation-code-revi/REVIEW.md
@bin/launch-session.mjs
@config/agent-registry.example.json
@SKILL.md
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor launch-session.mjs for security and best practices</name>
  <files>bin/launch-session.mjs</files>
  <action>
Five changes to bin/launch-session.mjs. All changes are in-place to the existing 191-line file. Preserve the existing function decomposition and naming conventions.

**Change 1 — Switch execSync to execFileSync (REV-3.3):**

Replace the `execSync` import with `execFileSync`:
```javascript
import { execFileSync } from 'node:child_process';
```

Rewrite all three tmux wrapper functions to use argument arrays:

```javascript
function checkTmuxSessionExists(sessionName) {
  try {
    execFileSync('tmux', ['has-session', '-t', sessionName], { stdio: 'pipe' });
    return true;
  } catch {
    return false;
  }
}

function createTmuxSession(sessionName, workingDirectory) {
  execFileSync('tmux', ['new-session', '-d', '-s', sessionName, '-c', workingDirectory], {
    stdio: 'inherit',
  });
}

function sendTmuxKeys(sessionName, keysToSend) {
  execFileSync('tmux', ['send-keys', '-t', sessionName, keysToSend, 'Enter'], {
    stdio: 'inherit',
  });
}
```

This eliminates shell injection entirely. `execFileSync` bypasses the shell and passes arguments as an array directly to the binary.

**Change 2 — Use node:util parseArgs (REV-3.6):**

Add the import:
```javascript
import { parseArgs } from 'node:util';
```

Replace the custom `parseCommandLineArguments` function (lines 29-51) with:

```javascript
function parseCommandLineArguments(rawArguments) {
  const { values, positionals } = parseArgs({
    args: rawArguments,
    options: {
      workdir: { type: 'string' },
      'first-command': { type: 'string' },
      help: { type: 'boolean' },
    },
    allowPositionals: true,
    strict: false,
  });
  return { positionalArguments: positionals, namedArguments: values };
}
```

Update the help check in `main()` to use the named argument:
```javascript
const { positionalArguments, namedArguments } = parseCommandLineArguments(commandLineArguments);

if (positionalArguments.length === 0 || namedArguments.help) {
```

Update the named argument references in main() from bracket notation to match parseArgs output:
- `namedArguments['workdir']` stays the same (parseArgs uses the option name as key)
- `namedArguments['first-command']` becomes `namedArguments['first-command']` (parseArgs preserves hyphenated names)

**Change 3 — Make main() async with Promise-based sleep (REV-3.5):**

Replace the synchronous `sleepSeconds` function with an async version:

```javascript
function sleepMilliseconds(durationInMilliseconds) {
  return new Promise((resolve) => setTimeout(resolve, durationInMilliseconds));
}
```

Rename the constant for precision:
```javascript
const TMUX_SESSION_STARTUP_DELAY_MILLISECONDS = 3000;
```

Make `main()` async:
```javascript
async function main() {
  // ... existing logic ...
  if (optionalFirstCommand !== null) {
    logWithTimestamp(`Waiting ${TMUX_SESSION_STARTUP_DELAY_MILLISECONDS}ms then sending first command...`);
    await sleepMilliseconds(TMUX_SESSION_STARTUP_DELAY_MILLISECONDS);
    sendTmuxKeys(sessionName, optionalFirstCommand);
  }
  // ...
}

main().catch((error) => {
  process.stderr.write(`Error: ${error.message}\n`);
  process.exit(1);
});
```

**Change 4 — Safe system prompt escaping (REV-3.4):**

Add a function that single-quote-escapes the system prompt text to prevent shell metacharacter issues when sent via tmux send-keys:

```javascript
function buildClaudeStartCommand(systemPromptText, shouldSkipPermissions) {
  // Single-quote escape: replace each ' with '\'' (end quote, escaped quote, restart quote)
  const shellEscapedPrompt = systemPromptText.replace(/'/g, "'\\''");
  const permissionsFlag = shouldSkipPermissions ? ' --dangerously-skip-permissions' : '';
  return `claude${permissionsFlag} --system-prompt '${shellEscapedPrompt}'`;
}
```

Replace the raw string interpolation on line 180:
```javascript
// OLD: sendTmuxKeys(sessionName, `claude --dangerously-skip-permissions --system-prompt "${systemPromptText}"`);
// NEW:
const claudeStartCommand = buildClaudeStartCommand(systemPromptText, agentConfiguration.skip_permissions !== false);
sendTmuxKeys(sessionName, claudeStartCommand);
```

Note on default behavior: `skip_permissions !== false` means the flag is included by default (matching current behavior) unless explicitly set to `false` in the registry. This preserves backward compatibility with existing agent-registry.json files that do not have the field.

**Change 5 — Per-agent skip_permissions from registry (REV-3.7):**

The `buildClaudeStartCommand` function from Change 4 already accepts `shouldSkipPermissions`. The agent configuration reads `skip_permissions` from the registry entry. No additional function changes needed — just ensure the registry field is read:

```javascript
const shouldSkipPermissions = agentConfiguration.skip_permissions !== false;
const claudeStartCommand = buildClaudeStartCommand(systemPromptText, shouldSkipPermissions);
```

The registry schema update (adding `skip_permissions` to the example) is handled in Task 2.

**IMPORTANT — Preserve these unchanged:**
- `readAgentRegistry()` function — no changes needed
- `findAgentByIdentifier()` function — no changes needed
- `readSystemPromptFile()` function — no changes needed
- `logWithTimestamp()` function — no changes needed
- `SKILL_ROOT` and `AGENT_REGISTRY_PATH` constants — no changes needed
- The JSDoc header comment — no changes needed
- The help text output — update if needed for `--help` flag behavior
  </action>
  <verify>
Run `node --check bin/launch-session.mjs` to confirm valid JavaScript syntax.
Run `grep 'execSync' bin/launch-session.mjs` — should return NO matches (all replaced by execFileSync).
Run `grep 'execFileSync' bin/launch-session.mjs` — should return matches.
Run `grep 'parseArgs' bin/launch-session.mjs` — should return matches (import + usage).
Run `grep 'async function main' bin/launch-session.mjs` — should return a match.
Run `grep 'sleepMilliseconds' bin/launch-session.mjs` — should return matches.
Run `grep 'skip_permissions' bin/launch-session.mjs` — should return matches.
Run `grep 'buildClaudeStartCommand' bin/launch-session.mjs` — should return matches.
Run `grep "dangerously-skip-permissions" bin/launch-session.mjs` — should appear inside buildClaudeStartCommand, NOT hardcoded in main().
  </verify>
  <done>
launch-session.mjs uses execFileSync for all child process calls, parseArgs from node:util for argument parsing, async main with Promise-based sleep, single-quote escaping for system prompts, and per-agent skip_permissions from the registry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean agent-registry example, create schema docs, and fix SKILL.md and README.md accuracy</name>
  <files>config/agent-registry.example.json, config/SCHEMA.md, SKILL.md, README.md</files>
  <action>
Four file changes:

**File 1 — config/agent-registry.example.json (REV-3.8 + REV-3.7):**

Remove ALL `_comment` and `_comment_*` keys. Add the `skip_permissions` field to both agent entries. Keep both agents (gideon and warden) with realistic example values:

```json
{
  "agents": [
    {
      "agent_id": "gideon",
      "enabled": true,
      "session_name": "gideon-main",
      "working_directory": "/home/forge/.openclaw/workspace",
      "openclaw_session_id": "00000000-0000-0000-0000-000000000001",
      "system_prompt_file": "config/default-system-prompt.md",
      "skip_permissions": true
    },
    {
      "agent_id": "warden",
      "enabled": true,
      "session_name": "warden-main",
      "working_directory": "/home/forge/my-project",
      "openclaw_session_id": "00000000-0000-0000-0000-000000000002",
      "system_prompt_file": "config/default-system-prompt.md",
      "skip_permissions": true
    }
  ]
}
```

**File 2 — config/SCHEMA.md (new file, REV-3.8):**

Create a schema documentation file that replaces the _comment keys:

```markdown
# Agent Registry Schema

`config/agent-registry.json` maps agent identifiers to their session configuration, working directories, and launch settings. This file is gitignored because it contains secrets (openclaw_session_id values). Copy `agent-registry.example.json` and fill in real values.

## Top-Level Structure

```json
{
  "agents": [ ... ]
}
```

The only top-level key is `agents`, an array of agent configuration objects.

## Agent Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `agent_id` | string | yes | Unique identifier for this agent. Must match the agent name used in tmux session naming and OpenClaw routing. Examples: `gideon`, `warden`, `forge`. |
| `enabled` | boolean | yes | Set to `false` to disable all hook event handling for this agent without removing the entry. Attempting to launch a disabled agent will throw an error. |
| `session_name` | string | yes | The tmux session name where Claude Code runs for this agent. Used by `launch-session.mjs` to create the session and by event handlers to route events. |
| `working_directory` | string | yes | Absolute path to the agent's workspace. Claude Code will be launched in this directory. Can be overridden at launch time with `--workdir`. |
| `openclaw_session_id` | string | yes | OpenClaw session UUID used for gateway message delivery. Obtain from the OpenClaw dashboard or API. This is a secret value. |
| `system_prompt_file` | string | yes | Path to the system prompt markdown file, relative to the gsd-code-skill root directory. Used when launching Claude Code via `bin/launch-session.mjs`. |
| `skip_permissions` | boolean | no | When `true` (default if omitted), launches Claude Code with `--dangerously-skip-permissions` flag granting unrestricted filesystem and command access. Set to `false` to launch in standard permission mode. |
```

**File 3 — SKILL.md (REV-3.11):**

Add `bin/launch-session.mjs` to the Scripts section. The updated Scripts section should be:

```markdown
## Scripts

- `bin/hook-event-logger.sh` — Universal debug logger for all Claude Code hook events. Reads stdin JSON payload and writes structured entries to per-session log files. Self-contained bootstrapping with no external library dependencies.
- `bin/launch-session.mjs` — Launch a Claude Code session in a named tmux session for a registered agent. Reads agent configuration from config/agent-registry.json, creates the tmux session, starts Claude Code with the agent's system prompt, and optionally sends an initial command after startup.
```

**File 4 — README.md (REV-3.11):**

Separate the directory structure into "Current Structure" and "Planned Structure" with clear headings. The current structure should reflect what actually exists on disk:

```markdown
# gsd-code-skill

v4.0 event-driven hook system for Claude Code agent lifecycle management. Each hook event is handled by a dedicated Node.js handler with its own prompt template.

## Status

v4.0 is under construction. The v1-v3 bash hook system has been removed. New event handlers are being built incrementally, one event at a time, full-stack (handler + prompt + integration test) before moving to the next.

## Current Structure

```
bin/              Executable scripts
  hook-event-logger.sh    Universal debug logger for all hook events
  launch-session.mjs      Tmux session launcher for registered agents
config/           Configuration files
  agent-registry.json     Agent registry (gitignored — contains secrets)
  agent-registry.example.json  Example registry (committed — documentation)
  default-system-prompt.md     Default system prompt for launched agents
  SCHEMA.md               Agent registry field documentation
logs/             Per-session log files (gitignored)
```

## Planned Structure (Phase 2+)

The following directories will be created in subsequent phases:

```
lib/              Shared Node.js library (agent registry, delivery, logging)
events/           One folder per Claude Code hook event
  stop/             event_stop.js, prompt_stop.md, tui_driver_stop.js
  pre_tool_use/     Subfolder per tool type
    ask_user_question/  event, prompt, tui driver
  post_tool_use/    Subfolder per tool type
    ask_user_question/  event, prompt
```
```

Do NOT change: the top-level heading, the Status section content (it accurately describes the current state), or any content beyond what is specified above.
  </action>
  <verify>
Run `node -e "const r = JSON.parse(require('fs').readFileSync('config/agent-registry.example.json','utf8')); console.log(r.agents.length, r.agents[0].skip_permissions, Object.keys(r.agents[0]).filter(k => k.startsWith('_')).length)"` — should output `2 true 0` (2 agents, skip_permissions is true, zero _comment keys).
Run `test -f config/SCHEMA.md && echo exists` — should output `exists`.
Run `grep 'launch-session.mjs' SKILL.md` — should return a match.
Run `grep 'Current Structure' README.md` — should return a match.
Run `grep 'Planned Structure' README.md` — should return a match.
  </verify>
  <done>
agent-registry.example.json has zero _comment keys and includes skip_permissions field. config/SCHEMA.md documents all registry fields. SKILL.md lists both scripts. README.md separates current and planned directory structures.
  </done>
</task>

</tasks>

<verification>
1. `node --check bin/launch-session.mjs` exits 0 (valid JS syntax)
2. `grep -c 'execSync' bin/launch-session.mjs` returns 0 (no execSync usage)
3. `grep 'parseArgs' bin/launch-session.mjs` returns matches
4. `grep 'async function main' bin/launch-session.mjs` returns match
5. `node -e "JSON.parse(require('fs').readFileSync('config/agent-registry.example.json','utf8'))"` exits 0
6. `grep '_comment' config/agent-registry.example.json` returns nothing
7. `test -f config/SCHEMA.md` exits 0
8. `grep 'launch-session.mjs' SKILL.md` returns match
9. `grep 'Current Structure' README.md` returns match
</verification>

<success_criteria>
- launch-session.mjs has zero execSync calls (all replaced by execFileSync)
- launch-session.mjs uses parseArgs from node:util
- launch-session.mjs main() is async with Promise-based sleep
- launch-session.mjs conditionally includes --dangerously-skip-permissions based on skip_permissions registry field
- launch-session.mjs escapes system prompt with single-quote escaping
- agent-registry.example.json has no _comment keys and includes skip_permissions
- config/SCHEMA.md exists and documents all agent fields
- SKILL.md lists both bin/hook-event-logger.sh and bin/launch-session.mjs
- README.md has separate Current Structure and Planned Structure sections
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-refactor-phase-1-code-based-on-code-review-findings/01.1-02-SUMMARY.md`
</output>
