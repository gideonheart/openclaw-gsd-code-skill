---
phase: 01.1-refactor-phase-1-code-based-on-code-review-findings
plan: "02"
subsystem: infra
tags: [node, tmux, execFileSync, parseArgs, shell-injection, agent-registry, schema]

requires:
  - phase: 01-cleanup
    provides: "bin/launch-session.mjs initial implementation, config/agent-registry.example.json, SKILL.md, README.md"
provides:
  - "Hardened bin/launch-session.mjs: execFileSync argument arrays, parseArgs stdlib, async main, single-quote prompt escaping, per-agent skip_permissions"
  - "Clean config/agent-registry.example.json with no _comment keys and skip_permissions field"
  - "New config/SCHEMA.md documenting all agent registry fields"
  - "Updated SKILL.md listing both scripts"
  - "Updated README.md separating current vs planned directory structure"
affects: [phase-2-event-handlers, launch-session, agent-registry]

tech-stack:
  added: []
  patterns:
    - "execFileSync with argument arrays for all child process calls — eliminates shell injection"
    - "node:util parseArgs for CLI argument parsing — replaces custom parsers"
    - "async main() with Promise-based sleep — no execSync for time delays"
    - "Single-quote escaping for system prompt text passed via tmux send-keys"
    - "per-agent skip_permissions in registry with default-true backward compatibility"
    - "Schema documentation in SCHEMA.md instead of _comment keys in JSON"

key-files:
  created:
    - config/SCHEMA.md
  modified:
    - bin/launch-session.mjs
    - config/agent-registry.example.json
    - SKILL.md
    - README.md

key-decisions:
  - "skip_permissions !== false default: flag included unless explicitly false — backward compatible with registries that omit the field"
  - "Single-quote escaping (replace ' with '\\'' ) for tmux send-keys system prompt — handles shell metacharacters safely"
  - "Schema docs in SCHEMA.md replaces _comment JSON keys — proper separation of data and documentation"
  - "README.md split into Current Structure and Planned Structure — prevents future confusion about what exists vs what is planned"

patterns-established:
  - "execFileSync + argument arrays: all tmux subprocess calls use this pattern — never string interpolation into shell"
  - "parseArgs from node:util: standard library over custom parsers for all future CLI scripts"
  - "Async main with Promise sleep: async function main() + main().catch() pattern for all future Node.js scripts"

requirements-completed: [REV-3.3, REV-3.4, REV-3.5, REV-3.6, REV-3.7, REV-3.8, REV-3.11]

duration: 2min
completed: 2026-02-20
---

# Phase 01.1 Plan 02: Refactor launch-session.mjs Summary

**Shell-injection-free tmux launcher using execFileSync argument arrays, node:util parseArgs, async sleep, single-quote prompt escaping, and per-agent skip_permissions from registry**

## Performance

- **Duration:** ~2 min
- **Started:** 2026-02-20T09:45:25Z
- **Completed:** 2026-02-20T09:47:41Z
- **Tasks:** 2
- **Files modified:** 5 (1 created, 4 modified)

## Accomplishments

- Eliminated shell injection in bin/launch-session.mjs by replacing all `execSync` string interpolation with `execFileSync` argument arrays for tmux calls
- Replaced custom argument parser with `parseArgs` from node:util, added `--help` flag support, and made `main()` async with Promise-based sleep
- Added `buildClaudeStartCommand` with single-quote escaping and per-agent `skip_permissions` registry field (default-true for backward compatibility)
- Cleaned config/agent-registry.example.json (removed all `_comment` keys, added `skip_permissions` field) and created config/SCHEMA.md with full field documentation
- Fixed SKILL.md to list both scripts and rewrote README.md to separate current vs planned directory structure

## Task Commits

Each task was committed atomically:

1. **Task 1: Refactor launch-session.mjs for security and best practices** - `7a38322` (refactor)
2. **Task 2: Clean agent-registry example, create schema docs, fix SKILL.md and README.md** - `017f2fd` (feat)

**Plan metadata:** (docs commit — see below)

## Files Created/Modified

- `bin/launch-session.mjs` — Hardened session launcher: execFileSync, parseArgs, async main, single-quote prompt escaping, per-agent skip_permissions
- `config/agent-registry.example.json` — Clean example: no _comment keys, skip_permissions field on both agents
- `config/SCHEMA.md` — New: agent registry field documentation replacing _comment JSON keys
- `SKILL.md` — Added bin/launch-session.mjs to Scripts section
- `README.md` — Separated Current Structure and Planned Structure sections

## Decisions Made

- `skip_permissions !== false` default: the flag is included unless the registry explicitly sets `skip_permissions: false`. This preserves backward compatibility with existing registries that omit the field.
- Single-quote escaping strategy: replace `'` with `'\''` for system prompt text sent via `tmux send-keys`. This handles shell metacharacters without double-quoting risks.
- Schema documentation moved to `config/SCHEMA.md` instead of `_comment` JSON keys — cleaner data files, proper markdown formatting for documentation.
- README.md structure split: current structure lists only what exists on disk; planned structure shows what will be built — prevents confusion for future contributors.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 01.1 Plan 01 and Plan 02 are complete — all code review findings (REV-3.x) addressed
- Phase 01.1 is fully complete; ready to proceed to Phase 2 event handler implementation
- bin/launch-session.mjs is now secure and can safely launch agents with arbitrary system prompt content

---
*Phase: 01.1-refactor-phase-1-code-based-on-code-review-findings*
*Completed: 2026-02-20*
