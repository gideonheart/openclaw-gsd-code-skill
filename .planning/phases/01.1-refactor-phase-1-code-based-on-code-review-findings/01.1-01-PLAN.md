---
phase: 01.1-refactor-phase-1-code-based-on-code-review-findings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/hook-event-logger.sh
  - package.json
  - .gitignore
autonomous: true
requirements: [REV-3.1, REV-3.2, REV-3.9, REV-3.10]

must_haves:
  truths:
    - "hook-event-logger.sh captures timestamp once and reuses it across the structured log block instead of calling date -u six times"
    - "hook-event-logger.sh reads stdin before the ERR trap is set, so a broken pipe is not silently swallowed"
    - "HOOK_ENTRY_MS variable is removed since it was captured but never used"
    - "package.json declares engines >=22, bin entry for launch-session, and license field"
    - ".gitignore covers node_modules/, .env, and *.lock in addition to existing entries"
  artifacts:
    - path: "bin/hook-event-logger.sh"
      provides: "Refactored debug logger with single timestamp capture and correctly scoped trap"
      contains: "LOG_BLOCK_TIMESTAMP"
    - path: "package.json"
      provides: "Complete package metadata with engines, bin, scripts, and license"
      contains: "engines"
    - path: ".gitignore"
      provides: "Complete gitignore covering Node.js project patterns"
      contains: "node_modules"
  key_links:
    - from: "bin/hook-event-logger.sh"
      to: "logs/*.log"
      via: "structured log block using LOG_BLOCK_TIMESTAMP"
      pattern: "LOG_BLOCK_TIMESTAMP"
---

<objective>
Refactor hook-event-logger.sh to fix redundant date calls, unused variable, and overly broad trap scope. Update package.json and .gitignore with missing Node.js project fields.

Purpose: Address code review findings REV-3.1, REV-3.2, REV-3.9, REV-3.10 before Phase 2 builds on these foundations.
Output: Corrected bin/hook-event-logger.sh, complete package.json, comprehensive .gitignore.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/quick/1-analyse-phase-1-implementation-code-revi/REVIEW.md
@bin/hook-event-logger.sh
@package.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hook-event-logger.sh timestamp redundancy and trap scope</name>
  <files>bin/hook-event-logger.sh</files>
  <action>
Three changes to bin/hook-event-logger.sh:

**Change 1 — Move trap after stdin read (REV-3.2):**
Move `trap 'exit 0' ERR` from line 22 (before stdin read) to AFTER the `STDIN_JSON=$(cat)` line. This ensures a broken stdin pipe surfaces as an error during development rather than silently producing garbage JSONL. The trap still protects all subsequent log-writing operations from crashing Claude Code.

Before:
```bash
trap 'exit 0' ERR
STDIN_JSON=$(cat)
HOOK_ENTRY_MS=$(date +%s%3N)
```

After:
```bash
STDIN_JSON=$(cat)

# Safety trap: from here forward, logger errors must never crash Claude Code
trap 'exit 0' ERR
```

**Change 2 — Remove unused HOOK_ENTRY_MS (REV-3.1):**
Delete the `HOOK_ENTRY_MS=$(date +%s%3N)` line entirely. It was captured but never used anywhere in the script.

**Change 3 — Capture structured log block timestamp once (REV-3.1):**
Replace the six separate `date -u` calls in the structured log block (lines 46-52) with a single capture:

Before (6 date calls):
```bash
{
  printf '[%s] ===== HOOK EVENT: %s =====\n' "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "$EVENT_NAME"
  printf '[%s] timestamp: %s\n' "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
  printf '[%s] session: %s\n' "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "$SESSION_NAME"
  printf '[%s] stdin_bytes: %d\n' "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "$STDIN_BYTE_COUNT"
  printf '[%s] payload:\n' "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
  printf '%s' "$STDIN_JSON" | jq '.' 2>/dev/null || printf '%s' "$STDIN_JSON"
  printf '[%s] ===== END EVENT: %s =====\n' "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" "$EVENT_NAME"
}
```

After (1 date call, reused):
```bash
LOG_BLOCK_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
{
  printf '[%s] ===== HOOK EVENT: %s =====\n' "$LOG_BLOCK_TIMESTAMP" "$EVENT_NAME"
  printf '[%s] session: %s\n' "$LOG_BLOCK_TIMESTAMP" "$SESSION_NAME"
  printf '[%s] stdin_bytes: %d\n' "$LOG_BLOCK_TIMESTAMP" "$STDIN_BYTE_COUNT"
  printf '[%s] payload:\n' "$LOG_BLOCK_TIMESTAMP"
  printf '%s' "$STDIN_JSON" | jq '.' 2>/dev/null || printf '%s' "$STDIN_JSON"
  printf '[%s] ===== END EVENT: %s =====\n' "$LOG_BLOCK_TIMESTAMP" "$EVENT_NAME"
} >> "$GSD_HOOK_LOG" 2>/dev/null || true
```

Note: The redundant "timestamp:" line (which printed the timestamp as both prefix AND value) is removed entirely — it added no information.

Do NOT change: the debug_log function, the flock-based JSONL append, the TIMESTAMP_ISO capture on line 62 (that one is correctly used in the JSONL record), or any other logic.
  </action>
  <verify>
Run `bash -n bin/hook-event-logger.sh` to confirm no syntax errors.
Run `grep -c 'date -u' bin/hook-event-logger.sh` — should return 3 or fewer (debug_log function, LOG_BLOCK_TIMESTAMP capture, TIMESTAMP_ISO capture).
Run `grep 'HOOK_ENTRY_MS' bin/hook-event-logger.sh` — should return no matches.
Run `grep 'LOG_BLOCK_TIMESTAMP' bin/hook-event-logger.sh` — should return matches.
Confirm `trap 'exit 0' ERR` appears AFTER `STDIN_JSON=$(cat)` in the file.
  </verify>
  <done>
hook-event-logger.sh has exactly one date -u call per timestamp variable (LOG_BLOCK_TIMESTAMP and TIMESTAMP_ISO), the trap is scoped after stdin read, and HOOK_ENTRY_MS is removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add missing fields to package.json and expand .gitignore</name>
  <files>package.json, .gitignore</files>
  <action>
**package.json (REV-3.9):**

Add the following fields to the existing package.json:

```json
{
  "name": "gsd-code-skill",
  "version": "4.0.0",
  "type": "module",
  "description": "Event-driven hook system for Claude Code agent lifecycle management",
  "private": true,
  "license": "UNLICENSED",
  "engines": {
    "node": ">=22"
  },
  "bin": {
    "launch-session": "bin/launch-session.mjs"
  },
  "scripts": {
    "check": "node --check bin/*.mjs"
  }
}
```

Fields added:
- `license: "UNLICENSED"` — private project, explicit declaration
- `engines: { node: ">=22" }` — documents the minimum Node.js version requirement (ESM, parseArgs, import.meta.url)
- `bin: { "launch-session": "bin/launch-session.mjs" }` — documents the CLI entry point
- `scripts: { "check": "node --check bin/*.mjs" }` — syntax validation script

Do NOT add a `test` script stub — there are no tests yet and "echo no tests" is noise.

**.gitignore (REV-3.10):**

Add standard Node.js entries below the existing entries. Preserve existing comments and entries. Append:

```
# Node.js dependencies — will be created when packages are installed in Phase 2+.
node_modules/

# Environment files — may contain secrets.
.env
.env.*

# Lock files — flock creates these at runtime; they should not be committed.
*.lock
```

The existing entries (`config/agent-registry.json`, `logs/`) must remain unchanged.
  </action>
  <verify>
Run `node -e "const p = JSON.parse(require('fs').readFileSync('package.json','utf8')); console.log(p.engines.node, p.license, p.bin['launch-session'])"` and confirm output is `>=22 UNLICENSED bin/launch-session.mjs`.
Run `grep 'node_modules' .gitignore` — should return a match.
Run `grep '.env' .gitignore` — should return a match.
Run `grep '*.lock' .gitignore` — should return a match.
Confirm existing entries are preserved: `grep 'agent-registry.json' .gitignore` returns match.
  </verify>
  <done>
package.json declares engines >=22, bin entry, license, and a check script. .gitignore covers node_modules/, .env, .env.*, and *.lock alongside existing entries.
  </done>
</task>

</tasks>

<verification>
1. `bash -n bin/hook-event-logger.sh` exits 0 (valid bash syntax)
2. `grep -c 'date -u' bin/hook-event-logger.sh` returns 3 or fewer
3. `grep 'HOOK_ENTRY_MS' bin/hook-event-logger.sh` returns nothing
4. `grep 'LOG_BLOCK_TIMESTAMP' bin/hook-event-logger.sh` returns matches
5. `node -e "JSON.parse(require('fs').readFileSync('package.json','utf8'))"` exits 0 (valid JSON)
6. `grep 'node_modules' .gitignore` returns match
</verification>

<success_criteria>
- hook-event-logger.sh captures structured log block timestamp once via LOG_BLOCK_TIMESTAMP
- hook-event-logger.sh trap is scoped after stdin read
- hook-event-logger.sh has no unused HOOK_ENTRY_MS variable
- package.json has engines, bin, scripts, and license fields
- .gitignore covers node_modules/, .env, and *.lock
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-refactor-phase-1-code-based-on-code-review-findings/01.1-01-SUMMARY.md`
</output>
