---
phase: 02.1-refactor-phase-2-shared-library-based-on-code-review-findings
plan: 01
subsystem: lib
tags: [nodejs, esm, logging, retry, paths]

# Dependency graph
requires:
  - phase: 02-shared-library
    provides: lib/logger.mjs, lib/agent-resolver.mjs, lib/retry.mjs with duplicated SKILL_ROOT and unsafe defaults
provides:
  - lib/paths.mjs with shared SKILL_ROOT constant
  - Discriminated error handling in logger.mjs catch block
  - Safe retry defaults (3 attempts / 2000ms) for hook context
affects: [03-stop-hook-handler, all future phases using lib/]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Shared path constants module: compute SKILL_ROOT once in lib/paths.mjs, import everywhere"
    - "Discriminated catch: check error.code before deciding swallow vs stderr"
    - "Hook-context retry defaults: 3 attempts / 2s base — fast-fail is better than blocking for minutes"

key-files:
  created:
    - lib/paths.mjs
  modified:
    - lib/logger.mjs
    - lib/agent-resolver.mjs
    - lib/retry.mjs

key-decisions:
  - "SKILL_ROOT in paths.mjs is an internal lib constant, not re-exported from index.mjs — event handlers import from lib/paths.mjs directly (Phase 3 concern)"
  - "Discriminated catch: ENOENT/ENOSPC/undefined-code swallowed silently; other system errors get one stderr line without throwing"
  - "Retry defaults 3/2000: total max wait ~6s — holding a hook process alive for ~42min is worse than fast-failing"

patterns-established:
  - "Single source of truth for path constants: lib/paths.mjs"
  - "Discriminated error handling: named catch binding + code-based branching instead of bare catch {}"

requirements-completed:
  - REV-02-3.2
  - REV-02-3.3
  - REV-02-3.5

# Metrics
duration: 1min
completed: 2026-02-20
---

# Phase 02.1 Plan 01: Shared Library Refactor Summary

**lib/paths.mjs extracted as shared SKILL_ROOT source, logger.mjs gains discriminated catch handling, retry.mjs defaults reduced from 10/5000ms to 3/2000ms for hook safety**

## Performance

- **Duration:** 1 min
- **Started:** 2026-02-20T14:13:44Z
- **Completed:** 2026-02-20T14:14:44Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments

- Created lib/paths.mjs as single source of truth for SKILL_ROOT — eliminates duplicated `dirname(dirname(fileURLToPath(import.meta.url)))` in lib
- Logger catch block now discriminates: expected I/O errors (ENOENT, ENOSPC) swallowed silently; unexpected system errors emit one stderr line; non-system errors swallowed silently
- Retry defaults reduced from 10 attempts / 5s base (~42min max wait) to 3 attempts / 2s base (~6s max wait) — appropriate for hook-context invocations

## Task Commits

Each task was committed atomically:

1. **Task 1: Create lib/paths.mjs and update logger.mjs and agent-resolver.mjs to import SKILL_ROOT from it** - `792df61` (refactor)
2. **Task 2: Add discriminated error handling to logger.mjs catch block** - `5a78534` (fix)
3. **Task 3: Change retry.mjs defaults to 3 attempts / 2000ms base and update JSDoc** - `28b8429` (fix)

## Files Created/Modified

- `lib/paths.mjs` - New: exports SKILL_ROOT as single shared path constant for all lib modules
- `lib/logger.mjs` - Removed local SKILL_ROOT computation; imports from paths.mjs; discriminated catch block
- `lib/agent-resolver.mjs` - Removed local SKILL_ROOT computation; imports from paths.mjs
- `lib/retry.mjs` - Updated defaults (maxAttempts: 10->3, initialDelayMilliseconds: 5000->2000); updated JSDoc

## Decisions Made

- `SKILL_ROOT` is not re-exported from `lib/index.mjs` — it is an internal lib constant. Event handlers that need it will import from `lib/paths.mjs` directly (Phase 3 concern).
- Discriminated catch preserves the "logger never throws" guarantee while adding diagnostic signal for unexpected errors via stderr.
- Retry defaults chosen for hook-context safety: blocking a Claude Code hook process for up to 42 minutes was identified as worse than fast-failing after 6 seconds.

## Deviations from Plan

None - plan executed exactly as written.

Minor: added a blank line between the `paths.mjs` import and the `LOG_DIRECTORY` const in logger.mjs (whitespace consistency left by Task 1 edit). Not a deviation — cosmetic fix inline.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All three Phase 02 code review findings (REV-02-3.2, REV-02-3.3, REV-02-3.5) resolved
- lib/ has no more duplicated SKILL_ROOT computations
- Phase 03 (stop hook handler) can build on this foundation with confidence
- No blockers

---
*Phase: 02.1-refactor-phase-2-shared-library-based-on-code-review-findings*
*Completed: 2026-02-20*
