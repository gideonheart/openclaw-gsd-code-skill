---
phase: 02.1-refactor-phase-2-shared-library-based-on-code-review-findings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/paths.mjs
  - lib/logger.mjs
  - lib/agent-resolver.mjs
  - lib/retry.mjs
autonomous: true
requirements:
  - REV-02-3.2
  - REV-02-3.3
  - REV-02-3.5

must_haves:
  truths:
    - "retry.mjs defaults are 3 attempts / 2000ms base (not 10 / 5000ms)"
    - "logger.mjs catch block discriminates expected I/O errors from unexpected ones"
    - "lib/paths.mjs exports SKILL_ROOT, imported by logger.mjs and agent-resolver.mjs"
    - "All existing lib imports still work (node -e import succeeds)"
  artifacts:
    - path: "lib/paths.mjs"
      provides: "Shared SKILL_ROOT constant"
      exports: ["SKILL_ROOT"]
    - path: "lib/retry.mjs"
      provides: "Exponential backoff retry with safe defaults for hook context"
      exports: ["retryWithBackoff"]
    - path: "lib/logger.mjs"
      provides: "Atomic JSONL logging with discriminated error handling"
      exports: ["appendJsonlEntry"]
    - path: "lib/agent-resolver.mjs"
      provides: "Session-to-agent lookup importing SKILL_ROOT from paths.mjs"
      exports: ["resolveAgentFromSession"]
  key_links:
    - from: "lib/logger.mjs"
      to: "lib/paths.mjs"
      via: "import { SKILL_ROOT }"
      pattern: "import.*SKILL_ROOT.*from.*paths"
    - from: "lib/agent-resolver.mjs"
      to: "lib/paths.mjs"
      via: "import { SKILL_ROOT }"
      pattern: "import.*SKILL_ROOT.*from.*paths"
---

<objective>
Resolve three Phase 02 code review findings in the shared library: extract SKILL_ROOT into a dedicated paths module, add discriminated error handling to the logger catch block, and reduce retry defaults to safe values for hook context.

Purpose: Fix the three actionable items from the Phase 02 code review before Phase 3 builds on this foundation. All changes are internal refactors with no API changes.
Output: Updated lib/paths.mjs (new), lib/logger.mjs, lib/agent-resolver.mjs, lib/retry.mjs
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@lib/logger.mjs
@lib/agent-resolver.mjs
@lib/retry.mjs
@lib/index.mjs
@lib/paths.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/paths.mjs and update logger.mjs and agent-resolver.mjs to import SKILL_ROOT from it</name>
  <files>lib/paths.mjs, lib/logger.mjs, lib/agent-resolver.mjs</files>
  <action>
Create `lib/paths.mjs` with a single named export `SKILL_ROOT`:

```javascript
/**
 * lib/paths.mjs — Shared path constants for all lib modules.
 *
 * Computes SKILL_ROOT once and exports it. All lib modules that need
 * filesystem paths relative to the skill root import from here instead
 * of computing dirname(dirname(fileURLToPath(import.meta.url))) independently.
 */

import { dirname } from 'node:path';
import { fileURLToPath } from 'node:url';

export const SKILL_ROOT = dirname(dirname(fileURLToPath(import.meta.url)));
```

In `lib/logger.mjs`:
- Remove the `dirname` import from `node:path` (keep `resolve`)
- Remove the `fileURLToPath` import from `node:url`
- Remove line `const SKILL_ROOT = dirname(dirname(fileURLToPath(import.meta.url)));`
- Add `import { SKILL_ROOT } from './paths.mjs';`
- Keep `LOG_DIRECTORY` and `DEFAULT_LOG_FILE_PREFIX` unchanged

In `lib/agent-resolver.mjs`:
- Remove `dirname` from the `node:path` import (keep `resolve`)
- Remove the entire `node:url` import line
- Remove line `const SKILL_ROOT = dirname(dirname(fileURLToPath(import.meta.url)));`
- Add `import { SKILL_ROOT } from './paths.mjs';`
- Keep `AGENT_REGISTRY_PATH` computation unchanged

Do NOT add `SKILL_ROOT` to `lib/index.mjs` re-exports — it is an internal lib constant, not a public API. Event handlers that need SKILL_ROOT will import from `lib/paths.mjs` directly (Phase 3 concern).
  </action>
  <verify>
Run `node -e "import('./lib/paths.mjs').then(m => console.log(m.SKILL_ROOT))"` — should print the skill root path.
Run `node -e "import('./lib/logger.mjs')"` — should succeed without error.
Run `node -e "import('./lib/agent-resolver.mjs')"` — should succeed without error.
Run `node -e "import('./lib/index.mjs')"` — should succeed without error (existing imports still work).
Grep both logger.mjs and agent-resolver.mjs for `fileURLToPath` — should find zero matches (removed).
Grep both logger.mjs and agent-resolver.mjs for `from './paths.mjs'` — should find one match each.
  </verify>
  <done>SKILL_ROOT is defined once in lib/paths.mjs and imported by both logger.mjs and agent-resolver.mjs. No duplicate computation. All existing lib imports still work.</done>
</task>

<task type="auto">
  <name>Task 2: Add discriminated error handling to logger.mjs catch block</name>
  <files>lib/logger.mjs</files>
  <action>
Replace the bare `catch { }` block in `appendJsonlEntry` with discriminated error handling:

```javascript
  } catch (loggingError) {
    // Swallow expected I/O errors silently — the logger must never crash the caller.
    // For unexpected errors, emit to stderr so the issue surfaces during debugging
    // without breaking the hook process.
    if (loggingError.code === 'ENOENT' || loggingError.code === 'ENOSPC') {
      return;
    }
    if (loggingError.code === undefined) {
      // Non-system errors (e.g. JSON.stringify failures) — also swallow silently.
      return;
    }
    process.stderr.write(`[gsd-code-skill logger] Unexpected error: ${loggingError.message}\n`);
  }
```

The logic:
- `ENOENT` (file/dir not found after mkdirSync — race condition): silent swallow
- `ENOSPC` (disk full): silent swallow — nothing the logger can do
- `code === undefined` (non-system errors like TypeError from JSON.stringify): silent swallow — these are programming errors that should not crash the hook
- Everything else (unexpected system errors like EACCES, EMFILE): emit one line to stderr so an operator sees the signal, but do NOT throw

Update the module-level JSDoc comment to mention the discriminated error handling:
Change "The logger never throws — all errors are silently swallowed" to "The logger never throws — expected I/O errors are silently swallowed, unexpected errors emit a single line to stderr for diagnostic visibility."
  </action>
  <verify>
Read `lib/logger.mjs` and confirm:
1. The catch block binds `loggingError` (not bare catch)
2. ENOENT and ENOSPC return silently
3. `code === undefined` returns silently
4. Other errors write to stderr
5. The function never throws (no throw statement in catch block)
Run `node -e "import('./lib/logger.mjs')"` — should succeed.
  </verify>
  <done>Logger catch block discriminates expected I/O errors (silent swallow) from unexpected system errors (stderr fallback). The logger still never throws.</done>
</task>

<task type="auto">
  <name>Task 3: Change retry.mjs defaults to 3 attempts / 2000ms base and update JSDoc</name>
  <files>lib/retry.mjs</files>
  <action>
In `retryWithBackoff`:

1. Change the default `maxAttempts` from `10` to `3`
2. Change the default `initialDelayMilliseconds` from `5000` to `2000`

Update the module-level JSDoc block:
- Change "Default: 10 attempts, starting at 5s delay, doubling each time." to "Default: 3 attempts, starting at 2s delay, doubling each time."
- Change the delay sequence comment from "Delay sequence: 5s, 10s, 20s, 40s, 80s, 160s, 320s, 640s, 1280s, 2560s" to "Delay sequence: 2s, 4s (total ~6s). Designed for hook-context invocations where holding a process alive for minutes is worse than fast-failing."

Update the `@param` JSDoc for both parameters:
- `options.maxAttempts` — change `(default: 10)` to `(default: 3)`
- `options.initialDelayMilliseconds` — change `(default: 5000)` to `(default: 2000)`

Do NOT change the exponential backoff formula or the retry logging behavior.
  </action>
  <verify>
Read `lib/retry.mjs` and confirm:
1. `maxAttempts = 3` in the destructuring defaults
2. `initialDelayMilliseconds = 2000` in the destructuring defaults
3. JSDoc says "Default: 3 attempts" and "default: 3" / "default: 2000"
4. The backoff formula `initialDelayMilliseconds * Math.pow(2, attemptNumber - 1)` is unchanged
Run `node -e "import('./lib/retry.mjs')"` — should succeed.
  </verify>
  <done>retry.mjs defaults are 3 attempts / 2000ms base. Total max wait is ~6s instead of ~42min. JSDoc documents the hook-context rationale.</done>
</task>

</tasks>

<verification>
1. `node -e "import('./lib/index.mjs').then(m => console.log(Object.keys(m)))"` — should list all 5 exported functions (unchanged API surface)
2. `node -e "import('./lib/paths.mjs').then(m => console.log(m.SKILL_ROOT))"` — should print the skill root path
3. `grep -r 'dirname(dirname(fileURLToPath' lib/` — should match ONLY lib/paths.mjs (zero matches in logger.mjs or agent-resolver.mjs)
4. `grep "maxAttempts = 3" lib/retry.mjs` — should match
5. `grep "initialDelayMilliseconds = 2000" lib/retry.mjs` — should match
6. `grep "loggingError" lib/logger.mjs` — should match (discriminated catch)
</verification>

<success_criteria>
- lib/paths.mjs exists and exports SKILL_ROOT
- logger.mjs and agent-resolver.mjs import SKILL_ROOT from paths.mjs (no local computation)
- logger.mjs catch block discriminates expected I/O errors from unexpected ones
- retry.mjs defaults are 3 attempts / 2000ms base
- All existing lib imports work: `node -e "import('./lib/index.mjs')"` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-refactor-phase-2-shared-library-based-on-code-review-findings/02.1-01-SUMMARY.md`
</output>
