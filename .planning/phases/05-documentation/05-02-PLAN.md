---
phase: 05-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - README.md
autonomous: true
requirements:
  - DOCS-02

must_haves:
  truths:
    - "README.md starts with a numbered pre-flight checklist for admin setup"
    - "README.md contains annotated JSON registry schema with inline comments explaining each field"
    - "README.md documents three-tier fallback (per-agent > global > hardcoded) with concrete example"
    - "README.md documents system_prompt field and hook_settings object in registry schema"
    - "README.md contains operational runbook with manual runs, dry-run, and troubleshooting"
    - "README.md documents how to verify daemon status and hooks are firing"
    - "README.md documents Laravel Forge UI setup alongside raw systemctl commands"
  artifacts:
    - path: "README.md"
      provides: "Admin-facing setup, registry schema, and operational documentation"
      contains: "## Pre-Flight Checklist"
  key_links:
    - from: "README.md"
      to: "config/recovery-registry.example.json"
      via: "reference for registry template"
      pattern: "recovery-registry\\.example\\.json"
    - from: "README.md"
      to: "scripts/register-hooks.sh"
      via: "reference for hook registration"
      pattern: "register-hooks\\.sh"
---

<objective>
Rewrite README.md as a comprehensive admin-facing document covering setup, registry schema, hook verification, and operational runbook for the hook-driven architecture.

Purpose: Admins need a complete reference to set up the infrastructure (registry, hooks, systemd, Laravel Forge) before agents can run autonomously. After setup, the document serves as an operational runbook for troubleshooting and verification.

Output: Rewritten README.md with pre-flight checklist, annotated registry schema, operational runbook, and verification steps.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-documentation/05-CONTEXT.md
@.planning/phases/05-documentation/05-RESEARCH.md

Source files to reference for accurate documentation:
@config/recovery-registry.example.json
@config/default-system-prompt.txt
@scripts/spawn.sh
@scripts/recover-openclaw-agents.sh
@scripts/register-hooks.sh
@scripts/sync-recovery-registry-session-ids.sh
@systemd/recover-openclaw-agents.service
@systemd/recover-openclaw-agents.timer
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite README.md as admin-facing operations document</name>
  <files>README.md</files>
  <action>
Rewrite README.md as a comprehensive admin-facing document. Clean slate approach -- no mention of old polling system. Document current architecture as if it always existed.

**README.md structure** (per locked decisions):

1. **# gsd-code-skill** (title)
   One-paragraph overview: what this skill does (event-driven agent session lifecycle), who this doc is for (admins setting up infrastructure).

2. **## Pre-Flight Checklist** (first substantive section per locked decision)
   Numbered steps that an admin completes once before first agent spawn:

   1. **Configure registry** -- Create `config/recovery-registry.json` from example, set agent entries. Reference `config/recovery-registry.example.json` as template. Brief guidance on required vs optional fields.

   2. **Register hooks** -- Run `scripts/register-hooks.sh`. Include verification command: `jq '.hooks' ~/.claude/settings.json` to confirm all 5 hooks registered.

   3. **Install systemd timer** -- Two paths documented:
      a. **Via Laravel Forge UI** (preferred per user's specific idea): Add Daemon with name, command, user. Add Scheduled Job for reboot trigger. Document what to configure in Forge UI, not just raw commands.
      b. **Manual systemd install** (fallback): The existing `sudo install` + `systemctl enable` commands.

   4. **Verify daemon** -- `systemctl status` commands with expected output.

   5. **Test spawn** -- `scripts/spawn.sh test-agent /tmp/test-dir` with `tmux ls` verification.

3. **## Registry Schema** (per locked decision: admin territory, not duplicated in SKILL.md)

   Full annotated JSON example based on `config/recovery-registry.example.json`. Use the actual example file content with inline comments explaining:
   - Each field's purpose, required/optional status, type, default
   - `system_prompt` field and replacement model (per-agent prompt replaces default-system-prompt.txt entirely when present, empty string uses default only)
   - `hook_settings` object with all fields: `pane_capture_lines`, `context_pressure_threshold`, `autocompact_pct`, `hook_mode`

   After the JSON example, explain **Three-Tier Fallback** mechanism:
   - Priority: per-agent > global > hardcoded
   - Per-field merge (not all-or-nothing)
   - Concrete example: if global sets `pane_capture_lines: 100` and agent sets `hook_mode: bidirectional` but not `pane_capture_lines`, agent gets `pane_capture_lines: 100` (from global) + `hook_mode: bidirectional` (from per-agent)

   Document all top-level fields:
   - `global_status_openclaw_session_id` (optional, recommended)
   - `global_status_openclaw_session_key` (optional, recommended -- for auto-refresh)
   - `hook_settings` (global defaults)
   - `agents` array

   Document all per-agent fields from the example registry (read actual file for accuracy):
   - `agent_id`, `enabled`, `auto_wake`, `topic_id`, `openclaw_session_id`, `working_directory`, `tmux_session_name`
   - `claude_resume_target`, `claude_launch_command`, `claude_post_launch_mode`
   - `system_prompt`, `hook_settings`

4. **## Recovery Flow** (per locked decision)
   Document the deterministic recovery sequence:
   1. Auto-sync session ids from OpenClaw agent data
   2. Load registry, filter enabled + auto_wake agents
   3. Ensure tmux session exists in correct workdir
   4. Launch Claude Code if not running
   5. Apply system prompt (per-agent or default fallback)
   6. Send wake instruction to OpenClaw session
   7. Wait for resume menu to clear (up to 45s), fallback to `/gsd:resume-work`
   8. Send per-agent status and global summary

   Note that hooks fire automatically once session is running (stop, notification, session-end, pre-compact).

5. **## Operational Runbook**

   **Manual runs:**
   - Dry-run: `scripts/recover-openclaw-agents.sh --dry-run`
   - Live run: `scripts/recover-openclaw-agents.sh`
   - Custom registry: `--registry /path/to/file.json`
   - Skip sync: `--skip-session-id-sync`
   - Standalone sync: `scripts/sync-recovery-registry-session-ids.sh [--dry-run]`

   **Verification commands:**
   - Check hooks registered: `jq '.hooks' ~/.claude/settings.json`
   - Check daemon status: `systemctl status recover-openclaw-agents.timer` (or `.service`)
   - Check tmux sessions: `tmux ls`
   - Check registry: `jq '.agents[] | {agent_id, enabled, auto_wake}' config/recovery-registry.json`
   - Re-register hooks after updates: `scripts/register-hooks.sh`

   **Troubleshooting:**
   - Wrong tmux session created: verify `tmux_session_name` in registry
   - Wrong OpenClaw session awakened: verify `openclaw_session_id` or run sync
   - Agent not recovering on reboot: verify systemd timer enabled, check `auto_wake=true`
   - Hooks not firing: run `register-hooks.sh`, verify with jq command above
   - Non-destructive: script skips disabled agents, logs on missing fields, never deletes files or sessions

6. **## Files** (brief inventory)
   List all files with one-line descriptions:
   - Scripts (all .sh files in scripts/)
   - Config files (recovery-registry.json, recovery-registry.example.json, default-system-prompt.txt)
   - systemd units (service + timer)
   - Documentation (SKILL.md for agents, docs/hooks.md for hook deep-dive)
  </action>
  <verify>
Verify README.md:
- Contains "## Pre-Flight Checklist" as early section
- Contains "## Registry Schema" with annotated JSON example
- Contains "Three-Tier Fallback" explanation
- Contains `system_prompt` and `hook_settings` documentation
- Contains "## Recovery Flow" section
- Contains "## Operational Runbook" with dry-run, verification, troubleshooting
- Contains Laravel Forge UI setup instructions
- Does NOT contain "autoresponder", "hook-watcher", "gsd-session-hook", or "polling"
- References `config/recovery-registry.example.json` and `scripts/register-hooks.sh`
  </verify>
  <done>
README.md is a comprehensive admin-facing document with pre-flight checklist, annotated registry schema showing system_prompt and hook_settings with three-tier fallback, recovery flow narrative, operational runbook with verification and troubleshooting, and Laravel Forge setup instructions. No references to obsolete polling system.
  </done>
</task>

</tasks>

<verification>
1. README.md has pre-flight checklist, registry schema, recovery flow, operational runbook
2. Registry schema includes system_prompt, hook_settings with annotated JSON and three-tier fallback
3. Laravel Forge UI setup documented alongside raw systemctl commands
4. No references to autoresponder, hook-watcher, gsd-session-hook, or polling
</verification>

<success_criteria>
- Admin can follow pre-flight checklist to set up infrastructure from scratch
- Admin can understand full registry schema including system_prompt and hook_settings
- Admin can verify hooks are firing and daemon is running using documented commands
- Admin can troubleshoot common issues using the operational runbook
</success_criteria>

<output>
After completion, create `.planning/phases/05-documentation/05-02-SUMMARY.md`
</output>
