---
phase: 11-operational-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/logrotate.conf
  - scripts/install-logrotate.sh
autonomous: true
requirements:
  - OPS-02

must_haves:
  truths:
    - "JSONL and plain-text log files in logs/ are rotated daily and cannot grow unbounded"
    - "Log rotation uses copytruncate so open >> file descriptors in hook scripts continue writing correctly"
    - "Rotated logs are compressed and retained for 7 days"
    - "Running install-logrotate.sh installs the config to /etc/logrotate.d/gsd-code-skill"
  artifacts:
    - path: "config/logrotate.conf"
      provides: "Logrotate config template covering *.jsonl and *.log with copytruncate"
      contains: "copytruncate"
    - path: "scripts/install-logrotate.sh"
      provides: "One-shot installer that writes config to /etc/logrotate.d/ via sudo tee"
      contains: "sudo tee"
  key_links:
    - from: "scripts/install-logrotate.sh"
      to: "config/logrotate.conf"
      via: "reads template and pipes to sudo tee"
      pattern: "sudo tee.*< .*logrotate.conf"
    - from: "config/logrotate.conf"
      to: "logs/*.jsonl and logs/*.log"
      via: "logrotate glob patterns with absolute paths"
      pattern: "/home/forge/.openclaw/workspace/skills/gsd-code-skill/logs/"
---

<objective>
Create logrotate configuration and install script for production-grade log rotation of JSONL and plain-text hook logs.

Purpose: Prevent unbounded disk growth from per-session JSONL and plain-text log files that hook scripts continuously append to. The `copytruncate` strategy is required because hook scripts hold open `>>` file descriptors — standard rename-based rotation would silently lose all log data after rotation.

Output: `config/logrotate.conf` (git-tracked template) and `scripts/install-logrotate.sh` (one-shot installer using `sudo tee`).
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-operational-hardening/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logrotate config template</name>
  <files>config/logrotate.conf</files>
  <action>
Create `config/logrotate.conf` with the following exact content:

```
/home/forge/.openclaw/workspace/skills/gsd-code-skill/logs/*.jsonl
/home/forge/.openclaw/workspace/skills/gsd-code-skill/logs/*.log
{
    su forge forge
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

Two file patterns on separate lines in the same block. Directive rationale:
- `su forge forge` — log files owned by forge:forge; logrotate runs as root; mandatory for non-root-owned directories
- `daily` — runs once daily via systemd logrotate.timer
- `rotate 7` — keep 7 rotated versions (7 days of history)
- `compress` + `delaycompress` — gzip rotated files; delay-compress skips the most-recent rotated file
- `missingok` — do not error if no log files match yet (fresh installation)
- `notifempty` — do not rotate empty files
- `copytruncate` — truncate original file in-place after copying; preserves open >> file descriptors in hook scripts

Do NOT include `create` directive — it has no effect when `copytruncate` is in use (confirmed in logrotate man page).

Note: shell glob `*.jsonl` does NOT match `*.jsonl.lock` files. The flock lock files are safe.
  </action>
  <verify>
Verify the file exists: `cat config/logrotate.conf`

Run logrotate debug mode to verify syntax (state file permission error is expected and harmless when running as non-root):
```bash
logrotate -d config/logrotate.conf 2>&1
```
The output should show the correct log file patterns being recognized and the `copytruncate` directive being applied. Ignore any "state file" permission warnings.
  </verify>
  <done>config/logrotate.conf exists with copytruncate, su forge forge, daily rotation for both *.jsonl and *.log patterns, and logrotate -d confirms valid syntax</done>
</task>

<task type="auto">
  <name>Task 2: Create logrotate install script</name>
  <files>scripts/install-logrotate.sh</files>
  <action>
Create `scripts/install-logrotate.sh` as an executable bash script. Follow project conventions: `#!/usr/bin/env bash`, `set -euo pipefail`, timestamp logging.

The script must:
1. Derive SKILL_ROOT from BASH_SOURCE (resilient to relocation): `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` then `SKILL_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"`
2. Set `LOGROTATE_CONF="${SKILL_ROOT}/config/logrotate.conf"` and `LOGROTATE_DEST="/etc/logrotate.d/gsd-code-skill"`
3. Verify the config template exists — exit 1 with error if missing
4. Install via `sudo tee "$LOGROTATE_DEST" < "$LOGROTATE_CONF" > /dev/null` (requires password — interactive use)
5. Verify the installed config with `logrotate -d "$LOGROTATE_DEST" 2>&1` — filter out debug mode and state file warnings with `grep -v 'debug mode\|state file' || true`
6. Log success message and show how to force-test: `sudo logrotate --force $LOGROTATE_DEST`

Use a `log_message()` function for all output with UTC timestamps matching the project convention.

Mark the script executable with `chmod +x`.
  </action>
  <verify>
Verify the script exists and is executable:
```bash
ls -la scripts/install-logrotate.sh
```

Verify the script has correct shebang and pipefail:
```bash
head -2 scripts/install-logrotate.sh
```

Verify it references the config template path correctly:
```bash
grep 'logrotate.conf' scripts/install-logrotate.sh
```
  </verify>
  <done>scripts/install-logrotate.sh is executable, derives paths from BASH_SOURCE, verifies config template exists, installs via sudo tee, and runs logrotate -d verification</done>
</task>

</tasks>

<verification>
1. `config/logrotate.conf` contains `copytruncate` and `su forge forge` directives
2. `config/logrotate.conf` covers both `*.jsonl` and `*.log` glob patterns with absolute paths to skill logs directory
3. `scripts/install-logrotate.sh` is executable and follows project conventions
4. `logrotate -d config/logrotate.conf` shows valid syntax (ignore state file warning)
5. No existing files were modified — both artifacts are new
</verification>

<success_criteria>
- logrotate config template exists at config/logrotate.conf with copytruncate for open >> fd safety
- Install script exists at scripts/install-logrotate.sh using sudo tee pattern
- logrotate -d validates the config syntax without errors
- Both files follow project conventions (shebang, set -euo pipefail, timestamp logging, BASH_SOURCE paths)
</success_criteria>

<output>
After completion, create `.planning/phases/11-operational-hardening/11-01-SUMMARY.md`
</output>
