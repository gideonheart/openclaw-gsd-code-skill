---
phase: 11-operational-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/diagnose-hooks.sh
autonomous: true
requirements:
  - OPS-03

must_haves:
  truths:
    - "Running diagnose-hooks.sh shows recent JSONL events for the target session"
    - "Running diagnose-hooks.sh shows outcome distribution (delivered count, non-delivered count)"
    - "Running diagnose-hooks.sh shows hook script distribution across the session"
    - "Running diagnose-hooks.sh shows duration statistics (count, min, max, avg) in milliseconds"
    - "Non-delivered events are flagged with FAIL status and recent error details shown"
    - "Missing JSONL log file (fresh install) is handled gracefully, not a failure"
  artifacts:
    - path: "scripts/diagnose-hooks.sh"
      provides: "Step 10 JSONL Log Analysis section with jq-based diagnostic queries"
      contains: "JSONL Log Analysis"
  key_links:
    - from: "scripts/diagnose-hooks.sh"
      to: "logs/{SESSION_NAME}.jsonl"
      via: "JSONL_LOG_FILE variable derived from HOOK_LOG and TMUX_SESSION_NAME"
      pattern: "HOOK_LOG.*TMUX_SESSION_NAME.*jsonl"
    - from: "scripts/diagnose-hooks.sh"
      to: "jq"
      via: "jq -r and jq -s queries on JSONL log file"
      pattern: "jq.*JSONL_LOG_FILE"
---

<objective>
Add JSONL log analysis to diagnose-hooks.sh as Step 10 — parsing per-session JSONL log files with jq to show recent events, error counts, outcome distribution, and duration statistics.

Purpose: Make the existing diagnostic tool JSONL-aware so operators can quickly assess hook health from structured log data. The existing 9 steps check infrastructure health (registration, scripts, registry, tmux, openclaw); the new step checks operational health (what hooks have actually done and whether they succeeded).

Output: Modified `scripts/diagnose-hooks.sh` with Step 10 (JSONL Log Analysis) inserted before the optional test-wake step, which is renumbered to Step 11.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-operational-hardening/11-RESEARCH.md
@scripts/diagnose-hooks.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Step 10 JSONL Log Analysis to diagnose-hooks.sh</name>
  <files>scripts/diagnose-hooks.sh</files>
  <action>
Insert a new Step 10 section in `scripts/diagnose-hooks.sh` between the existing Step 9 (Hook Debug Logs) and the existing optional Step 10 (Test Wake Message). The existing optional test-wake step (currently labeled Step 10 in the comment) must be renumbered to Step 11.

The new Step 10 must:

1. **Set JSONL file path:** `JSONL_LOG_FILE="${HOOK_LOG}/${TMUX_SESSION_NAME}.jsonl"` — same pattern as existing `.log` files.

2. **Handle missing file gracefully:** If no JSONL file exists, show INFO "No JSONL log yet" and add 1 to TOTAL_CHECKS and PASSED_CHECKS (not a failure for fresh install — same pattern as Step 9 missing log directory).

3. **Show record count and pass:** Count lines with `wc -l`, show as PASS with file path and record count.

4. **Last 5 events table:** Use `jq -r '[.timestamp, .hook_script, .trigger, .outcome] | @tsv'` piped to `tail -5`, then format each line with `info` function. Read with `while IFS=$'\t' read -r` loop.

5. **Outcome distribution:** Use `jq -r '.outcome'` piped to `sort | uniq -c | sort -rn`, format each line with `info`.

6. **Hook script distribution:** Use `jq -r '.hook_script'` piped to `sort | uniq -c | sort -rn`, format each line with `info`.

7. **Non-delivered event check:** Use `jq -c 'select(.outcome != "delivered")'` piped to `wc -l`. If count > 0, use `fail` and show last 5 non-delivered events with timestamp, hook_script, outcome. If count is 0, use `pass` "No non-delivered events". Update TOTAL_CHECKS and PASSED_CHECKS accordingly.

8. **Duration stats:** Use `jq -s '[.[].duration_ms] | {count: length, min: min, max: max, avg: (add/length | round)}'` and format output as a single info line like "count=N min=Nms max=Nms avg=Nms".

All jq expressions MUST be in single quotes in the script file (not double quotes) to prevent shell interpretation of special characters like `!=`.

Add blank `echo ""` lines between subsections for readability, matching the existing style.

For the existing optional test-wake section (currently at line ~327 with comment `# 10. Optional: Send test wake message`), change:
- The comment from `# 10.` to `# 11.`
- The echo from `"--- Step 10: Test Wake Message ---"` to `"--- Step 11: Test Wake Message ---"`
  </action>
  <verify>
1. Verify the new step appears in the file:
```bash
grep -n "JSONL Log Analysis" scripts/diagnose-hooks.sh
```

2. Verify the test-wake section was renumbered:
```bash
grep -n "Step 11" scripts/diagnose-hooks.sh
```

3. Verify jq expressions use single quotes (no shell escaping issues):
```bash
grep "jq.*outcome.*delivered" scripts/diagnose-hooks.sh
```

4. Run the diagnostic against an active agent to verify it works end-to-end (use a known agent name that has JSONL logs):
```bash
scripts/diagnose-hooks.sh warden 2>&1 | grep -A2 "JSONL"
```
  </verify>
  <done>diagnose-hooks.sh has Step 10 (JSONL Log Analysis) with recent events, outcome distribution, hook script distribution, non-delivered event detection, and duration stats. Optional test-wake renumbered to Step 11. All jq queries use single-quoted expressions.</done>
</task>

<task type="auto">
  <name>Task 2: Update usage help text with Step 10 description</name>
  <files>scripts/diagnose-hooks.sh</files>
  <action>
Update the usage/help text at the top of `scripts/diagnose-hooks.sh` (in the `if [ -z "$AGENT_NAME" ]` block around lines 18-33) to include the new Step 10 in the numbered list of checks.

Current list ends at step 8 (optional send test wake). Update to include:
- Step 9 keeps its existing description about hook debug logs
- Add step 10: "JSONL log analysis (recent events, error counts, outcome distribution)"
- Step 11 (renumbered): "(Optional) Send a test wake message"

The numbered list in the echo block should read:
```
  1. Hook registration in ~/.claude/settings.json
  2. Hook script existence and executability
  3. Agent registry entry and required fields
  4. tmux session existence and $TMUX propagation
  5. Session name resolution via tmux display-message
  6. Registry lookup by session name
  7. openclaw binary availability
  8. Hook debug logs
  9. JSONL log analysis (recent events, error counts, outcome distribution)
  10. (Optional) Send a test wake message
```

Note: The current help text shows 8 items numbered differently. Match the actual step numbers in the script body. The help text is a summary guide, not an exhaustive list — keep it concise.
  </action>
  <verify>
Verify the help text includes the JSONL step:
```bash
scripts/diagnose-hooks.sh 2>&1 | grep -i "jsonl"
```
  </verify>
  <done>Usage help text includes Step 10 JSONL log analysis description, and all step numbers in help text match the step numbers in the script body</done>
</task>

</tasks>

<verification>
1. `scripts/diagnose-hooks.sh` contains "Step 10: JSONL Log Analysis" section with jq queries
2. Missing JSONL file is handled gracefully (INFO, not FAIL)
3. Outcome distribution, hook script distribution, and duration stats are all present
4. Non-delivered events trigger FAIL with recent error listing
5. Former "Step 10: Test Wake Message" is now "Step 11: Test Wake Message"
6. Usage help text includes JSONL log analysis step
7. All jq expressions are single-quoted to prevent shell escaping issues
</verification>

<success_criteria>
- diagnose-hooks.sh Step 10 shows recent JSONL events, outcome distribution, hook script distribution, non-delivered event count, and duration stats
- Fresh install (no JSONL file) shows graceful INFO message, not failure
- Non-delivered events are flagged with FAIL and details shown
- Optional test-wake renumbered to Step 11
- All jq queries work with live JSONL data (tested against existing session logs)
</success_criteria>

<output>
After completion, create `.planning/phases/11-operational-hardening/11-02-SUMMARY.md`
</output>
