---
phase: 01-additive-changes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/recovery-registry.example.json
  - config/default-system-prompt.txt
  - scripts/menu-driver.sh
autonomous: true
requirements:
  - CONFIG-01
  - CONFIG-02
  - CONFIG-04
  - CONFIG-05
  - CONFIG-06
  - CONFIG-07
  - CONFIG-08
  - MENU-01

must_haves:
  truths:
    - "recovery-registry.example.json documents system_prompt field per agent and hook_settings nested object with all four strict fields"
    - "recovery-registry.example.json shows global hook_settings at root level and per-agent overrides for three-tier fallback"
    - "recovery-registry.example.json contains realistic multi-agent setup with Gideon, Warden, and Forge agents each with different hook_settings"
    - "config/default-system-prompt.txt contains minimal GSD workflow guidance (slash commands) with no role/personality content"
    - "menu-driver.sh type action sends literal freeform text via tmux send-keys -l without shell expansion"
  artifacts:
    - path: "config/recovery-registry.example.json"
      provides: "Full schema documentation for recovery registry with system_prompt, hook_settings, and three-tier fallback"
      contains: "hook_settings"
    - path: "config/default-system-prompt.txt"
      provides: "Default system prompt for all managed Claude Code sessions"
      min_lines: 5
    - path: "scripts/menu-driver.sh"
      provides: "Updated menu driver with type action for freeform text input"
      contains: "send-keys.*-l"
  key_links:
    - from: "config/recovery-registry.example.json"
      to: "config/recovery-registry.json"
      via: "Schema template that real registry follows"
      pattern: "hook_settings"
    - from: "config/default-system-prompt.txt"
      to: "scripts/spawn.sh"
      via: "Spawn reads default prompt and appends per-agent prompt (Phase 3)"
      pattern: "default-system-prompt"
---

<objective>
Create the foundation config files and registry schema additions that all hook scripts depend on: updated recovery-registry.example.json documenting the new schema (system_prompt, hook_settings with three-tier fallback), config/default-system-prompt.txt for managed sessions, and the menu-driver.sh type action for freeform text input.

Purpose: Establish the data model and configuration that hook scripts (Plans 02, 03) reference for per-agent settings, wake message construction, and available actions.

Output: Updated recovery-registry.example.json, new config/default-system-prompt.txt, updated menu-driver.sh with type action.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-additive-changes/01-RESEARCH.md
@config/recovery-registry.json
@config/recovery-registry.example.json
@scripts/menu-driver.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create recovery-registry.example.json with full schema documentation</name>
  <files>config/recovery-registry.example.json</files>
  <action>
Rewrite config/recovery-registry.example.json to document the complete registry schema including new fields. The example must show:

**Root-level fields (existing):**
- `global_status_openclaw_session_id` (string, UUID)
- `global_status_openclaw_session_key` (string, session key format)

**Root-level `hook_settings` (NEW - global defaults):**
A nested object with exactly these four fields (strict, no open-ended keys):
- `pane_capture_lines`: 100 (integer, default number of tmux pane lines to capture)
- `context_pressure_threshold`: 50 (integer, percentage at which WARNING level triggers)
- `autocompact_pct`: 80 (integer, value for CLAUDE_AUTOCOMPACT_PCT_OVERRIDE env var)
- `hook_mode`: "async" (string, "async" or "bidirectional")

**Per-agent entries in `agents` array (3 agents: Gideon, Warden, Forge):**

Each agent has existing fields:
- `agent_id`, `enabled`, `auto_wake`, `topic_id`, `openclaw_session_id`
- `working_directory`, `tmux_session_name`, `claude_resume_target`
- `claude_launch_command`, `claude_post_launch_mode`

Plus NEW fields:
- `system_prompt` (string, per-agent prompt text that appends to default-system-prompt.txt, never replaces). Empty string means use only the default.
- `hook_settings` (object, per-agent overrides for specific hook_settings fields, uses three-tier fallback: per-agent > global > hardcoded)

**Three-tier fallback demonstration:**
- Gideon: no hook_settings overrides (empty object `{}`), inherits all from global
- Warden: overrides `pane_capture_lines: 150` and `hook_mode: "bidirectional"` (other fields inherit from global)
- Forge: overrides `context_pressure_threshold: 60` (other fields inherit from global)

This demonstrates per-field merge: each field resolves independently through the fallback chain.

**CONFIG-07 compliance:** Add a comment-like note (as a `_comment_system_prompt` field) explaining that per-agent system_prompt always appends to config/default-system-prompt.txt content, never replaces it.

**CONFIG-08 compliance:** Add a `_comment_hook_settings_defaults` field explaining that new agent entries should auto-populate hook_settings with empty object `{}` so they inherit all global defaults.

Use realistic UUIDs and paths matching the actual production setup (Gideon in /home/forge/.openclaw/workspace, Warden in /home/forge/warden.kingdom.lv, Forge in /home/forge).
  </action>
  <verify>
Run: `jq '.' config/recovery-registry.example.json` to verify valid JSON.
Run: `jq '.hook_settings | keys' config/recovery-registry.example.json` to verify global hook_settings has exactly the four strict fields plus comment fields.
Run: `jq '.agents | length' config/recovery-registry.example.json` to verify 3 agents.
Run: `jq '.agents[] | select(.agent_id == "warden") | .hook_settings' config/recovery-registry.example.json` to verify Warden has per-agent overrides.
Run: `jq '.agents[] | .system_prompt' config/recovery-registry.example.json` to verify all agents have system_prompt field.
  </verify>
  <done>
recovery-registry.example.json contains complete schema with global hook_settings (4 strict fields), 3 agents (Gideon, Warden, Forge) each with system_prompt and hook_settings fields, demonstrating three-tier fallback pattern with per-field merge.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create config/default-system-prompt.txt and add type action to menu-driver.sh</name>
  <files>config/default-system-prompt.txt, scripts/menu-driver.sh</files>
  <action>
**Part A: Create config/default-system-prompt.txt**

Create a new file `config/default-system-prompt.txt` with minimal GSD workflow guidance content. Per locked decisions:
- Focus on GSD workflow commands (/gsd:*, /clear, /resume)
- No role/personality content (agents get that from SOUL.md and AGENTS.md)
- No mention of managed tmux session or orchestration layer
- Pure workflow guidance only

Content should cover:
1. Brief statement that this session uses GSD workflow
2. Available GSD slash commands for project management (/gsd:resume-work, /gsd:new-project, /gsd:help)
3. Context management commands (/clear, /compact)
4. Instruction to use /gsd:help when uncertain about workflow

Keep it under 20 lines. This is appended to Claude's default system prompt, so it must be concise and additive (not contradictory).

**Part B: Add `type` action to menu-driver.sh**

Add a new `type` case to the existing case statement in scripts/menu-driver.sh. The type action:
1. Takes remaining arguments as the text to type (join all remaining args with spaces, supporting multi-word input)
2. Validates that text is non-empty (exit 1 with usage message if empty)
3. Clears the current input line with `tmux send-keys -t "$SESSION:0.0" C-u`
4. Sends the text literally with `tmux send-keys -t "$SESSION:0.0" -l -- "$text"` (the -l flag prevents shell expansion, -- prevents flag interpretation)
5. Presses Enter with `tmux send-keys -t "$SESSION:0.0" Enter`

Also update the usage() function to document the new action:
```
  type <text>                      Type literal freeform text + Enter
```

Insert the `type)` case AFTER the `choose)` case and BEFORE the `submit)` case in the existing case statement. The text variable should join all remaining positional parameters: `text="$*"` (after the shift 2 at the top already consumed session and action).
  </action>
  <verify>
Run: `cat config/default-system-prompt.txt` to verify content exists and is minimal GSD workflow guidance.
Run: `grep -c '/gsd:' config/default-system-prompt.txt` to verify GSD commands are mentioned.
Run: `grep -q 'type' scripts/menu-driver.sh && echo "type action present"` to verify type action was added.
Run: `grep 'send-keys.*-l' scripts/menu-driver.sh` to verify literal mode flag is used.
Run: `bash -n scripts/menu-driver.sh` to verify script has no syntax errors.
Run: `grep 'type <text>' scripts/menu-driver.sh` to verify usage documentation was updated.
  </verify>
  <done>
config/default-system-prompt.txt exists with minimal GSD workflow guidance (no role/personality, no orchestration mentions). menu-driver.sh has type action using tmux send-keys -l for literal freeform text input, with updated usage documentation. Both pass syntax validation.
  </done>
</task>

</tasks>

<verification>
1. `jq '.' config/recovery-registry.example.json` exits 0 (valid JSON)
2. `jq '.hook_settings.pane_capture_lines' config/recovery-registry.example.json` returns 100
3. `jq '.agents | length' config/recovery-registry.example.json` returns 3
4. `jq '.agents[1].hook_settings.hook_mode' config/recovery-registry.example.json` returns "bidirectional" (Warden)
5. `cat config/default-system-prompt.txt | wc -l` returns < 25 lines
6. `bash -n scripts/menu-driver.sh` exits 0
7. `grep 'send-keys.*-l' scripts/menu-driver.sh` finds the type action
8. No Python used anywhere in new/modified files
</verification>

<success_criteria>
- recovery-registry.example.json documents complete schema with system_prompt, hook_settings (4 strict fields), global defaults, and per-agent overrides for 3 agents
- config/default-system-prompt.txt exists with minimal GSD workflow guidance
- menu-driver.sh type action works with literal text via send-keys -l
- All files pass syntax validation (JSON valid, bash -n passes)
</success_criteria>

<output>
After completion, create `.planning/phases/01-additive-changes/01-01-SUMMARY.md`
</output>
