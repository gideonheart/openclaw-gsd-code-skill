---
phase: 06-core-extraction-and-delivery-engine
plan: 03
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - scripts/stop-hook.sh
autonomous: true
requirements:
  - EXTRACT-01
  - EXTRACT-02
  - WAKE-07
  - WAKE-08

must_haves:
  truths:
    - "Wake message [CONTENT] section contains Claude's actual response text extracted from transcript JSONL — no ANSI codes, no pane noise"
    - "When transcript extraction fails (file missing, parse error), hook falls back to pane diff (only new/added lines from last 40 pane lines) — never crashes, never sends empty"
    - "v1 [PANE CONTENT] section is completely removed — replaced by [CONTENT] section"
    - "Wake message uses v2 format: [SESSION IDENTITY], [TRIGGER], [CONTENT], [STATE HINT], [CONTEXT PRESSURE], [AVAILABLE ACTIONS]"
  artifacts:
    - path: "scripts/stop-hook.sh"
      provides: "Stop hook with transcript extraction and v2 wake format"
      contains: "[CONTENT]"
  key_links:
    - from: "scripts/stop-hook.sh"
      to: "lib/hook-utils.sh"
      via: "source statement"
      pattern: "source.*lib/hook-utils.sh"
    - from: "scripts/stop-hook.sh"
      to: "extract_last_assistant_response"
      via: "function call with transcript_path from stdin JSON"
      pattern: "extract_last_assistant_response.*TRANSCRIPT_PATH"
    - from: "scripts/stop-hook.sh"
      to: "extract_pane_diff"
      via: "fallback function call when transcript extraction returns empty"
      pattern: "extract_pane_diff.*SESSION_NAME"
---

<objective>
Modify `scripts/stop-hook.sh` to source lib/hook-utils.sh, extract Claude's response from transcript JSONL (primary) or pane diff (fallback), and emit v2 wake format with [CONTENT] replacing [PANE CONTENT].

Purpose: Gideon receives clean extracted content instead of 120 lines of raw tmux pane noise. The transcript provides exact response text; pane diff provides only new/changed lines when transcript is unavailable.
Output: Modified `scripts/stop-hook.sh` with v2 wake format.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-core-extraction-and-delivery-engine/06-RESEARCH.md
@.planning/phases/06-core-extraction-and-delivery-engine/06-01-SUMMARY.md
@scripts/stop-hook.sh
@lib/hook-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transcript extraction and pane diff fallback to stop-hook.sh</name>
  <files>scripts/stop-hook.sh</files>
  <action>
Modify the existing `scripts/stop-hook.sh` to add transcript extraction with pane diff fallback. Sections 1-9 are mostly unchanged; insert new code between existing sections. Section 10 (wake message) is completely replaced.

**Changes:**

**Insert after Section 6 (hook_settings extraction, line ~96) — Source lib:**
Note: SCRIPT_DIR is already defined at line 53 (`SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"`). Reuse it.

Add a new section 6b:
```bash
# ============================================================================
# 6b. SOURCE SHARED LIBRARY
# ============================================================================
LIB_PATH="${SCRIPT_DIR}/../lib/hook-utils.sh"
if [ -f "$LIB_PATH" ]; then
  source "$LIB_PATH"
  debug_log "sourced lib/hook-utils.sh"
else
  debug_log "WARNING: lib/hook-utils.sh not found at $LIB_PATH — transcript extraction disabled"
fi
```
If lib is missing, the hook continues with v1-style pane content as a safety net (graceful degradation, never crashes).

**Insert after Section 7 (pane capture, line ~101) — Extract transcript:**
Add a new section 7b:
```bash
# ============================================================================
# 7b. EXTRACT TRANSCRIPT CONTENT (primary) or PANE DIFF (fallback)
# ============================================================================
TRANSCRIPT_PATH=$(printf '%s' "$STDIN_JSON" | jq -r '.transcript_path // ""' 2>/dev/null || echo "")
EXTRACTED_RESPONSE=""

if type extract_last_assistant_response &>/dev/null; then
  EXTRACTED_RESPONSE=$(extract_last_assistant_response "$TRANSCRIPT_PATH")
  debug_log "transcript extraction: path=${TRANSCRIPT_PATH:-<empty>} result_length=${#EXTRACTED_RESPONSE}"
fi
```
The `type` check ensures the function exists (handles case where lib failed to source).

**Insert after Section 9 (context pressure, line ~135) — Compute content section:**
Add a new section 9b:
```bash
# ============================================================================
# 9b. DETERMINE CONTENT: transcript (primary) or pane diff (fallback)
# ============================================================================
if [ -n "$EXTRACTED_RESPONSE" ]; then
  CONTENT_SECTION="$EXTRACTED_RESPONSE"
  debug_log "content source: transcript"
else
  # Fallback: pane diff from last 40 lines
  PANE_FOR_DIFF=$(printf '%s\n' "$PANE_CONTENT" | tail -40)
  if type extract_pane_diff &>/dev/null; then
    CONTENT_SECTION=$(extract_pane_diff "$SESSION_NAME" "$PANE_FOR_DIFF")
    debug_log "content source: pane_diff (delta_length=${#CONTENT_SECTION})"
  else
    # Ultimate fallback if lib not loaded: use raw pane tail
    CONTENT_SECTION=$(printf '%s\n' "$PANE_CONTENT" | tail -40)
    debug_log "content source: raw_pane_tail (lib not available)"
  fi
fi
```

**Replace Section 10 entirely (lines 138-166) — V2 wake message:**
Remove the entire existing WAKE_MESSAGE heredoc (which contains `[PANE CONTENT]`). Replace with v2 format:
```bash
# ============================================================================
# 10. BUILD STRUCTURED WAKE MESSAGE (v2 format)
# ============================================================================
TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

WAKE_MESSAGE="[SESSION IDENTITY]
agent_id: ${AGENT_ID}
tmux_session_name: ${SESSION_NAME}
timestamp: ${TIMESTAMP}

[TRIGGER]
type: response_complete

[CONTENT]
${CONTENT_SECTION}

[STATE HINT]
state: ${STATE}

[CONTEXT PRESSURE]
${CONTEXT_PRESSURE}

[AVAILABLE ACTIONS]
menu-driver.sh ${SESSION_NAME} choose <n>
menu-driver.sh ${SESSION_NAME} type <text>
menu-driver.sh ${SESSION_NAME} clear_then <command>
menu-driver.sh ${SESSION_NAME} enter
menu-driver.sh ${SESSION_NAME} esc
menu-driver.sh ${SESSION_NAME} submit
menu-driver.sh ${SESSION_NAME} snapshot"
```

Key changes from v1:
- `[PANE CONTENT]` section is GONE — replaced by `[CONTENT]`
- `[CONTENT]` contains transcript text (clean, no ANSI) OR pane diff (only new lines) — never both
- `[STATE HINT]` moves after `[CONTENT]` (was before `[PANE CONTENT]` in v1)
- Section ordering: [SESSION IDENTITY], [TRIGGER], [CONTENT], [STATE HINT], [CONTEXT PRESSURE], [AVAILABLE ACTIONS]

**CRITICAL — WAKE-08 (v1 removal):**
- The old `[PANE CONTENT]\n${PANE_CONTENT}` block must be completely removed
- No conditional v1/v2 toggle
- No backward compatibility layer
- The `PANE_CONTENT` variable is still captured (section 7) because it is still used for: state detection (section 8), context pressure extraction (section 9), and pane diff fallback (section 9b)

**Section 11 (delivery) — Unchanged:**
The hybrid mode delivery (lines 168-195) remains exactly as-is. No changes needed.

**Conventions:**
- All variable names self-explanatory, no abbreviations (per CLAUDE.md)
- Use `printf '%s'` instead of `echo` when variable might contain escape sequences or start with dash
- Follow existing section header comment style
  </action>
  <verify>
1. `bash -n scripts/stop-hook.sh` — syntax check passes with exit 0
2. `grep '\[CONTENT\]' scripts/stop-hook.sh` — v2 [CONTENT] section present
3. `! grep '\[PANE CONTENT\]' scripts/stop-hook.sh` — v1 [PANE CONTENT] section completely removed (WAKE-08)
4. `grep 'source.*lib/hook-utils.sh' scripts/stop-hook.sh` — sources the shared lib
5. `grep 'extract_last_assistant_response' scripts/stop-hook.sh` — calls transcript extraction
6. `grep 'extract_pane_diff' scripts/stop-hook.sh` — calls pane diff fallback
7. `grep 'transcript_path' scripts/stop-hook.sh` — extracts transcript_path from stdin JSON
8. `grep 'type: response_complete' scripts/stop-hook.sh` — correct trigger type preserved
9. Verify section ordering in wake message: SESSION IDENTITY before TRIGGER before CONTENT before STATE HINT before CONTEXT PRESSURE before AVAILABLE ACTIONS
10. `grep 'PANE_CONTENT' scripts/stop-hook.sh` — variable still exists (used for state detection and context pressure)
  </verify>
  <done>
stop-hook.sh sources lib/hook-utils.sh, extracts transcript content via extract_last_assistant_response (primary), falls back to extract_pane_diff when transcript is empty (fallback), builds wake message with v2 [CONTENT] section, and v1 [PANE CONTENT] is completely removed.
  </done>
</task>

</tasks>

<verification>
- `bash -n scripts/stop-hook.sh` exits 0 (valid syntax)
- v1 [PANE CONTENT] section is completely absent from the file
- v2 [CONTENT] section is present in wake message
- Transcript extraction path: stdin JSON -> transcript_path -> extract_last_assistant_response -> CONTENT_SECTION
- Pane diff fallback path: PANE_CONTENT -> tail -40 -> extract_pane_diff -> CONTENT_SECTION
- Ultimate fallback: raw pane tail -40 if lib not loaded
- State detection (section 8) still uses PANE_CONTENT
- Context pressure (section 9) still uses PANE_CONTENT
- Delivery section (11) is unchanged
- Wake message section order: SESSION IDENTITY, TRIGGER, CONTENT, STATE HINT, CONTEXT PRESSURE, AVAILABLE ACTIONS
</verification>

<success_criteria>
stop-hook.sh passes syntax check, sources lib, extracts transcript as primary content source, falls back to pane diff, emits v2 wake format, and v1 [PANE CONTENT] is entirely removed.
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-extraction-and-delivery-engine/06-03-SUMMARY.md`
</output>
