---
phase: 13-coordinated-hook-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/notification-idle-hook.sh
  - scripts/notification-permission-hook.sh
autonomous: true
requirements:
  - MIGR-01
  - MIGR-02
  - REFAC-03
  - QUAL-01

must_haves:
  truths:
    - "notification-idle-hook.sh sources hook-preamble.sh and does not source hook-utils.sh directly"
    - "notification-permission-hook.sh sources hook-preamble.sh and does not source hook-utils.sh directly"
    - "notification-idle-hook.sh wake message uses [CONTENT] not [PANE CONTENT]"
    - "notification-permission-hook.sh wake message uses [CONTENT] not [PANE CONTENT]"
    - "Both hooks use extract_hook_settings() instead of inline settings extraction"
    - "Both hooks use detect_session_state() instead of inline state detection"
    - "Neither hook has echo-to-jq piping patterns"
  artifacts:
    - path: "scripts/notification-idle-hook.sh"
      provides: "Migrated idle notification hook"
      contains: "source.*hook-preamble.sh"
    - path: "scripts/notification-permission-hook.sh"
      provides: "Migrated permission notification hook"
      contains: "source.*hook-preamble.sh"
  key_links:
    - from: "scripts/notification-idle-hook.sh"
      to: "lib/hook-preamble.sh"
      via: "source statement"
      pattern: "source.*hook-preamble\\.sh"
    - from: "scripts/notification-permission-hook.sh"
      to: "lib/hook-preamble.sh"
      via: "source statement"
      pattern: "source.*hook-preamble\\.sh"
---

<objective>
Migrate notification-idle-hook.sh and notification-permission-hook.sh to use the shared library chain (hook-preamble.sh), replacing duplicated preamble blocks, inline settings extraction, inline state detection, [PANE CONTENT] labels, and echo-to-jq patterns.

Purpose: Eliminate duplicated code in the two notification hooks, making them consistent with the Phase 12 shared library.
Output: Two migrated hook scripts sourcing hook-preamble.sh with zero direct hook-utils.sh references.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-coordinated-hook-migration/13-RESEARCH.md
@lib/hook-preamble.sh
@lib/hook-utils.sh
@scripts/notification-idle-hook.sh
@scripts/notification-permission-hook.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate notification-idle-hook.sh</name>
  <files>scripts/notification-idle-hook.sh</files>
  <action>
Replace the entire preamble block (lines 1-27: shebang, set -euo, SKILL_LOG_DIR, mkdir, GSD_HOOK_LOG, HOOK_SCRIPT_NAME, debug_log function, FIRED log, SCRIPT_DIR, LIB_PATH, source hook-utils.sh) with exactly:

```bash
#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)/hook-preamble.sh"
```

The preamble already provides: SKILL_LOG_DIR, REGISTRY_PATH, HOOK_SCRIPT_NAME, SCRIPT_DIR, GSD_HOOK_LOG, debug_log(), and all hook-utils.sh functions.

Then apply these changes to the remaining hook body:

1. **Remove REGISTRY_PATH line** (currently `REGISTRY_PATH="${SCRIPT_DIR}/../config/recovery-registry.json"`) â€” already set by preamble.

2. **Replace inline settings block** (the GLOBAL_SETTINGS + PANE_CAPTURE_LINES + CONTEXT_PRESSURE_THRESHOLD + HOOK_MODE block, approximately 13 lines) with:
```bash
HOOK_SETTINGS_JSON=$(extract_hook_settings "$REGISTRY_PATH" "$AGENT_DATA")
PANE_CAPTURE_LINES=$(printf '%s' "$HOOK_SETTINGS_JSON" | jq -r '.pane_capture_lines')
CONTEXT_PRESSURE_THRESHOLD=$(printf '%s' "$HOOK_SETTINGS_JSON" | jq -r '.context_pressure_threshold')
HOOK_MODE=$(printf '%s' "$HOOK_SETTINGS_JSON" | jq -r '.hook_mode')
```

3. **Replace inline state detection** (the STATE="working" + if/elif/fi block using echo + grep) with:
```bash
STATE=$(detect_session_state "$PANE_CONTENT")
```

4. **Replace all echo-to-jq patterns** with printf equivalents:
- `echo "$STDIN_JSON" | jq` -> `printf '%s' "$STDIN_JSON" | jq`
- `echo "$AGENT_DATA" | jq` -> `printf '%s' "$AGENT_DATA" | jq`
- `echo "$PANE_CONTENT" | tail` -> `printf '%s\n' "$PANE_CONTENT" | tail`
- `echo "$PANE_CONTENT" | grep` -> `printf '%s\n' "$PANE_CONTENT" | grep`

5. **Replace [PANE CONTENT] with [CONTENT]** in the wake message heredoc (line 161).

Preserve all other logic unchanged: stdin consumption, TMUX guard, session name extraction, log redirect, registry lookup, agent data extraction, pane capture, context pressure extraction, wake message structure (except label), hybrid delivery mode, JSONL logging.
  </action>
  <verify>
Run these checks:
```bash
# Sources preamble
grep -c 'source.*hook-preamble.sh' scripts/notification-idle-hook.sh  # expect 1
# Does NOT source hook-utils.sh directly
grep -c 'source.*hook-utils.sh' scripts/notification-idle-hook.sh  # expect 0
# Uses [CONTENT] not [PANE CONTENT]
grep -c '\[PANE CONTENT\]' scripts/notification-idle-hook.sh  # expect 0
grep -c '\[CONTENT\]' scripts/notification-idle-hook.sh  # expect 1
# Uses extract_hook_settings
grep -c 'extract_hook_settings' scripts/notification-idle-hook.sh  # expect 1
# Uses detect_session_state
grep -c 'detect_session_state' scripts/notification-idle-hook.sh  # expect 1
# No echo-to-jq patterns
grep -c 'echo.*\$.*| jq' scripts/notification-idle-hook.sh  # expect 0
# Script is syntactically valid
bash -n scripts/notification-idle-hook.sh
```
  </verify>
  <done>notification-idle-hook.sh sources hook-preamble.sh, uses extract_hook_settings(), uses detect_session_state(), uses [CONTENT] label, has zero echo-to-jq patterns, and passes bash -n syntax check.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate notification-permission-hook.sh</name>
  <files>scripts/notification-permission-hook.sh</files>
  <action>
Apply the exact same migration pattern as Task 1 (notification-idle-hook.sh) to notification-permission-hook.sh. The two hooks have nearly identical structure.

Replace the entire preamble block (lines 1-27) with the 3-line bootstrap. Then:

1. Remove redundant REGISTRY_PATH line.
2. Replace inline settings block with extract_hook_settings() call.
3. Replace inline state detection with detect_session_state() call.
4. Replace all echo-to-jq patterns with printf equivalents.
5. Replace [PANE CONTENT] with [CONTENT] in wake message (line 162).

Preserve all other logic unchanged: stdin consumption, TMUX guard, session name extraction, log redirect, registry lookup, agent data extraction, pane capture, context pressure extraction, wake message structure (except label), hybrid delivery mode, JSONL logging.
  </action>
  <verify>
Run these checks:
```bash
# Sources preamble
grep -c 'source.*hook-preamble.sh' scripts/notification-permission-hook.sh  # expect 1
# Does NOT source hook-utils.sh directly
grep -c 'source.*hook-utils.sh' scripts/notification-permission-hook.sh  # expect 0
# Uses [CONTENT] not [PANE CONTENT]
grep -c '\[PANE CONTENT\]' scripts/notification-permission-hook.sh  # expect 0
grep -c '\[CONTENT\]' scripts/notification-permission-hook.sh  # expect 1
# Uses extract_hook_settings
grep -c 'extract_hook_settings' scripts/notification-permission-hook.sh  # expect 1
# Uses detect_session_state
grep -c 'detect_session_state' scripts/notification-permission-hook.sh  # expect 1
# No echo-to-jq patterns
grep -c 'echo.*\$.*| jq' scripts/notification-permission-hook.sh  # expect 0
# Script is syntactically valid
bash -n scripts/notification-permission-hook.sh
```
  </verify>
  <done>notification-permission-hook.sh sources hook-preamble.sh, uses extract_hook_settings(), uses detect_session_state(), uses [CONTENT] label, has zero echo-to-jq patterns, and passes bash -n syntax check.</done>
</task>

</tasks>

<verification>
After both tasks complete:
```bash
# Cross-hook verification
for hook in notification-idle-hook.sh notification-permission-hook.sh; do
  echo "=== $hook ==="
  echo "preamble: $(grep -c 'hook-preamble.sh' scripts/$hook)"
  echo "no-direct-utils: $(grep -c 'source.*hook-utils.sh' scripts/$hook)"
  echo "content-label: $(grep -c '\[CONTENT\]' scripts/$hook)"
  echo "no-pane-content: $(grep -c '\[PANE CONTENT\]' scripts/$hook)"
  echo "settings-func: $(grep -c 'extract_hook_settings' scripts/$hook)"
  echo "state-func: $(grep -c 'detect_session_state' scripts/$hook)"
  echo "no-echo-jq: $(grep -c 'echo.*\$.*| jq' scripts/$hook)"
  bash -n scripts/$hook && echo "syntax: OK" || echo "syntax: FAIL"
done
```
</verification>

<success_criteria>
- Both hooks source hook-preamble.sh (grep confirms 1 match each)
- Neither hook sources hook-utils.sh directly (grep confirms 0 matches each)
- Both hooks use [CONTENT] not [PANE CONTENT] (grep confirms)
- Both hooks call extract_hook_settings() (grep confirms)
- Both hooks call detect_session_state() (grep confirms)
- Zero echo-to-jq patterns in either hook (grep confirms)
- Both pass bash -n syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/13-coordinated-hook-migration/13-01-SUMMARY.md`
</output>
