---
phase: 13-coordinated-hook-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/pre-compact-hook.sh
  - scripts/session-end-hook.sh
autonomous: true
requirements:
  - MIGR-03
  - FIX-03
  - REFAC-03
  - QUAL-01

must_haves:
  truths:
    - "pre-compact-hook.sh sources hook-preamble.sh and does not source hook-utils.sh directly"
    - "session-end-hook.sh sources hook-preamble.sh and does not source hook-utils.sh directly"
    - "pre-compact-hook.sh wake message uses [CONTENT] not [PANE CONTENT]"
    - "pre-compact-hook.sh uses detect_session_state() with standard state names (menu, idle, working — not idle_prompt, active)"
    - "session-end-hook.sh jq calls include 2>/dev/null error guards"
    - "Neither hook has echo-to-jq piping patterns"
  artifacts:
    - path: "scripts/pre-compact-hook.sh"
      provides: "Migrated pre-compact hook with normalized state detection"
      contains: "source.*hook-preamble.sh"
    - path: "scripts/session-end-hook.sh"
      provides: "Migrated session-end hook with jq error guards"
      contains: "source.*hook-preamble.sh"
  key_links:
    - from: "scripts/pre-compact-hook.sh"
      to: "lib/hook-preamble.sh"
      via: "source statement"
      pattern: "source.*hook-preamble\\.sh"
    - from: "scripts/session-end-hook.sh"
      to: "lib/hook-preamble.sh"
      via: "source statement"
      pattern: "source.*hook-preamble\\.sh"
---

<objective>
Migrate pre-compact-hook.sh and session-end-hook.sh to use the shared library chain. Pre-compact gets preamble migration, settings function, [CONTENT] label, normalized state detection via detect_session_state(), and echo-to-printf sweep. Session-end gets preamble migration, jq error guards (FIX-03), and echo-to-printf sweep.

Purpose: Bring the two structurally unique hooks into consistency with the shared library while fixing session-end's missing jq error guards.
Output: Two migrated hook scripts sourcing hook-preamble.sh with all requirements met.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-coordinated-hook-migration/13-RESEARCH.md
@lib/hook-preamble.sh
@lib/hook-utils.sh
@scripts/pre-compact-hook.sh
@scripts/session-end-hook.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate pre-compact-hook.sh</name>
  <files>scripts/pre-compact-hook.sh</files>
  <action>
Replace the entire preamble block (lines 1-27: shebang, set -euo, SKILL_LOG_DIR, mkdir, GSD_HOOK_LOG, HOOK_SCRIPT_NAME, debug_log function, FIRED log, SCRIPT_DIR, LIB_PATH, source hook-utils.sh) with exactly:

```bash
#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)/hook-preamble.sh"
```

Then apply these changes to the remaining hook body:

1. **Remove REGISTRY_PATH line** (currently `REGISTRY_PATH="${SCRIPT_DIR}/../config/recovery-registry.json"`) — already set by preamble.

2. **Add 2>/dev/null error guards** to bare jq calls on lines 71-72:
- `AGENT_ID=$(echo "$AGENT_DATA" | jq -r '.agent_id')` becomes `AGENT_ID=$(printf '%s' "$AGENT_DATA" | jq -r '.agent_id' 2>/dev/null || echo "")`
- `OPENCLAW_SESSION_ID=$(echo "$AGENT_DATA" | jq -r '.openclaw_session_id')` becomes `OPENCLAW_SESSION_ID=$(printf '%s' "$AGENT_DATA" | jq -r '.openclaw_session_id' 2>/dev/null || echo "")`

3. **Replace inline settings block** (the GLOBAL_SETTINGS + PANE_CAPTURE_LINES + CONTEXT_PRESSURE_THRESHOLD + HOOK_MODE block — note pre-compact's version lacks 2>/dev/null on some lines) with:
```bash
HOOK_SETTINGS_JSON=$(extract_hook_settings "$REGISTRY_PATH" "$AGENT_DATA")
PANE_CAPTURE_LINES=$(printf '%s' "$HOOK_SETTINGS_JSON" | jq -r '.pane_capture_lines')
CONTEXT_PRESSURE_THRESHOLD=$(printf '%s' "$HOOK_SETTINGS_JSON" | jq -r '.context_pressure_threshold')
HOOK_MODE=$(printf '%s' "$HOOK_SETTINGS_JSON" | jq -r '.hook_mode')
```

4. **Replace divergent state detection block** (lines 110-118 using case-sensitive `grep -q "Choose an option:"`, `grep -q "Continue this conversation"`, `grep -q "permission to"`, fallback `STATE="active"`) with:
```bash
STATE=$(detect_session_state "$PANE_CONTENT")
```
This normalizes state names: `idle_prompt` -> `idle`, `active` -> `working`.

5. **Replace [PANE CONTENT] with [CONTENT]** in the wake message (line 136).

6. **Replace all echo-to-jq and echo-to-pipe patterns** with printf equivalents:
- `echo "$STDIN_JSON" | jq` -> `printf '%s' "$STDIN_JSON" | jq`
- `echo "$PANE_CONTENT" | tail` -> `printf '%s\n' "$PANE_CONTENT" | tail`
- `echo "$LAST_LINES" | grep` -> `printf '%s\n' "$LAST_LINES" | grep`

Preserve all other logic unchanged: stdin consumption, TMUX guard, session name extraction, log redirect, registry lookup, pane capture, context pressure extraction, wake message structure (except label and state names), hybrid delivery mode, JSONL logging.
  </action>
  <verify>
Run these checks:
```bash
# Sources preamble
grep -c 'source.*hook-preamble.sh' scripts/pre-compact-hook.sh  # expect 1
# Does NOT source hook-utils.sh directly
grep -c 'source.*hook-utils.sh' scripts/pre-compact-hook.sh  # expect 0
# Uses [CONTENT] not [PANE CONTENT]
grep -c '\[PANE CONTENT\]' scripts/pre-compact-hook.sh  # expect 0
grep -c '\[CONTENT\]' scripts/pre-compact-hook.sh  # expect 1
# Uses extract_hook_settings
grep -c 'extract_hook_settings' scripts/pre-compact-hook.sh  # expect 1
# Uses detect_session_state
grep -c 'detect_session_state' scripts/pre-compact-hook.sh  # expect 1
# No echo-to-jq patterns
grep -c 'echo.*\$.*| jq' scripts/pre-compact-hook.sh  # expect 0
# No old state names
grep -c 'idle_prompt\|STATE="active"' scripts/pre-compact-hook.sh  # expect 0
# Script is syntactically valid
bash -n scripts/pre-compact-hook.sh
```
  </verify>
  <done>pre-compact-hook.sh sources hook-preamble.sh, uses extract_hook_settings(), uses detect_session_state() with standard state names, uses [CONTENT] label, has jq error guards, has zero echo-to-jq patterns, and passes bash -n syntax check.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate session-end-hook.sh with jq error guards</name>
  <files>scripts/session-end-hook.sh</files>
  <action>
Replace the entire preamble block (lines 1-27) with the 3-line bootstrap:

```bash
#!/usr/bin/env bash
set -euo pipefail
source "$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)/hook-preamble.sh"
```

Then apply these changes:

1. **Remove REGISTRY_PATH line** — already set by preamble.

2. **Add 2>/dev/null error guards to bare jq calls** (FIX-03 requirement). Lines 71-72 currently:
```bash
AGENT_ID=$(echo "$AGENT_DATA" | jq -r '.agent_id')
OPENCLAW_SESSION_ID=$(echo "$AGENT_DATA" | jq -r '.openclaw_session_id')
```
Replace with:
```bash
AGENT_ID=$(printf '%s' "$AGENT_DATA" | jq -r '.agent_id' 2>/dev/null || echo "")
OPENCLAW_SESSION_ID=$(printf '%s' "$AGENT_DATA" | jq -r '.openclaw_session_id' 2>/dev/null || echo "")
```

3. **Replace all echo-to-jq patterns** with printf equivalents:
- `echo "$STDIN_JSON" | jq` -> `printf '%s' "$STDIN_JSON" | jq`

Note: session-end is a minimal hook — no settings block, no state detection, no pane capture, no [PANE CONTENT] label. The only changes beyond preamble migration are the jq error guards and echo-to-printf sweep.

Preserve all other logic unchanged: stdin consumption, TMUX guard, session name extraction, log redirect, registry lookup, wake message, async delivery, pane state file cleanup.
  </action>
  <verify>
Run these checks:
```bash
# Sources preamble
grep -c 'source.*hook-preamble.sh' scripts/session-end-hook.sh  # expect 1
# Does NOT source hook-utils.sh directly
grep -c 'source.*hook-utils.sh' scripts/session-end-hook.sh  # expect 0
# jq calls have 2>/dev/null
grep 'jq' scripts/session-end-hook.sh | grep -v '2>/dev/null' | grep -v '^#' | wc -l  # expect 0
# No echo-to-jq patterns
grep -c 'echo.*\$.*| jq' scripts/session-end-hook.sh  # expect 0
# Script is syntactically valid
bash -n scripts/session-end-hook.sh
```
  </verify>
  <done>session-end-hook.sh sources hook-preamble.sh, all jq calls have 2>/dev/null error guards, has zero echo-to-jq patterns, and passes bash -n syntax check.</done>
</task>

</tasks>

<verification>
After both tasks complete:
```bash
# Cross-hook verification
for hook in pre-compact-hook.sh session-end-hook.sh; do
  echo "=== $hook ==="
  echo "preamble: $(grep -c 'hook-preamble.sh' scripts/$hook)"
  echo "no-direct-utils: $(grep -c 'source.*hook-utils.sh' scripts/$hook)"
  echo "no-echo-jq: $(grep -c 'echo.*\$.*| jq' scripts/$hook)"
  bash -n scripts/$hook && echo "syntax: OK" || echo "syntax: FAIL"
done

# Pre-compact specific
echo "=== pre-compact specifics ==="
echo "content-label: $(grep -c '\[CONTENT\]' scripts/pre-compact-hook.sh)"
echo "no-pane-content: $(grep -c '\[PANE CONTENT\]' scripts/pre-compact-hook.sh)"
echo "settings-func: $(grep -c 'extract_hook_settings' scripts/pre-compact-hook.sh)"
echo "state-func: $(grep -c 'detect_session_state' scripts/pre-compact-hook.sh)"
echo "no-old-states: $(grep -c 'idle_prompt\|STATE=\"active\"' scripts/pre-compact-hook.sh)"

# Session-end specific (FIX-03)
echo "=== session-end jq guards ==="
grep 'jq' scripts/session-end-hook.sh | grep -v '2>/dev/null' | grep -v '^#' | wc -l  # expect 0
```
</verification>

<success_criteria>
- Both hooks source hook-preamble.sh (grep confirms)
- Neither hook sources hook-utils.sh directly (grep confirms)
- pre-compact uses [CONTENT] not [PANE CONTENT]
- pre-compact uses detect_session_state() with standard state names
- pre-compact uses extract_hook_settings()
- session-end jq calls all have 2>/dev/null (FIX-03 satisfied)
- Zero echo-to-jq patterns in either hook
- Both pass bash -n syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/13-coordinated-hook-migration/13-02-SUMMARY.md`
</output>
