---
phase: 01-cleanup
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - config/agent-registry.json
  - config/agent-registry.example.json
  - config/recovery-registry.json
  - config/recovery-registry.example.json
  - .gitignore
  - package.json
  - bin/launch-session.mjs
autonomous: true
requirements:
  - CLEAN-08

must_haves:
  truths:
    - ".gitignore references agent-registry.json, not recovery-registry.json"
    - "config/agent-registry.json exists with v4.0 schema"
    - "config/agent-registry.example.json exists with v4.0 schema and example data"
    - "config/recovery-registry.json no longer exists"
    - "config/recovery-registry.example.json no longer exists"
    - "package.json declares the project as ESM with type:module"
    - "bin/launch-session.mjs exists and is a valid Node.js ESM script"
  artifacts:
    - path: "config/agent-registry.json"
      provides: "v4.0 agent registry with simplified schema for event handlers"
      contains: "agents"
    - path: "config/agent-registry.example.json"
      provides: "Example agent registry demonstrating v4.0 schema"
      contains: "agents"
    - path: ".gitignore"
      provides: "Updated gitignore with agent-registry.json instead of recovery-registry.json"
      contains: "agent-registry.json"
    - path: "package.json"
      provides: "Minimal ESM package declaration"
      contains: "type.*module"
    - path: "bin/launch-session.mjs"
      provides: "Node.js ESM session launcher for Claude Code in tmux"
      min_lines: 50
  key_links:
    - from: "bin/launch-session.mjs"
      to: "config/agent-registry.json"
      via: "reads agent config for session setup"
      pattern: "agent-registry"
    - from: ".gitignore"
      to: "config/agent-registry.json"
      via: "gitignore entry prevents committing secrets"
      pattern: "agent-registry\\.json"
---

<objective>
Rename the registry from recovery-registry to agent-registry with a v4.0 schema, create a minimal ESM package.json, and write a fresh Node.js session launcher.

Purpose: Complete the clean slate by replacing the last v1-v3 naming convention (recovery-registry) with v4.0 naming (agent-registry), establishing ESM as the module system, and providing the session launcher that replaces the deleted spawn.sh. This gives Phase 2 (Shared Library) a clean foundation to build on.

Output: Renamed and redesigned agent-registry.json, updated .gitignore, package.json with type:module, and bin/launch-session.mjs session launcher.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cleanup/01-CONTEXT.md
@.planning/phases/01-cleanup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename registry to agent-registry with v4.0 schema and update .gitignore</name>
  <files>
    config/agent-registry.json
    config/agent-registry.example.json
    config/recovery-registry.json
    config/recovery-registry.example.json
    .gitignore
  </files>
  <action>
    **Part A: Design v4.0 agent-registry.json schema**

    The v4.0 schema should be simplified from v1-v3. Event handlers need only these fields per agent:
    - `agent_id` (string) — unique identifier (e.g., "gideon", "warden", "forge")
    - `enabled` (boolean) — whether this agent's hooks are active
    - `session_name` (string) — tmux session name where Claude Code runs (e.g., "gideon-main")
    - `working_directory` (string) — absolute path to agent's workspace
    - `openclaw_session_id` (string) — OpenClaw session UUID for gateway delivery
    - `system_prompt_file` (string) — relative path to prompt file (e.g., "config/default-system-prompt.txt"); agents reference files instead of inlining prompt strings

    Remove these v1-v3 fields that are no longer needed:
    - `auto_wake` — recovery is not in scope for v4.0 event handlers
    - `topic_id` — not used by event handlers
    - `claude_resume_target` — spawn/recovery concern, not event handler concern
    - `claude_launch_command` — spawn/recovery concern
    - `claude_post_launch_mode` — spawn/recovery concern
    - `system_prompt` (inline string) — replaced by `system_prompt_file` (file reference)
    - `hook_settings` (per-agent) — three-tier fallback system removed in v4.0
    - `global_status_openclaw_session_id` — not needed by event handlers
    - `global_status_openclaw_session_key` — not needed by event handlers
    - Top-level `hook_settings` — removed entirely

    The top-level structure is simply: `{ "agents": [...] }`

    **Part B: Create agent-registry.json**

    Read the current `config/recovery-registry.json` to preserve existing agent data.
    Create `config/agent-registry.json` with the v4.0 schema, migrating only the relevant fields from each existing agent entry. Map `tmux_session_name` to `session_name`. Set `system_prompt_file` to `"config/default-system-prompt.txt"` for all agents (the default fallback).

    **Part C: Create agent-registry.example.json**

    Create `config/agent-registry.example.json` with 2 example agents showing the v4.0 schema. Use placeholder values for session IDs and working directories. Include comments via `_comment` field explaining each field's purpose.

    **Part D: Delete old registry files**

    Delete `config/recovery-registry.json` and `config/recovery-registry.example.json`.

    **Part E: Update .gitignore**

    Replace the .gitignore contents. The new .gitignore should:
    - Reference `config/agent-registry.json` (not `config/recovery-registry.json`)
    - Keep `logs/` entry
    - Remove the `config/recovery-registry.json.lock` entry (no lock file in v4.0)
    - Add a comment explaining what is gitignored and why
  </action>
  <verify>
    ```bash
    # agent-registry.json exists with v4.0 schema
    test -f config/agent-registry.json && echo "PASS" || echo "FAIL"
    # Has agents array
    node -e "const r=JSON.parse(require('fs').readFileSync('config/agent-registry.json','utf8')); if(!Array.isArray(r.agents)) throw new Error('no agents array'); console.log('PASS: agents array with',r.agents.length,'entries')"
    # No old v1-v3 fields at top level
    node -e "const r=JSON.parse(require('fs').readFileSync('config/agent-registry.json','utf8')); if(r.hook_settings||r.global_status_openclaw_session_id) throw new Error('old fields present'); console.log('PASS: no old top-level fields')"
    # No old v1-v3 agent fields
    node -e "const r=JSON.parse(require('fs').readFileSync('config/agent-registry.json','utf8')); r.agents.forEach(a=>{if(a.auto_wake!==undefined||a.hook_settings!==undefined||a.system_prompt!==undefined) throw new Error('old agent fields: '+a.agent_id)}); console.log('PASS: no old agent fields')"
    # Example file exists
    test -f config/agent-registry.example.json && echo "PASS" || echo "FAIL"
    # Old files gone
    test ! -f config/recovery-registry.json && test ! -f config/recovery-registry.example.json && echo "PASS: old registry gone" || echo "FAIL"
    # .gitignore references agent-registry
    grep -q 'agent-registry.json' .gitignore && echo "PASS" || echo "FAIL"
    # .gitignore does NOT reference recovery-registry
    ! grep -q 'recovery-registry' .gitignore && echo "PASS" || echo "FAIL"
    ```
  </verify>
  <done>
    config/agent-registry.json exists with the v4.0 simplified schema (agents array with agent_id, enabled, session_name, working_directory, openclaw_session_id, system_prompt_file). config/agent-registry.example.json exists with example data. Old recovery-registry files are deleted. .gitignore references agent-registry.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create package.json and session launcher</name>
  <files>
    package.json
    bin/launch-session.mjs
  </files>
  <action>
    **Part A: Create minimal package.json**

    Create `package.json` at the project root with minimal fields:
    ```json
    {
      "name": "gsd-code-skill",
      "version": "4.0.0",
      "type": "module",
      "description": "Event-driven hook system for Claude Code agent lifecycle management",
      "private": true
    }
    ```

    No dependencies — this project uses only Node.js built-ins and system binaries.

    **Part B: Create bin/launch-session.mjs**

    Write a fresh Node.js ESM session launcher from scratch. This is NOT a rewrite of spawn.sh — it is a new, lean, DRY, SRP implementation.

    **Purpose:** Launch a Claude Code session in tmux for a named agent, reading config from agent-registry.json.

    **Usage:** `node bin/launch-session.mjs <agent-id> [--workdir <path>] [--first-command <cmd>]`

    **Behavior:**
    1. Parse CLI arguments (agent-id required, --workdir and --first-command optional)
    2. Read `config/agent-registry.json` relative to the script's directory (resolve via `import.meta.url`)
    3. Find the agent entry by `agent_id`
    4. Determine working directory: CLI --workdir overrides agent entry's `working_directory`
    5. Determine tmux session name from agent entry's `session_name`
    6. Check if tmux session already exists — if yes, print message and exit
    7. Read system prompt from the file referenced by `system_prompt_file` (resolved relative to skill root)
    8. Create tmux session: `tmux new-session -d -s <session_name> -c <workdir>`
    9. Launch Claude Code in the tmux pane: `tmux send-keys -t <session_name> 'claude --dangerously-skip-permissions --system-prompt "<prompt>"' Enter`
    10. If --first-command provided, wait 3 seconds then send it: `tmux send-keys -t <session_name> '<first-command>' Enter`
    11. Print success message with session name and attach command

    **Implementation requirements:**
    - Use `node:fs`, `node:path`, `node:url`, `node:child_process` (all built-in)
    - Use `import.meta.url` with `fileURLToPath` for script directory resolution
    - All variable names and function names must be self-explanatory (no abbreviations)
    - Use `execSync` from `node:child_process` for tmux commands
    - Proper error handling: missing agent, missing registry, tmux not available
    - Log with timestamps: same pattern as bash scripts `[ISO timestamp] message`
    - Script should be executable (add shebang `#!/usr/bin/env node`)
    - Make executable: `chmod +x bin/launch-session.mjs`
  </action>
  <verify>
    ```bash
    # package.json exists and is valid JSON
    node -e "const p=JSON.parse(require('fs').readFileSync('package.json','utf8')); if(p.type!=='module') throw new Error('not ESM'); console.log('PASS: package.json ESM')"
    # No dependencies
    node -e "const p=JSON.parse(require('fs').readFileSync('package.json','utf8')); if(p.dependencies||p.devDependencies) throw new Error('has deps'); console.log('PASS: no dependencies')"
    # Session launcher exists and is executable
    test -x bin/launch-session.mjs && echo "PASS: launcher executable" || echo "FAIL"
    # Session launcher is valid ESM (syntax check)
    node --check bin/launch-session.mjs && echo "PASS: launcher syntax valid" || echo "FAIL"
    # Session launcher uses import.meta.url (ESM pattern)
    grep -q 'import.meta.url' bin/launch-session.mjs && echo "PASS: uses ESM pattern" || echo "FAIL"
    # Session launcher reads agent-registry
    grep -q 'agent-registry' bin/launch-session.mjs && echo "PASS: reads registry" || echo "FAIL"
    # No abbreviations in function/variable names (spot check)
    ! grep -qE '\b(cfg|mgr|ctx|evt|sess|cmd|fn|cb|err|req|res|msg)\b' bin/launch-session.mjs && echo "PASS: no abbreviations" || echo "FAIL: check abbreviations"
    ```
  </verify>
  <done>
    package.json exists with type:module, version 4.0.0, no dependencies. bin/launch-session.mjs exists as a valid ESM Node.js script with self-explanatory naming, reads agent-registry.json, launches Claude Code in tmux, and passes syntax validation.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full plan success criteria:

```bash
cd /home/forge/.openclaw/workspace/skills/gsd-code-skill

# 1. .gitignore correct
grep -q 'agent-registry.json' .gitignore && ! grep -q 'recovery-registry' .gitignore && echo "PASS: .gitignore correct"

# 2. Agent registry with v4.0 schema
node -e "
  const r=JSON.parse(require('fs').readFileSync('config/agent-registry.json','utf8'));
  const required=['agent_id','enabled','session_name','working_directory','openclaw_session_id','system_prompt_file'];
  r.agents.forEach(a => {
    required.forEach(f => { if(a[f]===undefined) throw new Error(a.agent_id+' missing '+f) });
  });
  console.log('PASS: v4.0 schema valid with', r.agents.length, 'agents');
"

# 3. Example file exists
test -f config/agent-registry.example.json && echo "PASS: example exists"

# 4. No old registry files
test ! -f config/recovery-registry.json && test ! -f config/recovery-registry.example.json && echo "PASS: old gone"

# 5. Package.json ESM
node -e "const p=JSON.parse(require('fs').readFileSync('package.json','utf8')); console.log('PASS:', p.name, p.version, p.type)"

# 6. Session launcher valid
node --check bin/launch-session.mjs && echo "PASS: launcher valid"
```
</verification>

<success_criteria>
- config/agent-registry.json exists with v4.0 simplified schema, migrated from recovery-registry.json data
- config/agent-registry.example.json exists with example data
- config/recovery-registry.json and config/recovery-registry.example.json are deleted
- .gitignore references agent-registry.json (not recovery-registry.json)
- package.json exists with type:module, version 4.0.0, no dependencies
- bin/launch-session.mjs exists, is executable, passes node --check, uses ESM patterns, reads agent-registry.json
</success_criteria>

<output>
After completion, create `.planning/phases/01-cleanup/01-02-SUMMARY.md`
</output>
