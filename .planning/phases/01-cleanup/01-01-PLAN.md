---
phase: 01-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/stop-hook.sh
  - scripts/notification-idle-hook.sh
  - scripts/notification-permission-hook.sh
  - scripts/pre-tool-use-hook.sh
  - scripts/post-tool-use-hook.sh
  - scripts/pre-compact-hook.sh
  - scripts/session-end-hook.sh
  - scripts/menu-driver.sh
  - scripts/diagnose-hooks.sh
  - scripts/register-hooks.sh
  - scripts/register-all-hooks-logger.sh
  - scripts/sync-recovery-registry-session-ids.sh
  - scripts/recover-openclaw-agents.sh
  - scripts/test-hook-prompts.sh
  - scripts/install.sh
  - scripts/spawn.sh
  - scripts/prompts/
  - scripts/hook-event-logger.sh
  - lib/hook-preamble.sh
  - lib/hook-utils.sh
  - docs/v3-retrospective.md
  - docs/hooks.md
  - tests/test-deliver-async-with-logging.sh
  - tests/test-write-hook-event-record.sh
  - systemd/
  - PRD.md
  - config/recovery-registry.json.lock
  - bin/hook-event-logger.sh
  - SKILL.md
  - README.md
autonomous: true
requirements:
  - CLEAN-01
  - CLEAN-02
  - CLEAN-03
  - CLEAN-04
  - CLEAN-05

must_haves:
  truths:
    - "None of the seven old hook bash scripts exist anywhere in the repository"
    - "The old lib/hook-preamble.sh and lib/hook-utils.sh files do not exist"
    - "The scripts/ directory does not exist (entirely deleted)"
    - "The scripts/prompts/ directory does not exist"
    - "PRD.md, docs/v3-retrospective.md, docs/hooks.md, old test scripts do not exist"
    - "menu-driver.sh does not exist anywhere"
    - "systemd/ directory does not exist"
    - "config/recovery-registry.json.lock does not exist"
    - "hook-event-logger.sh is preserved at bin/hook-event-logger.sh with self-contained bootstrapping"
    - "SKILL.md has valid YAML frontmatter and v4.0 skeleton content"
    - "README.md has v4.0 skeleton content"
  artifacts:
    - path: "bin/hook-event-logger.sh"
      provides: "Relocated universal debug logger with self-contained bootstrapping (no hook-preamble.sh dependency)"
      min_lines: 40
    - path: "SKILL.md"
      provides: "Stripped v4.0 skeleton with valid YAML frontmatter"
      min_lines: 10
    - path: "README.md"
      provides: "Stripped v4.0 skeleton"
      min_lines: 5
  key_links:
    - from: "bin/hook-event-logger.sh"
      to: "logs/"
      via: "SKILL_LOG_DIR variable resolving to skill root /logs"
      pattern: "SKILL_LOG_DIR"
---

<objective>
Purge all v1-v3 artifacts from the repository and relocate the sole surviving script.

Purpose: Create a clean slate with zero legacy code. The entire scripts/ directory, old lib/ shell files, old docs, old tests, systemd unit files, and PRD.md are deleted. The hook-event-logger.sh is the only script that survives — relocated to bin/ with self-contained bootstrapping (its dependency on lib/hook-preamble.sh and lib/hook-utils.sh is removed). SKILL.md and README.md are stripped to v4.0 skeletons.

Output: A repository with no v1-v3 hook scripts, no old lib, no old prompts, no dead docs, no dead tests, no systemd units, and a working logger at its new home in bin/.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cleanup/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete all v1-v3 artifacts</name>
  <files>
    scripts/ (entire directory)
    lib/hook-preamble.sh
    lib/hook-utils.sh
    docs/v3-retrospective.md
    docs/hooks.md
    tests/test-deliver-async-with-logging.sh
    tests/test-write-hook-event-record.sh
    systemd/ (entire directory)
    PRD.md
    config/recovery-registry.json.lock
  </files>
  <action>
    **Before deleting anything**, copy `scripts/hook-event-logger.sh` to a temporary location (e.g., `/tmp/hook-event-logger.sh`) so it is preserved for Task 2.

    Then delete all v1-v3 artifacts using `trash` (preferred) or `rm`:

    1. Delete the entire `scripts/` directory — this removes all 7 hook scripts (stop-hook.sh, notification-idle-hook.sh, notification-permission-hook.sh, pre-tool-use-hook.sh, post-tool-use-hook.sh, pre-compact-hook.sh, session-end-hook.sh), menu-driver.sh, diagnose-hooks.sh, register-hooks.sh, register-all-hooks-logger.sh, sync-recovery-registry-session-ids.sh, recover-openclaw-agents.sh, test-hook-prompts.sh, install.sh, spawn.sh, hook-event-logger.sh, and the entire prompts/ subdirectory

    2. Delete `lib/hook-preamble.sh` and `lib/hook-utils.sh` (the entire old lib contents — the lib/ directory itself stays as placeholder for Phase 2 shared lib)

    3. Delete `docs/v3-retrospective.md` and `docs/hooks.md` (the docs/ directory itself stays as placeholder)

    4. Delete `tests/test-deliver-async-with-logging.sh` and `tests/test-write-hook-event-record.sh` (the tests/ directory itself stays as placeholder)

    5. Delete the entire `systemd/` directory

    6. Delete `PRD.md` from project root

    7. Delete `config/recovery-registry.json.lock`

    After deletion, verify these directories still exist as empty placeholders: lib/, docs/, tests/. Create them if they were removed.
  </action>
  <verify>
    Run these checks — all must pass:
    ```bash
    # No scripts/ directory
    test ! -d scripts/ && echo "PASS: scripts/ gone" || echo "FAIL"
    # No old lib files
    test ! -f lib/hook-preamble.sh && test ! -f lib/hook-utils.sh && echo "PASS: old lib gone" || echo "FAIL"
    # No old docs
    test ! -f docs/v3-retrospective.md && test ! -f docs/hooks.md && echo "PASS: old docs gone" || echo "FAIL"
    # No old tests
    test ! -f tests/test-deliver-async-with-logging.sh && test ! -f tests/test-write-hook-event-record.sh && echo "PASS: old tests gone" || echo "FAIL"
    # No systemd
    test ! -d systemd/ && echo "PASS: systemd/ gone" || echo "FAIL"
    # No PRD.md
    test ! -f PRD.md && echo "PASS: PRD.md gone" || echo "FAIL"
    # No lock file
    test ! -f config/recovery-registry.json.lock && echo "PASS: lock gone" || echo "FAIL"
    # Placeholder dirs exist
    test -d lib/ && test -d docs/ && test -d tests/ && echo "PASS: placeholders exist" || echo "FAIL"
    # Logger preserved in temp
    test -f /tmp/hook-event-logger.sh && echo "PASS: logger preserved" || echo "FAIL"
    ```
  </verify>
  <done>
    All seven old hook scripts, menu-driver.sh, all utility scripts, the entire scripts/ directory, old lib files, old docs, old tests, systemd directory, PRD.md, and lock file are deleted. The lib/, docs/, and tests/ directories exist as empty placeholders. The hook-event-logger.sh is preserved in /tmp for relocation in Task 2.
  </done>
</task>

<task type="auto">
  <name>Task 2: Relocate logger to bin/ and strip SKILL.md and README.md to v4.0 skeletons</name>
  <files>
    bin/hook-event-logger.sh
    SKILL.md
    README.md
  </files>
  <action>
    **Part A: Relocate and refactor hook-event-logger.sh**

    1. Create the `bin/` directory
    2. Move `/tmp/hook-event-logger.sh` to `bin/hook-event-logger.sh`
    3. Refactor the script to remove its dependency on `lib/hook-preamble.sh`:
       - Remove the `source "$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)/hook-preamble.sh"` line
       - Add self-contained bootstrapping at the top (after `set -euo pipefail`):
         - Resolve SKILL_ROOT: `SKILL_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"`
         - Set SKILL_LOG_DIR: `SKILL_LOG_DIR="${SKILL_ROOT}/logs"`
         - Create logs dir: `mkdir -p "$SKILL_LOG_DIR" 2>/dev/null || true`
         - Define a local `debug_log()` function that writes to `"${SKILL_LOG_DIR}/hooks.log"` with timestamp and script name
       - Remove any references to `REGISTRY_PATH`, `HOOK_SCRIPT_NAME` from preamble, `SCRIPT_DIR` from preamble, and `_GSD_*` internal variables
       - Keep the script name as a local constant: `SCRIPT_NAME="hook-event-logger.sh"`
       - Update the `debug_log` calls to use `SCRIPT_NAME` instead of `HOOK_SCRIPT_NAME`
       - Keep ALL existing logging logic intact — the stdin consumption, event extraction, per-session log writing, and JSONL append with flock
    4. Make executable: `chmod +x bin/hook-event-logger.sh`
    5. The script header comment should say: `bin/hook-event-logger.sh` (not `scripts/hook-event-logger.sh`)

    **Part B: Strip SKILL.md to v4.0 skeleton**

    Replace SKILL.md entirely with a minimal skeleton:
    - Keep valid YAML frontmatter with updated metadata for v4.0 (name: gsd-code-skill, description updated for v4.0 event-driven architecture, metadata updated to reflect Node.js)
    - Body: brief 2-3 line description of v4.0 architecture (event-folder structure, handler + prompt per event, shared Node.js lib)
    - A "Scripts" section listing only `bin/hook-event-logger.sh` as the sole current script
    - A "Configuration" section mentioning `config/agent-registry.json` (the renamed registry)
    - Remove ALL v1-v3 content (quick start, lifecycle, hook descriptions, changelog sections)

    **Part C: Strip README.md to v4.0 skeleton**

    Replace README.md entirely with a minimal skeleton:
    - Title: `# gsd-code-skill`
    - One-line description: v4.0 event-driven hook system for Claude Code agent lifecycle management
    - A "Status" section noting v4.0 is under construction
    - A "Directory Structure" section showing the planned layout (bin/, lib/, events/, config/)
    - Remove ALL v1-v3 content (pre-flight checklist, registry schema, hook documentation, recovery runbook)
  </action>
  <verify>
    Run these checks:
    ```bash
    # Logger exists and is executable
    test -x bin/hook-event-logger.sh && echo "PASS: logger executable" || echo "FAIL"
    # Logger has no preamble dependency
    ! grep -q 'hook-preamble' bin/hook-event-logger.sh && echo "PASS: no preamble dep" || echo "FAIL"
    # Logger has self-contained bootstrapping
    grep -q 'SKILL_ROOT' bin/hook-event-logger.sh && echo "PASS: self-contained" || echo "FAIL"
    # Logger preserves core logging logic
    grep -q 'JSONL_RECORD' bin/hook-event-logger.sh && echo "PASS: JSONL logic preserved" || echo "FAIL"
    # SKILL.md has valid YAML frontmatter
    head -1 SKILL.md | grep -q '^---' && echo "PASS: SKILL.md frontmatter" || echo "FAIL"
    # SKILL.md mentions v4.0
    grep -q 'v4.0\|event-driven\|event-folder' SKILL.md && echo "PASS: SKILL.md v4.0" || echo "FAIL"
    # SKILL.md does NOT mention old scripts
    ! grep -q 'spawn.sh\|register-hooks.sh\|recover-openclaw-agents' SKILL.md && echo "PASS: no old refs" || echo "FAIL"
    # README.md is stripped
    ! grep -q 'Pre-Flight\|recovery-registry\|hook_settings' README.md && echo "PASS: README stripped" || echo "FAIL"
    ```
  </verify>
  <done>
    hook-event-logger.sh lives at bin/hook-event-logger.sh with self-contained bootstrapping (no dependency on deleted lib/hook-preamble.sh or lib/hook-utils.sh). SKILL.md has valid v4.0 YAML frontmatter and skeleton content with no v1-v3 references. README.md has v4.0 skeleton content with no v1-v3 references.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full phase-level success criteria for this plan:

```bash
cd /home/forge/.openclaw/workspace/skills/gsd-code-skill

# 1. No old hook scripts anywhere
for script in stop-hook.sh notification-idle-hook.sh notification-permission-hook.sh pre-tool-use-hook.sh post-tool-use-hook.sh pre-compact-hook.sh session-end-hook.sh; do
  test ! -f "scripts/$script" || echo "FAIL: $script still exists"
done
echo "PASS: all 7 hook scripts gone"

# 2. No old lib files
test ! -f lib/hook-preamble.sh && test ! -f lib/hook-utils.sh && echo "PASS: old lib gone"

# 3. No scripts/prompts/
test ! -d scripts/prompts && echo "PASS: prompts dir gone"

# 4. No dead docs/tests
test ! -f PRD.md && test ! -f docs/v3-retrospective.md && echo "PASS: dead docs gone"

# 5. No menu-driver.sh
test ! -f scripts/menu-driver.sh && echo "PASS: menu-driver gone"

# 6. Logger preserved and functional
test -x bin/hook-event-logger.sh && echo "PASS: logger preserved"
bash -n bin/hook-event-logger.sh && echo "PASS: logger syntax valid"

# 7. SKILL.md valid
head -1 SKILL.md | grep -q '^---' && echo "PASS: SKILL.md valid frontmatter"
```
</verification>

<success_criteria>
- The entire scripts/ directory is gone (all 7 hook scripts, menu-driver.sh, all utilities, prompts/)
- lib/hook-preamble.sh and lib/hook-utils.sh are gone
- docs/v3-retrospective.md and docs/hooks.md are gone
- tests/test-deliver-async-with-logging.sh and tests/test-write-hook-event-record.sh are gone
- systemd/ directory is gone
- PRD.md is gone
- config/recovery-registry.json.lock is gone
- bin/hook-event-logger.sh exists, is executable, has self-contained bootstrapping, passes bash -n syntax check
- SKILL.md has valid YAML frontmatter and v4.0 skeleton content
- README.md has v4.0 skeleton content
- Placeholder directories lib/, docs/, tests/ exist
</success_criteria>

<output>
After completion, create `.planning/phases/01-cleanup/01-01-SUMMARY.md`
</output>
