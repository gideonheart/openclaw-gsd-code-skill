---
phase: 07-registration-deployment-and-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/register-hooks.sh
  - scripts/session-end-hook.sh
autonomous: true
requirements:
  - REG-01
  - REG-02

must_haves:
  truths:
    - "Running register-hooks.sh adds PreToolUse hook with AskUserQuestion matcher to settings.json"
    - "New Claude Code sessions receive AskUserQuestion forwarding without manual configuration"
    - "When a session ends, /tmp pane state files for that session are deleted"
    - "Other sessions' /tmp state files remain untouched during cleanup"
  artifacts:
    - path: "scripts/register-hooks.sh"
      provides: "PreToolUse hook registration alongside existing 5 hooks"
      contains: "PreToolUse"
    - path: "scripts/session-end-hook.sh"
      provides: "Temp file cleanup after wake message delivery"
      contains: "gsd-pane-prev"
  key_links:
    - from: "scripts/register-hooks.sh"
      to: "~/.claude/settings.json"
      via: "jq merge of PreToolUse entry"
      pattern: "PreToolUse"
    - from: "scripts/session-end-hook.sh"
      to: "/tmp/gsd-pane-*"
      via: "rm -f of session-specific state files"
      pattern: "gsd-pane-prev.*SESSION_NAME"
---

<objective>
Register the PreToolUse hook in settings.json and add /tmp pane state file cleanup to session-end-hook.sh.

Purpose: Activate AskUserQuestion forwarding for all new Claude Code sessions and prevent /tmp state file accumulation across sessions.
Output: Updated register-hooks.sh with 6 hook events, updated session-end-hook.sh with cleanup section.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/register-hooks.sh
@scripts/session-end-hook.sh
@scripts/pre-tool-use-hook.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PreToolUse hook with AskUserQuestion matcher to register-hooks.sh</name>
  <files>scripts/register-hooks.sh</files>
  <action>
  Modify register-hooks.sh to include the PreToolUse hook for AskUserQuestion forwarding. Three changes required:

  1. **Add pre-tool-use-hook.sh to HOOK_SCRIPTS array** (pre-flight check section, around line 46-51):
     Add `"pre-tool-use-hook.sh"` to the existing HOOK_SCRIPTS array so the pre-flight check verifies it exists before registration.

  2. **Add PreToolUse entry to HOOKS_CONFIG JSON** (around line 77-134):
     Add a new `"PreToolUse"` key to the HOOKS_CONFIG heredoc, after the existing PreCompact entry. The entry follows the same pattern as Notification hooks (it has a matcher):
     ```json
     "PreToolUse": [
       {
         "matcher": "AskUserQuestion",
         "hooks": [
           {
             "type": "command",
             "command": "${SKILL_ROOT}/scripts/pre-tool-use-hook.sh",
             "timeout": 10
           }
         ]
       }
     ]
     ```
     Use timeout of 10 seconds (the hook backgrounds its work and exits immediately, unlike Stop/Notification which may do synchronous work). Per CONTEXT.md decision: short timeout ~10s.

  3. **Add PreToolUse to the jq merge command** (around line 145-163):
     Add `.hooks.PreToolUse = $new.PreToolUse |` to the jq filter alongside the existing Stop, Notification, SessionEnd, PreCompact lines.

  4. **Add PreToolUse verification output** (around line 190-211):
     Add a verification line after the PreCompact verification that checks and logs the PreToolUse hook:
     ```bash
     PRE_TOOL_USE=$(jq -r '.hooks.PreToolUse[] | select(.matcher == "AskUserQuestion") | .hooks[0].command // "NOT REGISTERED"' "$SETTINGS_FILE")
     log_message "PreToolUse (AskUserQuestion): $PRE_TOOL_USE"
     ```

  5. **Update the script header comment** (line 5):
     Change "Registers all 5 hook events" to "Registers all 6 hook events" and add "PreToolUse" to the list.

  6. **Update the SKILL.md reference comment** (line 239):
     Change the IMPORTANT message to say new hooks are registered, referencing all 6 events.

  Do NOT change any existing hook registration — only ADD the PreToolUse entry.
  </action>
  <verify>
  Run:
  - `bash -n scripts/register-hooks.sh` — syntax check passes
  - `grep -c 'PreToolUse' scripts/register-hooks.sh` — returns 4+ (HOOKS_CONFIG + jq merge + verification + at least one more)
  - `grep 'AskUserQuestion' scripts/register-hooks.sh` — returns the matcher entry
  - `grep 'pre-tool-use-hook.sh' scripts/register-hooks.sh` — appears in both HOOK_SCRIPTS array and HOOKS_CONFIG
  - `grep 'timeout.*10' scripts/register-hooks.sh` — 10s timeout for PreToolUse
  </verify>
  <done>register-hooks.sh adds PreToolUse with AskUserQuestion matcher to settings.json alongside existing 5 hooks, with pre-flight check and verification output.</done>
</task>

<task type="auto">
  <name>Task 2: Add /tmp pane state file cleanup to session-end-hook.sh</name>
  <files>scripts/session-end-hook.sh</files>
  <action>
  Add a cleanup section to session-end-hook.sh that removes THIS session's pane state files AFTER the wake message delivery (section 6). Per CONTEXT.md decisions:

  1. **Add section 7 after delivery** (after the existing `exit 0` on line 87, but before it):
     Insert a new numbered section between the delivery section (section 6) and the final exit:
     ```bash
     # 7. Clean up /tmp pane state files for THIS session only
     # Only this session's files — other sessions may still be running
     # rm -f: silent if files don't exist (pane diff fallback may never have triggered)
     rm -f "/tmp/gsd-pane-prev-${SESSION_NAME}.txt"
     rm -f "/tmp/gsd-pane-lock-${SESSION_NAME}"
     debug_log "Cleaned up /tmp pane state files for session=$SESSION_NAME"
     ```

  Place cleanup AFTER the backgrounded openclaw delivery call (line 84-85) but BEFORE the final `exit 0` (line 87). The delivery is backgrounded so cleanup runs without waiting.

  CRITICAL: Only clean up files for THIS session (`${SESSION_NAME}`). Do NOT use glob patterns like `/tmp/gsd-pane-*` which would affect other running sessions.
  </action>
  <verify>
  Run:
  - `bash -n scripts/session-end-hook.sh` — syntax check passes
  - `grep 'gsd-pane-prev' scripts/session-end-hook.sh` — cleanup targets the prev file
  - `grep 'gsd-pane-lock' scripts/session-end-hook.sh` — cleanup targets the lock file
  - `grep 'rm -f' scripts/session-end-hook.sh` — uses silent removal
  - `grep 'SESSION_NAME' scripts/session-end-hook.sh` — cleanup is session-specific (not globbed)
  </verify>
  <done>session-end-hook.sh cleans up /tmp/gsd-pane-prev-{session}.txt and /tmp/gsd-pane-lock-{session} on session exit, after delivery, using rm -f for silent failure.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/register-hooks.sh && bash -n scripts/session-end-hook.sh` — both pass syntax check
2. `grep -q 'PreToolUse' scripts/register-hooks.sh` — PreToolUse hook is registered
3. `grep -q 'AskUserQuestion' scripts/register-hooks.sh` — matcher is AskUserQuestion
4. `grep -q 'pre-tool-use-hook.sh' scripts/register-hooks.sh` — script path in pre-flight and config
5. `grep -q 'gsd-pane-prev' scripts/session-end-hook.sh` — cleanup targets state files
6. `grep -q 'rm -f' scripts/session-end-hook.sh` — uses silent removal
</verification>

<success_criteria>
- register-hooks.sh registers PreToolUse with AskUserQuestion matcher alongside all existing hooks
- Pre-flight check verifies pre-tool-use-hook.sh exists before registration
- Verification output shows PreToolUse registration status
- session-end-hook.sh removes session-specific /tmp pane state files after delivery
- No glob-based cleanup (only THIS session's files)
- Both scripts pass bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/07-registration-deployment-and-documentation/07-01-SUMMARY.md`
</output>
