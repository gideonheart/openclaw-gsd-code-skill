---
phase: 07-registration-deployment-and-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - SKILL.md
  - docs/hooks.md
autonomous: true
requirements:
  - DOCS-03

must_haves:
  truths:
    - "SKILL.md documents pre-tool-use-hook.sh in the Hooks section"
    - "SKILL.md documents lib/hook-utils.sh as a shared library"
    - "SKILL.md notes minimum Claude Code version >= 2.0.76"
    - "SKILL.md documents the v2 wake format change as a breaking change"
    - "docs/hooks.md documents pre-tool-use-hook.sh with full behavior spec"
    - "docs/hooks.md documents v2 content extraction (transcript primary, pane diff fallback)"
  artifacts:
    - path: "SKILL.md"
      provides: "Agent-facing documentation with v2.0 architecture"
      contains: "pre-tool-use-hook.sh"
    - path: "docs/hooks.md"
      provides: "Hook behavior specifications including PreToolUse and v2 format"
      contains: "pre-tool-use-hook.sh"
  key_links:
    - from: "SKILL.md"
      to: "docs/hooks.md"
      via: "Reference to load docs/hooks.md for details"
      pattern: "docs/hooks.md"
    - from: "SKILL.md"
      to: "lib/hook-utils.sh"
      via: "Shared Libraries listing"
      pattern: "hook-utils.sh"
---

<objective>
Update SKILL.md and docs/hooks.md to document the v2.0 architecture: PreToolUse hook, shared library, v2 wake format, and minimum Claude Code version.

Purpose: Agents and operators understand the new v2.0 hook architecture, content extraction chain, and breaking changes.
Output: Updated SKILL.md with v2 references, updated docs/hooks.md with PreToolUse spec and v2 format details.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@SKILL.md
@docs/hooks.md
@lib/hook-utils.sh
@scripts/pre-tool-use-hook.sh
@scripts/stop-hook.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SKILL.md with v2.0 architecture documentation</name>
  <files>SKILL.md</files>
  <action>
  Update SKILL.md with the following changes. Maintain the existing progressive disclosure style (concise hooks section, point to docs/hooks.md for details).

  1. **Update the Hooks section** (around line 86-103):
     Add `pre-tool-use-hook.sh` entry after `pre-compact-hook.sh`:
     ```
     **pre-tool-use-hook.sh** - Fires when Claude calls AskUserQuestion (forwards structured question data to OpenClaw)
     ```
     Update register-hooks.sh description to say "all 6 hook events" instead of "all 5 hook events". Add "PreToolUse [AskUserQuestion]" to the parenthetical list.

  2. **Add a Shared Libraries subsection** after the Hooks subsection and before Utilities:
     ```
     ### Shared Libraries

     **lib/hook-utils.sh** - Shared extraction functions sourced by stop-hook.sh and pre-tool-use-hook.sh

     Contains: `extract_last_assistant_response`, `extract_pane_diff`, `format_ask_user_questions`. No side effects on source.
     ```

  3. **Add a v2.0 Breaking Changes section** before the Notes section (around line 150):
     ```
     ## v2.0 Changes

     **Wake message format (breaking):** `[PANE CONTENT]` replaced by `[CONTENT]` section. Content is now extracted from Claude's transcript JSONL (primary) or pane diff (fallback) instead of raw pane dump. Downstream parsers expecting `[PANE CONTENT]` must update to `[CONTENT]`.

     **Content extraction chain:** transcript text (from `transcript_path` JSONL) -> pane diff (only new lines) -> raw pane tail (last 10 lines). First successful extraction wins.

     **AskUserQuestion forwarding:** When Claude calls AskUserQuestion, a PreToolUse hook sends structured question data to OpenClaw before the TUI renders. This is async and never blocks.

     **Minimum Claude Code version:** >= 2.0.76 (PreToolUse hook support and AskUserQuestion bug fix).
     ```

  4. **Update the "All hooks" bullet list** (around line 101-103):
     Add a note that PreToolUse hook is async-only (no bidirectional mode).

  Keep the progressive disclosure style — details go in docs/hooks.md, SKILL.md stays concise.
  </action>
  <verify>
  Run:
  - `grep 'pre-tool-use-hook.sh' SKILL.md` — listed in hooks section
  - `grep 'hook-utils.sh' SKILL.md` — shared library documented
  - `grep '2.0.76' SKILL.md` — minimum version noted
  - `grep '\[CONTENT\]' SKILL.md` — v2 wake format documented
  - `grep 'Breaking\|breaking' SKILL.md` — breaking change noted
  - `grep 'lib/' SKILL.md` — shared libraries section exists
  </verify>
  <done>SKILL.md documents pre-tool-use-hook.sh, lib/hook-utils.sh, v2 wake format, content extraction chain, AskUserQuestion forwarding, and minimum Claude Code version >= 2.0.76.</done>
</task>

<task type="auto">
  <name>Task 2: Update docs/hooks.md with PreToolUse spec and v2 format details</name>
  <files>docs/hooks.md</files>
  <action>
  Update docs/hooks.md with two additions. Follow the existing document structure and style precisely.

  1. **Add pre-tool-use-hook.sh spec** as a new section under "Wake Hooks" (after notification-permission-hook.sh, before the "Lifecycle Hooks" heading). Follow the exact same structure as the other hook specs:

     ```markdown
     ---

     ## pre-tool-use-hook.sh

     **Trigger:** Fires when Claude calls AskUserQuestion (PreToolUse event with `AskUserQuestion` matcher)

     **What It Does:**

     1. Consume stdin JSON to prevent pipe blocking
     2. Check `$TMUX` environment (exit if not in tmux)
     3. Extract tmux session name via `tmux display-message -p '#S'`
     4. Lookup agent entry in registry by matching `tmux_session_name`
     5. Exit if no match (non-managed session)
     6. Extract `tool_input` from stdin JSON (contains question data)
     7. Source `lib/hook-utils.sh` and call `format_ask_user_questions` to format structured question data
     8. Build wake message with `[ASK USER QUESTION]` section containing formatted questions, options, and multi-select flags
     9. Deliver wake message asynchronously (always backgrounded, never blocks TUI)
     10. Exit 0 (never denies AskUserQuestion — notification-only)

     **Configuration (hook_settings):**

     None. PreToolUse hook ignores `hook_mode` (always async, never bidirectional). Timeout: 10s in settings.json.

     **Edge Cases:**

     - Always exits 0 — non-zero exit or JSON output to stdout would block AskUserQuestion from rendering in the TUI
     - No `stop_hook_active` check (PreToolUse doesn't recurse)
     - No pane capture (question data comes from `tool_input` in stdin, not from tmux pane)
     - If `lib/hook-utils.sh` is missing, exits 0 with debug log (graceful degradation)
     - No bidirectional mode — AskUserQuestion forwarding is always notification-only

     **Exit Time:** <5ms for non-managed sessions, ~20-50ms for managed sessions

     **Related Registry Fields:** `tmux_session_name`, `agent_id`, `openclaw_session_id`
     ```

  2. **Add a v2 Content Extraction section** at the bottom of the document, before Troubleshooting. New top-level section:

     ```markdown
     ---

     # v2 Content Extraction (stop-hook.sh)

     As of v2.0, stop-hook.sh extracts clean content instead of sending raw pane dumps.

     ## Extraction Chain

     The stop hook uses a three-tier fallback to populate the `[CONTENT]` section:

     1. **Transcript extraction (primary):** Reads `transcript_path` from stdin JSON, calls `extract_last_assistant_response` from `lib/hook-utils.sh`. Uses `tail -40` of the JSONL file with `jq` type-filtered selection to get Claude's last text response. No ANSI codes, no pane noise.

     2. **Pane diff (fallback):** If transcript extraction returns empty (file missing, parse error), calls `extract_pane_diff` from `lib/hook-utils.sh`. Compares current `tail -40` of pane content against previous capture stored in `/tmp/gsd-pane-prev-{session}.txt`. Sends only new/added lines using `diff --new-line-format='%L'`. Uses `flock` on `/tmp/gsd-pane-lock-{session}` for atomic read-write.

     3. **Raw pane tail (ultimate fallback):** If lib/hook-utils.sh cannot be sourced, falls back to `tail -40` of raw pane content.

     ## Shared Library

     `lib/hook-utils.sh` contains three functions:

     | Function | Used By | Purpose |
     |----------|---------|---------|
     | `extract_last_assistant_response` | stop-hook.sh | JSONL transcript text extraction |
     | `extract_pane_diff` | stop-hook.sh | Per-session pane line delta |
     | `format_ask_user_questions` | pre-tool-use-hook.sh | AskUserQuestion data formatting |

     The library is sourced (not executed) — no side effects, no output on source.

     ## Wake Format v2

     Section order: `[SESSION IDENTITY]`, `[TRIGGER]`, `[CONTENT]`, `[STATE HINT]`, `[CONTEXT PRESSURE]`, `[AVAILABLE ACTIONS]`

     **Breaking change:** `[PANE CONTENT]` (v1) replaced by `[CONTENT]` (v2). Downstream parsers must update.

     ## Temp File Lifecycle

     Per-session state files in `/tmp`:
     - `gsd-pane-prev-{session}.txt` — last pane capture (written by `extract_pane_diff`)
     - `gsd-pane-lock-{session}` — flock file for atomic diff operations

     Files are cleaned up by `session-end-hook.sh` when the Claude Code session terminates. No stale files accumulate across sessions.
     ```

  Maintain the existing formatting style: `---` separators between major sections, markdown headings, code-style backtick formatting for file names and commands.
  </action>
  <verify>
  Run:
  - `grep 'pre-tool-use-hook.sh' docs/hooks.md` — PreToolUse hook spec present
  - `grep 'AskUserQuestion' docs/hooks.md` — matcher documented
  - `grep 'Extraction Chain' docs/hooks.md` — v2 extraction section present
  - `grep 'hook-utils.sh' docs/hooks.md` — shared library documented
  - `grep '\[CONTENT\]' docs/hooks.md` — v2 format documented
  - `grep 'gsd-pane-prev' docs/hooks.md` — temp file lifecycle documented
  - `grep 'Breaking\|breaking' docs/hooks.md` — breaking change noted
  </verify>
  <done>docs/hooks.md includes full PreToolUse hook behavior spec, v2 content extraction chain documentation, shared library reference, wake format v2 details, and temp file lifecycle.</done>
</task>

</tasks>

<verification>
1. `grep 'pre-tool-use-hook.sh' SKILL.md docs/hooks.md` — documented in both files
2. `grep 'hook-utils.sh' SKILL.md docs/hooks.md` — shared library documented in both files
3. `grep '2.0.76' SKILL.md` — minimum version in SKILL.md
4. `grep 'Extraction Chain' docs/hooks.md` — v2 extraction documented
5. `grep '\[CONTENT\]' SKILL.md docs/hooks.md` — v2 wake format in both
6. `grep 'breaking' SKILL.md docs/hooks.md` — breaking change noted in both
</verification>

<success_criteria>
- SKILL.md lists pre-tool-use-hook.sh in hooks section with one-line description
- SKILL.md has Shared Libraries subsection with lib/hook-utils.sh
- SKILL.md has v2.0 Breaking Changes section with format change, extraction chain, AskUserQuestion forwarding, and minimum version
- docs/hooks.md has full PreToolUse hook behavior spec matching existing spec format
- docs/hooks.md has v2 Content Extraction section with extraction chain, shared library table, wake format v2, and temp file lifecycle
- Progressive disclosure maintained: SKILL.md concise, docs/hooks.md detailed
</success_criteria>

<output>
After completion, create `.planning/phases/07-registration-deployment-and-documentation/07-02-SUMMARY.md`
</output>
