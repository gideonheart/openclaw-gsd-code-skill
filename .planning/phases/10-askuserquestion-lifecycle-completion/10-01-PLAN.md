---
phase: 10-askuserquestion-lifecycle-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/pre-tool-use-hook.sh
  - scripts/post-tool-use-hook.sh
  - scripts/register-hooks.sh
autonomous: true
requirements: [ASK-05, ASK-06]

must_haves:
  truths:
    - "PreToolUse JSONL record contains tool_use_id field extracted from stdin JSON"
    - "PostToolUse hook fires after AskUserQuestion completes and emits JSONL record with answer_selected and tool_use_id fields"
    - "PostToolUse hook registered in settings.json via register-hooks.sh with AskUserQuestion matcher"
    - "PreToolUse and PostToolUse JSONL records share the same tool_use_id value for the same AskUserQuestion invocation, enabling lifecycle linking"
    - "PostToolUse hook logs raw stdin for empirical validation of tool_response structure"
  artifacts:
    - path: "scripts/pre-tool-use-hook.sh"
      provides: "tool_use_id extraction and inclusion in JSONL extra_fields_json"
      contains: "tool_use_id"
    - path: "scripts/post-tool-use-hook.sh"
      provides: "PostToolUse hook for AskUserQuestion answer logging"
      contains: "answer_selected"
    - path: "scripts/register-hooks.sh"
      provides: "PostToolUse hook registration alongside PreToolUse"
      contains: "PostToolUse"
  key_links:
    - from: "scripts/pre-tool-use-hook.sh"
      to: "JSONL record"
      via: "EXTRA_FIELDS_JSON with tool_use_id field"
      pattern: "tool_use_id.*EXTRA_FIELDS_JSON"
    - from: "scripts/post-tool-use-hook.sh"
      to: "lib/hook-utils.sh"
      via: "deliver_async_with_logging with extra_fields_json containing tool_use_id and answer_selected"
      pattern: "deliver_async_with_logging"
    - from: "scripts/register-hooks.sh"
      to: "~/.claude/settings.json"
      via: "PostToolUse section in HOOKS_CONFIG with AskUserQuestion matcher"
      pattern: "PostToolUse.*AskUserQuestion"
---

<objective>
Complete the AskUserQuestion lifecycle audit trail by adding tool_use_id to PreToolUse JSONL records and creating a PostToolUse hook that logs which answer was selected after AskUserQuestion completes.

Purpose: Enable question-to-answer lifecycle linking via shared tool_use_id between PreToolUse and PostToolUse JSONL records. After this plan, every AskUserQuestion invocation produces two linked JSONL records: one when the question is forwarded (PreToolUse) and one when the answer is submitted (PostToolUse).
Output: Modified pre-tool-use-hook.sh with tool_use_id, new post-tool-use-hook.sh, updated register-hooks.sh with PostToolUse registration.
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-askuserquestion-lifecycle-completion/10-RESEARCH.md
@.planning/phases/09-hook-script-migration/09-02-SUMMARY.md

# Key source files to read before implementing:
@scripts/pre-tool-use-hook.sh
@scripts/register-hooks.sh
@lib/hook-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tool_use_id extraction to pre-tool-use-hook.sh JSONL record</name>
  <files>scripts/pre-tool-use-hook.sh</files>
  <action>
Modify `scripts/pre-tool-use-hook.sh` to extract `tool_use_id` from stdin JSON and include it in the JSONL record via `extra_fields_json`. This satisfies the PreToolUse side of ASK-06 (lifecycle linking).

Specific changes in section 5 ("EXTRACT tool_input FROM STDIN JSON"), add after the existing `TOOL_INPUT` extraction line (`TOOL_INPUT=$(printf '%s' "$STDIN_JSON" | jq ...)`):

```bash
TOOL_USE_ID=$(printf '%s' "$STDIN_JSON" | jq -r '.tool_use_id // ""' 2>/dev/null || echo "")
debug_log "tool_use_id=$TOOL_USE_ID"
```

Then in section 8 ("ASYNC DELIVERY"), change the existing `EXTRA_FIELDS_JSON` construction from:
```bash
EXTRA_FIELDS_JSON=$(jq -cn --arg questions_forwarded "$FORMATTED_QUESTIONS" '{"questions_forwarded": $questions_forwarded}')
```
to:
```bash
EXTRA_FIELDS_JSON=$(jq -cn \
  --arg questions_forwarded "$FORMATTED_QUESTIONS" \
  --arg tool_use_id "$TOOL_USE_ID" \
  '{"questions_forwarded": $questions_forwarded, "tool_use_id": $tool_use_id}')
```

CRITICAL: Do NOT remove the existing `questions_forwarded` field. The modification EXTENDS the JSON object, it does not replace it. This preserves ASK-04 (shipped in Phase 9).

Do NOT change any other part of the file. The rest of the hook script (guards, registry lookup, wake message, delivery call) remains identical.
  </action>
  <verify>
1. `grep -c 'tool_use_id' scripts/pre-tool-use-hook.sh` returns 3 or more (extraction line, debug_log line, EXTRA_FIELDS_JSON line)
2. `grep 'questions_forwarded' scripts/pre-tool-use-hook.sh` still shows the field is present (ASK-04 not regressed)
3. `bash -n scripts/pre-tool-use-hook.sh` exits 0 (valid syntax)
  </verify>
  <done>pre-tool-use-hook.sh extracts tool_use_id from stdin JSON and includes both questions_forwarded AND tool_use_id in EXTRA_FIELDS_JSON. ASK-04 preserved, ASK-06 PreToolUse side satisfied.</done>
</task>

<task type="auto">
  <name>Task 2: Create post-tool-use-hook.sh for AskUserQuestion answer logging</name>
  <files>scripts/post-tool-use-hook.sh</files>
  <action>
Create a new `scripts/post-tool-use-hook.sh` following the established hook script skeleton (identical to pre-tool-use-hook.sh structure). This hook fires AFTER AskUserQuestion completes and logs the answer selected.

The script follows the exact same 8-section structure as all other hook scripts:

1. **Preamble** — shebang, set flags, SKILL_LOG_DIR resolution, shared GSD_HOOK_LOG, HOOK_SCRIPT_NAME, debug_log function, "FIRED" log line
2. **Source lib** — SCRIPT_DIR, LIB_PATH, source hook-utils.sh BEFORE guards
3. **Section 1: Consume stdin** — `STDIN_JSON=$(cat)`, `HOOK_ENTRY_MS=$(date +%s%3N)`, log raw stdin for empirical validation: `debug_log "raw_stdin: $(printf '%s' "$STDIN_JSON" | jq -c '.' 2>/dev/null || echo "$STDIN_JSON")"` (this is intentionally verbose for Phase 10 empirical validation of tool_response schema; can be reduced to byte count in a future phase)
4. **Section 2: TMUX guard** — exit 0 if `${TMUX:-}` is empty
5. **Section 3: Session name** — `tmux display-message -p '#S'`, redirect to per-session log and JSONL file
6. **Section 4: Registry lookup** — `lookup_agent_in_registry`, extract AGENT_ID and OPENCLAW_SESSION_ID
7. **Section 5: Extract tool_use_id and tool_response from stdin** — `TOOL_USE_ID=$(printf '%s' "$STDIN_JSON" | jq -r '.tool_use_id // ""' 2>/dev/null || echo "")`. For answer extraction, use the defensive multi-shape extractor that handles both object and string tool_response: `ANSWER_SELECTED=$(printf '%s' "$STDIN_JSON" | jq -r '.tool_response | if type == "object" then (.content // .text // (. | tostring)) elif type == "string" then . else "" end' 2>/dev/null || echo "")`. Log lengths for debugging.
8. **Section 6: Build wake message** — `[SESSION IDENTITY]`, `[TRIGGER] type: ask_user_question_answered`, `[ANSWER SELECTED]` section with tool_use_id and answer text, `[STATE HINT] state: answer_submitted`
9. **Section 7: Async delivery** — TRIGGER="ask_user_question_answered", STATE="answer_submitted", CONTENT_SOURCE="tool_response". Build EXTRA_FIELDS_JSON with tool_use_id and answer_selected via `jq -cn --arg`. Call `deliver_async_with_logging` with all params including EXTRA_FIELDS_JSON. Log delivery. Exit 0.

Key differences from pre-tool-use-hook.sh:
- Extracts `tool_response` instead of `tool_input` for answer data
- Also extracts `tool_use_id` (shared with PreToolUse for lifecycle linking)
- EXTRA_FIELDS_JSON contains `{"tool_use_id": ..., "answer_selected": ...}` instead of `{"questions_forwarded": ...}`
- Trigger is `ask_user_question_answered` not `ask_user_question`
- State is `answer_submitted` not `awaiting_user_input`
- Content source is `tool_response` not `questions`
- Always async — no bidirectional branch (PostToolUse fires AFTER tool ran; cannot block)
- Raw stdin logged for empirical validation of tool_response schema (ASK-05 requirement: "empirically validated before schema is committed")

NOTE on "how TUI was controlled" (ASK-05 wording): The menu-driver command is executed by OpenClaw agent (Gideon) externally to Claude Code. The PostToolUse hook only sees the final answer text, not the tmux key sequence. The JSONL record satisfies ASK-05 by recording what answer was selected; the TUI control aspect is implicit from the answer (choose N for option N). This is documented in the research open questions section.

Make the file executable: `chmod +x scripts/post-tool-use-hook.sh`
  </action>
  <verify>
1. `test -x scripts/post-tool-use-hook.sh` exits 0 (file exists and is executable)
2. `bash -n scripts/post-tool-use-hook.sh` exits 0 (valid syntax)
3. `grep 'source.*hook-utils.sh' scripts/post-tool-use-hook.sh` shows lib is sourced
4. `grep 'deliver_async_with_logging' scripts/post-tool-use-hook.sh` shows async delivery pattern
5. `grep 'tool_use_id' scripts/post-tool-use-hook.sh` shows lifecycle linking field
6. `grep 'answer_selected' scripts/post-tool-use-hook.sh` shows answer field
7. `grep 'raw_stdin' scripts/post-tool-use-hook.sh` shows empirical validation logging
8. `grep -c 'exit 0' scripts/post-tool-use-hook.sh` returns 3+ (guard exits + final exit)
  </verify>
  <done>post-tool-use-hook.sh exists, is executable, follows the established hook skeleton, sources lib/hook-utils.sh before guards, extracts tool_use_id and answer_selected from stdin, logs raw stdin for empirical validation, and delivers asynchronously via deliver_async_with_logging with JSONL logging.</done>
</task>

<task type="auto">
  <name>Task 3: Register PostToolUse hook in register-hooks.sh</name>
  <files>scripts/register-hooks.sh</files>
  <action>
Modify `scripts/register-hooks.sh` to register the PostToolUse hook alongside the existing PreToolUse hook. Three changes needed:

**Change 1: Add post-tool-use-hook.sh to HOOK_SCRIPTS array** (around line 46-53)

Add `"post-tool-use-hook.sh"` to the existing `HOOK_SCRIPTS` array. This ensures the script existence validation catches missing files before modifying settings.json. Update the comment above the array from "Verify all 5 hook scripts exist" to "Verify all hook scripts exist" (the count was already stale at "5" when there are 6 entries; removing the number avoids future staleness).

**Change 2: Add PostToolUse section to HOOKS_CONFIG heredoc** (after the PreToolUse section, before the closing `}`)

Add a comma after the PreToolUse closing `]` and add:
```json
  "PostToolUse": [
    {
      "matcher": "AskUserQuestion",
      "hooks": [
        {
          "type": "command",
          "command": "${SKILL_ROOT}/scripts/post-tool-use-hook.sh",
          "timeout": 10
        }
      ]
    }
  ]
```

Timeout is 10 (same as PreToolUse — hook backgrounds immediately, 10s covers script execution itself).

**Change 3: Add PostToolUse to jq merge** (around line 158-166)

Add `.hooks.PostToolUse = $new.PostToolUse |` to the jq merge expression, alongside the existing `.hooks.PreToolUse = $new.PreToolUse |` line.

**Change 4: Add PostToolUse verification output** (after the PreToolUse verification block around line 228-229)

Add:
```bash
# PostToolUse hook (AskUserQuestion)
POST_TOOL_USE=$(jq -r '.hooks.PostToolUse[] | select(.matcher == "AskUserQuestion") | .hooks[0].command // "NOT REGISTERED"' "$SETTINGS_FILE")
log_message "PostToolUse (AskUserQuestion): $POST_TOOL_USE"
```

Also update the top comment from "Registers all 6 hook events" to "Registers all 7 hook events" (Stop, Notification idle, Notification permission, SessionEnd, PreCompact, PreToolUse, PostToolUse).
  </action>
  <verify>
1. `bash -n scripts/register-hooks.sh` exits 0 (valid syntax)
2. `grep 'post-tool-use-hook.sh' scripts/register-hooks.sh` appears in both HOOK_SCRIPTS array and HOOKS_CONFIG heredoc
3. `grep 'PostToolUse' scripts/register-hooks.sh` appears in HOOKS_CONFIG, jq merge, and verification sections
4. `grep -c 'PostToolUse' scripts/register-hooks.sh` returns 4+ (config, merge, verification variable, verification log)
5. Run `bash scripts/register-hooks.sh` in a test context to verify it produces valid settings.json with the PostToolUse entry (the script handles this via atomic backup-validate-replace)
  </verify>
  <done>register-hooks.sh validates post-tool-use-hook.sh exists, registers PostToolUse with AskUserQuestion matcher in settings.json, merges it via jq alongside all other hooks, and verifies registration in output summary. Running the script adds PostToolUse to new Claude Code sessions.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/pre-tool-use-hook.sh && echo "OK"` — syntax valid
2. `bash -n scripts/post-tool-use-hook.sh && echo "OK"` — syntax valid
3. `bash -n scripts/register-hooks.sh && echo "OK"` — syntax valid
4. `grep 'tool_use_id' scripts/pre-tool-use-hook.sh | wc -l` — 3+ occurrences (extraction, debug, extra_fields)
5. `grep 'questions_forwarded' scripts/pre-tool-use-hook.sh` — ASK-04 field preserved
6. `grep 'tool_use_id' scripts/post-tool-use-hook.sh | wc -l` — 3+ occurrences
7. `grep 'answer_selected' scripts/post-tool-use-hook.sh | wc -l` — 2+ occurrences
8. `grep 'raw_stdin' scripts/post-tool-use-hook.sh` — empirical validation logging present
9. `grep 'PostToolUse' scripts/register-hooks.sh | wc -l` — 4+ occurrences (config, merge, verify var, verify log)
10. `test -x scripts/post-tool-use-hook.sh && echo "executable"` — file is executable
11. Lifecycle linking: both scripts extract `.tool_use_id` from stdin using identical jq pattern — confirms shared identifier for JSONL correlation
</verification>

<success_criteria>
- PreToolUse JSONL records now contain `tool_use_id` field alongside existing `questions_forwarded` (ASK-06 PreToolUse side)
- PostToolUse hook exists, follows established skeleton, emits JSONL with `answer_selected` and `tool_use_id` (ASK-05)
- PostToolUse hook logs raw stdin for empirical validation of tool_response schema (ASK-05 empirical requirement)
- PostToolUse registered in settings.json via register-hooks.sh with AskUserQuestion matcher
- Both PreToolUse and PostToolUse records share `tool_use_id` enabling `jq 'select(.tool_use_id == $id)'` lifecycle queries (ASK-06)
- All three modified scripts pass `bash -n` syntax check
- No regression to ASK-04 (questions_forwarded field still present in PreToolUse)
</success_criteria>

<output>
After completion, create `.planning/phases/10-askuserquestion-lifecycle-completion/10-01-SUMMARY.md`
</output>
</plan_format>
