---
phase: 03-launcher-updates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/recover-openclaw-agents.sh
autonomous: true
requirements:
  - RECOVER-01
  - RECOVER-02

must_haves:
  truths:
    - "recover-openclaw-agents.sh reads system_prompt per agent from registry and passes it via --append-system-prompt when launching Claude"
    - "recover-openclaw-agents.sh falls back to config/default-system-prompt.txt when agent has no system_prompt field"
    - "recover-openclaw-agents.sh uses jq for all registry parsing (no Python dependency)"
    - "recover-openclaw-agents.sh continues recovering remaining agents when one fails (no set -e abort)"
    - "recover-openclaw-agents.sh sends Telegram notification on failures only (silent on full success)"
    - "recover-openclaw-agents.sh retries once with short delay before reporting agent failure"
  artifacts:
    - path: "scripts/recover-openclaw-agents.sh"
      provides: "Registry-driven multi-agent recovery with per-agent system prompts and jq-only operations"
      min_lines: 200
      contains: "jq"
  key_links:
    - from: "scripts/recover-openclaw-agents.sh"
      to: "config/recovery-registry.json"
      via: "jq reads for agent list, system_prompt, config fields"
      pattern: "jq.*recovery-registry"
    - from: "scripts/recover-openclaw-agents.sh"
      to: "config/default-system-prompt.txt"
      via: "fallback prompt when agent has no system_prompt"
      pattern: "default-system-prompt"
    - from: "scripts/recover-openclaw-agents.sh"
      to: "claude --append-system-prompt"
      via: "system prompt passed during Claude launch"
      pattern: "append-system-prompt"
    - from: "scripts/recover-openclaw-agents.sh"
      to: "openclaw agent --message"
      via: "Telegram notification on recovery failures"
      pattern: "openclaw agent.*message"
---

<objective>
Rewrite recover-openclaw-agents.sh to use jq instead of Python for all registry operations, pass per-agent system prompts from registry to Claude on launch, and implement failure-only Telegram reporting.

Purpose: Replace all Python-based registry parsing with jq, add system prompt support to Claude launch command in recovery, implement one-retry-with-delay error handling per agent, and send Telegram notifications only on failures (silent on success per CONTEXT.md locked decision).

Output: Rewritten scripts/recover-openclaw-agents.sh
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-launcher-updates/03-CONTEXT.md
@.planning/phases/03-launcher-updates/03-RESEARCH.md
@config/recovery-registry.example.json
@config/default-system-prompt.txt
@scripts/recover-openclaw-agents.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite recover-openclaw-agents.sh with jq-only registry operations and system prompt support</name>
  <files>scripts/recover-openclaw-agents.sh</files>
  <action>
Rewrite scripts/recover-openclaw-agents.sh completely. The new script must follow these specifications exactly:

**Script header:** `#!/usr/bin/env bash` — do NOT use `set -euo pipefail` (per-agent error handling requires continuing on failures per CONTEXT.md). Instead use `set -uo pipefail` (no `-e`).

**CLI interface:**
```
recover-openclaw-agents.sh [--registry <path>] [--skip-session-id-sync]
```
- `--registry <path>`: Override default registry path.
- `--skip-session-id-sync`: Skip running sync-recovery-registry-session-ids.sh before recovery.
- Remove `--dry-run` flag (per CONTEXT.md: "No --dry-run mode -- keep recovery simple").

**Startup checks:**
- Verify jq exists (`command -v jq`) FIRST, before anything else. Clear error message if missing.
- Verify tmux exists.
- Verify openclaw exists.
- Do NOT require python3.

**Registry validation (CONTEXT.md failure handling):**
1. If registry file is missing: create fresh skeleton and continue.
2. If registry file exists but is not valid JSON (`jq empty` fails):
   - Back up corrupt file to `recovery-registry.json.corrupt-$(date +%s)` (timestamped, keep all backups).
   - Create fresh skeleton.
   - Send Telegram notification about corrupt registry via `openclaw agent --message` (async, backgrounded).
   - Continue with empty agent list.

**Registry parsing (jq only, no Python):**
Replace the entire `parse_registry_to_json_lines()` Python function with jq:
1. Read global fields: `global_status_openclaw_session_id` via `jq -r '.global_status_openclaw_session_id // ""'`.
2. Read agent list: `jq -c '.agents[] | select(.enabled == true and .auto_wake == true)'` to iterate enabled agents.
3. For each agent, extract fields with jq using `// ""` null coalescing for all optional string fields:
   - `agent_id`, `openclaw_session_id`, `working_directory`, `tmux_session_name`
   - `topic_id`, `claude_resume_target`, `claude_launch_command`, `claude_post_launch_mode`
   - `system_prompt` (NEW field, with `// ""` fallback)

Replace ALL `python3 -c 'import json,...'` inline calls in the main loop with jq field extraction from the already-parsed JSON line.

**System prompt composition per agent (CONTEXT.md locked decision: REPLACEMENT model):**
For each agent being recovered:
1. Read agent's `system_prompt` from parsed registry entry.
2. If non-empty: use it as final prompt (replaces default entirely).
3. If empty: read `$SKILL_ROOT/config/default-system-prompt.txt` as final prompt.
4. Modify `ensure_claude_is_running_in_tmux` to accept system prompt and append `--append-system-prompt <escaped-prompt>` to the launch command. Use `printf %q` for safe escaping.

**Per-agent error handling with retry:**
- Do NOT use `set -e` anywhere in the script.
- For each agent, wrap the entire recovery sequence in error handling.
- On first failure of any step (tmux session, Claude launch, post-launch command, OpenClaw wake):
  - Wait 3 seconds (short delay per CONTEXT.md).
  - Retry the failed step once.
  - If retry also fails: record failure with diagnostic detail (agent name, step that failed, error context).
  - Continue to next agent regardless.

**Tmux session handling (CONTEXT.md failure handling):**
- If tmux server is not running: start it automatically with `tmux start-server`.
- Session name conflict: append `-2` suffix (same pattern as spawn.sh). Do NOT kill existing sessions.
- When agent is marked 'running' but tmux session is gone: re-spawn immediately (no intermediate state per CONTEXT.md).

**Recovery reporting (CONTEXT.md locked decision: failures only):**
- On full success (all agents recovered): stdout log only, NO Telegram notification. Silent success.
- On any failure: build diagnostic summary with per-agent detail:
  ```
  Recovery failures:
  - gideon: tmux session creation failed (retry exhausted)
  - forge: Claude launch not confirmed after retry
  ```
- Send failure summary via: `openclaw agent --session-id "$global_session_id" --message "$failure_summary" >/dev/null 2>&1 &` (async, backgrounded).
- Always log full summary to stdout regardless of success/failure.

**Functions to KEEP (adapt for jq):**
- `ensure_tmux_session_exists()` — remove dry_run parameter, add tmux server auto-start
- `ensure_claude_is_running_in_tmux()` — remove dry_run parameter, add system_prompt parameter for --append-system-prompt
- `send_deterministic_claude_post_launch_command()` — remove dry_run parameter
- `wait_for_agent_resume_and_apply_fallback_if_stuck()` — remove dry_run parameter
- `send_recovery_instruction_to_openclaw_session()` — remove dry_run parameter

**Functions to DELETE:**
- `parse_registry_to_json_lines()` — Python-based, replaced by inline jq in main loop
- All `python3` inline calls in the main loop

**Code to DELETE:**
- `--dry-run` flag and all dry_run_enabled logic throughout
- `require_binary python3` check
- All `python3 -c` inline calls

**Naming conventions per CLAUDE.md:**
- All function names must be self-explanatory, NO abbreviations
- All variable names must be self-explanatory, NO abbreviations
- Script must be DRY and follow SRP
  </action>
  <verify>
Run these checks:
1. `bash -n scripts/recover-openclaw-agents.sh` — syntax validation passes
2. `grep -c 'python3\|python ' scripts/recover-openclaw-agents.sh` — returns 0 (no Python)
3. `grep -c 'dry.run\|dry_run' scripts/recover-openclaw-agents.sh` — returns 0 (no dry-run)
4. `grep -c 'jq ' scripts/recover-openclaw-agents.sh` — returns non-zero (jq is used)
5. `grep -c 'append-system-prompt' scripts/recover-openclaw-agents.sh` — returns non-zero
6. `grep -c 'default-system-prompt' scripts/recover-openclaw-agents.sh` — returns non-zero
7. `grep -c 'system_prompt' scripts/recover-openclaw-agents.sh` — returns non-zero
8. `grep -c 'openclaw agent' scripts/recover-openclaw-agents.sh` — returns non-zero (Telegram notification)
9. `grep 'set -' scripts/recover-openclaw-agents.sh | head -1` — shows `set -uo pipefail` (no -e)
10. `grep -c 'sleep 3\|sleep 2' scripts/recover-openclaw-agents.sh` — returns non-zero (retry delay)
  </verify>
  <done>
recover-openclaw-agents.sh uses jq for all registry operations (zero Python code), passes per-agent system_prompt via --append-system-prompt when launching Claude (with fallback to default-system-prompt.txt), implements one-retry-with-3s-delay per-agent error handling (no set -e), sends Telegram notification only on failures (silent on full success), has no --dry-run flag, and handles corrupt registry by backing up and creating fresh skeleton.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/recover-openclaw-agents.sh` passes (valid syntax)
2. No Python references: `grep -c 'python' scripts/recover-openclaw-agents.sh` returns 0
3. No dry-run: `grep -c 'dry.run' scripts/recover-openclaw-agents.sh` returns 0
4. jq used for registry: `grep 'jq' scripts/recover-openclaw-agents.sh` shows multiple jq operations
5. --append-system-prompt used: `grep 'append-system-prompt' scripts/recover-openclaw-agents.sh` shows Claude CLI integration
6. default-system-prompt.txt referenced: `grep 'default-system-prompt' scripts/recover-openclaw-agents.sh` shows fallback
7. system_prompt read from registry: `grep 'system_prompt' scripts/recover-openclaw-agents.sh` shows field extraction
8. Telegram notification: `grep 'openclaw agent' scripts/recover-openclaw-agents.sh` shows failure reporting
9. No set -e: `head -5 scripts/recover-openclaw-agents.sh` shows `set -uo pipefail` without -e
10. Retry delay present: `grep 'sleep' scripts/recover-openclaw-agents.sh` shows retry delay
</verification>

<success_criteria>
- recover-openclaw-agents.sh has no Python dependency (zero python3 references)
- Per-agent system_prompt from registry passed via --append-system-prompt to Claude
- Falls back to default-system-prompt.txt when agent has no system_prompt (silent, no logging)
- Per-agent error handling with one retry and 3-second delay
- Telegram notification on failures only; silent on full success
- No --dry-run flag
- Corrupt registry backed up with timestamp and fresh skeleton created
- Uses jq with `// ""` null coalescing for all optional fields
</success_criteria>

<output>
After completion, create `.planning/phases/03-launcher-updates/03-02-SUMMARY.md`
</output>
