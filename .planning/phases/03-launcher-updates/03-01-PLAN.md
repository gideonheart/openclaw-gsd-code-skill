---
phase: 03-launcher-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/spawn.sh
autonomous: true
requirements:
  - SPAWN-01
  - SPAWN-02
  - SPAWN-03
  - SPAWN-04
  - SPAWN-05

must_haves:
  truths:
    - "spawn.sh accepts <agent-name> <workdir> [first-command] as positional arguments with agent-name as primary key"
    - "spawn.sh reads system_prompt from registry for existing agents and uses it via --append-system-prompt"
    - "spawn.sh falls back to config/default-system-prompt.txt when agent has no system_prompt in registry"
    - "spawn.sh --system-prompt flag overrides both registry and default prompt entirely"
    - "spawn.sh --system-prompt auto-detects file path vs inline text"
    - "spawn.sh uses jq for all registry operations with zero Python code"
    - "spawn.sh auto-creates registry entry for unknown agents with sensible defaults"
    - "spawn.sh has no autoresponder flag, no autoresponder launch logic, no strict_prompt function"
  artifacts:
    - path: "scripts/spawn.sh"
      provides: "Registry-driven agent launcher with jq-only operations"
      min_lines: 120
      contains: "jq"
  key_links:
    - from: "scripts/spawn.sh"
      to: "config/recovery-registry.json"
      via: "jq upsert with atomic .tmp + mv pattern"
      pattern: "jq.*recovery-registry"
    - from: "scripts/spawn.sh"
      to: "config/default-system-prompt.txt"
      via: "cat fallback when no agent system_prompt"
      pattern: "default-system-prompt"
    - from: "scripts/spawn.sh"
      to: "claude --append-system-prompt"
      via: "final prompt passed to Claude Code CLI"
      pattern: "append-system-prompt"
---

<objective>
Rewrite spawn.sh from a multi-flag, Python-dependent launcher into a registry-driven, jq-only launcher where agent-name is the primary key.

Purpose: Simplify spawn.sh from 7 CLI flags to 3 positional arguments, replace Python upsert with jq, implement per-agent system prompt composition (agent replaces default per CONTEXT.md locked decision), and remove all legacy code (autoresponder, strict_prompt, --prd, --agent-id, --topic-id, --auto-wake flags).

Output: Rewritten scripts/spawn.sh
</objective>

<execution_context>
@/home/forge/.claude/get-shit-done/workflows/execute-plan.md
@/home/forge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-launcher-updates/03-CONTEXT.md
@.planning/phases/03-launcher-updates/03-RESEARCH.md
@config/recovery-registry.example.json
@config/default-system-prompt.txt
@scripts/spawn.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite spawn.sh as registry-driven jq-only launcher</name>
  <files>scripts/spawn.sh</files>
  <action>
Rewrite scripts/spawn.sh completely. The new script must follow these specifications exactly:

**CLI interface:**
```
spawn.sh <agent-name> <workdir> [first-command] [--system-prompt <text-or-file>]
```
- `agent-name` (required): Primary key for registry lookup. Also used as tmux session name prefix.
- `workdir` (required for new agents): Working directory. For registered agents, registry value is used; CLI arg overrides if provided.
- `first-command` (optional): Defaults to `claude` if not provided. This is the shell command to run inside tmux (e.g., `claude --dangerously-skip-permissions`).
- `--system-prompt <value>`: Explicit override. Auto-detect: if `[ -f "$value" ]` then read file contents, else treat as inline text. Overrides BOTH registry and default prompt.

**Startup checks:**
- Verify jq exists (`command -v jq`) before doing anything else. Clear error message if missing.
- Verify tmux exists.

**Registry operations (jq only, no Python):**
1. Resolve registry path: `$SKILL_ROOT/config/recovery-registry.json` where SKILL_ROOT is `$(cd "$(dirname "$0")/.." && pwd)`.
2. If registry file is missing, create minimal skeleton: `{"global_status_openclaw_session_id":"","global_status_openclaw_session_key":"","agents":[]}`.
3. If registry file exists but is not valid JSON: back up to `recovery-registry.json.corrupt-$(date +%s)`, create fresh skeleton, log warning.
4. Lookup agent by agent_id in `.agents[]`.
5. If agent NOT found: auto-create entry with defaults:
   ```json
   {
     "agent_id": "<agent-name>",
     "enabled": true,
     "auto_wake": true,
     "topic_id": 1,
     "openclaw_session_id": "",
     "working_directory": "<workdir>",
     "tmux_session_name": "<agent-name>-main",
     "claude_resume_target": "",
     "claude_launch_command": "claude --dangerously-skip-permissions",
     "claude_post_launch_mode": "resume_then_agent_pick",
     "system_prompt": "",
     "hook_settings": {}
   }
   ```
6. If agent found: update `working_directory` and `tmux_session_name` fields.
7. All jq writes use atomic pattern: write to `.tmp` file, then `mv` to actual path.

**System prompt composition (CONTEXT.md locked decision: REPLACEMENT model, NOT append):**
1. If `--system-prompt` CLI flag was provided: use that as final prompt (auto-detect file vs inline).
2. Else if agent's `system_prompt` field is non-empty in registry: use agent prompt (REPLACES default entirely).
3. Else: read `$SKILL_ROOT/config/default-system-prompt.txt` as final prompt.
4. Silent fallback - do NOT log when falling back to default (per CONTEXT.md).

**Tmux session creation:**
- Session name: read `tmux_session_name` from registry entry (defaults to `<agent-name>-main` for new agents).
- If session already exists: append `-2` suffix (per CONTEXT.md failure handling decision). Use a while loop: `while tmux has-session -t "$session_name" 2>/dev/null; do session_name="${base_session_name}-${counter}"; counter=$((counter + 1)); done`.
- If tmux server is not running: `tmux start-server` before creating session.
- Create session: `tmux new-session -d -s "$session_name" -c "$workdir"`.

**Claude Code launch:**
- Read `claude_launch_command` from registry (default: `claude --dangerously-skip-permissions`).
- Append ` --append-system-prompt <escaped-prompt>` to launch command. Use `printf %q` to safely escape the prompt.
- Send via `tmux send-keys`.
- Wait 1 second for TUI startup.

**First command:**
- If `first-command` CLI arg was provided: send it via `tmux send-keys -l`.
- If not provided: keep the existing `choose_first_cmd` logic that auto-detects /init, /gsd:resume-work, /gsd:new-project, or /gsd:help based on workdir state.
- Send with Enter key after.

**Update registry after launch:**
- Update the agent's `tmux_session_name` in registry to the actual session name used (may have `-2` suffix).

**Code to DELETE entirely:**
- `strict_prompt()` function (SPAWN-04)
- `--autoresponder` flag and all autoresponder launch logic (SPAWN-03)
- `--prd` flag and PRD resolution logic
- `--agent-id`, `--topic-id`, `--auto-wake` flags
- `upsert_recovery_registry_entry()` function (Python code)
- `derive_agent_id_from_session_name()` function
- All `python3` references

**Code to KEEP (adapt as needed):**
- `log()` and `die()` helper functions
- `require_bin()` / startup checks (add jq)
- `is_non_empty_project()` function
- `choose_first_cmd()` function
- Git preflight info logging

**Naming conventions per CLAUDE.md:**
- All function names must be self-explanatory, NO abbreviations
- All variable names must be self-explanatory, NO abbreviations
- Script must be DRY and follow SRP

**Script header:** `#!/usr/bin/env bash` with `set -euo pipefail`.
  </action>
  <verify>
Run these checks:
1. `bash -n scripts/spawn.sh` — syntax validation passes
2. `grep -c 'python3\|python ' scripts/spawn.sh` — returns 0 (no Python)
3. `grep -c 'autoresponder' scripts/spawn.sh` — returns 0 (no autoresponder)
4. `grep -c 'strict_prompt' scripts/spawn.sh` — returns 0 (no strict_prompt)
5. `grep -c 'jq ' scripts/spawn.sh` — returns non-zero (jq is used)
6. `grep -c 'append-system-prompt' scripts/spawn.sh` — returns non-zero
7. `grep -c 'default-system-prompt' scripts/spawn.sh` — returns non-zero
8. `grep -c '\-\-prd' scripts/spawn.sh` — returns 0 (no --prd flag)
9. `grep -c '\-\-agent-id' scripts/spawn.sh` — returns 0
10. `grep -c '\-\-topic-id' scripts/spawn.sh` — returns 0
  </verify>
  <done>
spawn.sh accepts `<agent-name> <workdir> [first-command] [--system-prompt <value>]`, uses jq for all registry operations, composes system prompt with replacement model (agent overrides default), has no Python code, no autoresponder logic, no strict_prompt function, no --prd/--agent-id/--topic-id/--auto-wake flags. Registry entries are auto-created for unknown agents with sensible defaults. Tmux session name conflicts are resolved with `-2` suffix. Atomic writes via .tmp + mv pattern.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/spawn.sh` passes (valid syntax)
2. No Python references: `grep -c 'python' scripts/spawn.sh` returns 0
3. No autoresponder: `grep -c 'autoresponder' scripts/spawn.sh` returns 0
4. No strict_prompt: `grep -c 'strict_prompt' scripts/spawn.sh` returns 0
5. jq used for registry: `grep 'jq' scripts/spawn.sh` shows registry operations
6. --append-system-prompt used: `grep 'append-system-prompt' scripts/spawn.sh` shows Claude CLI integration
7. default-system-prompt.txt referenced: `grep 'default-system-prompt' scripts/spawn.sh` shows fallback path
8. --system-prompt flag supported: `grep '\-\-system-prompt' scripts/spawn.sh` shows CLI flag
9. Atomic write pattern: `grep '\.tmp' scripts/spawn.sh` shows tmp file usage
10. No legacy flags: `grep -E '\-\-(prd|agent-id|topic-id|auto-wake)' scripts/spawn.sh` returns empty
</verification>

<success_criteria>
- spawn.sh is a single, self-contained bash script with no Python dependency
- Agent-name is the primary key; all config reads from registry via jq
- System prompt follows replacement model: CLI override > registry agent prompt > default file
- All 5 legacy flags removed (--prd, --autoresponder, --agent-id, --topic-id, --auto-wake)
- strict_prompt() function deleted, Python upsert_recovery_registry_entry() deleted
- Registry auto-creates entries for unknown agents
- Tmux session name conflict resolved with -2 suffix (not die/abort)
</success_criteria>

<output>
After completion, create `.planning/phases/03-launcher-updates/03-01-SUMMARY.md`
</output>
