---
status: resolved
trigger: "Investigate TWO related issues in the OpenClaw hook event system: (1) Queue cancellation during AskUserQuestion flows, (2) Session mismatch between OpenClaw UI and Warden dashboard"
created: 2026-02-22T00:00:00Z
updated: 2026-02-22T23:05:00Z
symptoms_prefilled: true
---

## Current Focus

hypothesis: Both issues resolved — fix verified via 5 functional tests, committed.
test: Completed.
expecting: Completed.
next_action: Archive to resolved/

## Symptoms

expected: (Issue 1) UserPromptSubmit during AskUserQuestion flows should NOT cancel queues — the user is answering a question, not "taking over". (Issue 2) OpenClaw UI and Warden dashboard should show the same active conversation for the same agent.
actual: (Issue 1) Every AskUserQuestion answer triggers UserPromptSubmit → cancels queue → Gideon re-queues → loop. (Issue 2) OpenClaw UI shows whatsapp:g-agent-warden-main, Warden dashboard shows different content (discuss-phase with AskUserQuestion).
errors: No errors, just repeated queue cancellation/re-creation visible in JSONL logs; no errors for Issue 2 either.
reproduction: (Issue 1) Run discuss-phase with AskUserQuestion while Gideon has a queue pending for the same session. (Issue 2) Compare the two UIs side-by-side.
started: Unknown — likely introduced when AskUserQuestion lifecycle was built in Phase 04.

## Eliminated

- hypothesis: isPromptFromTuiDriver was not working at all
  evidence: isPromptFromTuiDriver correctly detects /gsd:* queue commands typed by tui-driver.mjs, but tui-driver-ask.mjs types TUI keystrokes (Down/Enter/Space/text) not slash commands — those never match
  timestamp: 2026-02-22T22:50:00Z

- hypothesis: Issue 2 gateway delivery is broken / messages go to wrong agent
  evidence: Tested both --session-id 86717f98 and --session-id aca04841 — both route to agent:warden:main session (updated from 22:38:46 to 22:44:49); openclaw routes by --agent warden regardless of --session-id when UUID doesn't match a session key
  timestamp: 2026-02-22T22:55:00Z

## Evidence

- timestamp: 2026-02-22T00:00:00Z
  checked: Session log /home/forge/.openclaw/agents/warden/sessions/aca04841-f858-415e-b78c-f5b0e08a729c.jsonl
  found: At 22:20:49, 22:21:58, 22:24:28, UserPromptSubmit fires when user answers questions → queue cancelled each time. Gideon re-queues the same commands after each cancellation.
  implication: Queue cancellation logic in UserPromptSubmit does not distinguish AskUserQuestion answers from manual takeover.

- timestamp: 2026-02-22T22:48:00Z
  checked: lib/ask-user-question.mjs + bin/tui-driver-ask.mjs
  found: pending-answer-{session}.json is created by savePendingAnswer() BEFORE tui-driver-ask.mjs types keystrokes; deleted by PostToolUse handler after verification. File exists exactly during the window when AskUserQuestion is being answered.
  implication: Checking for pending-answer-{session}.json in UserPromptSubmit is a reliable signal that the session is in AskUserQuestion flow.

- timestamp: 2026-02-22T22:50:00Z
  checked: logs/queues/queue-agent_warden-kingdom_session_name.json + pending-answer-agent_warden-kingdom_session_name.json
  found: Current live state: pending-answer file exists (action=chat), queue exists with command=/gsd:quick Fix queue cancellation...
  implication: The bug is actively happening right now; confirms the fix approach is correct.

- timestamp: 2026-02-22T22:52:00Z
  checked: agents/warden/sessions/sessions.json + agent-registry.json
  found: Registry openclaw_session_id=86717f98-2a84-4f3f-99c7-02a11782430f does NOT appear in warden sessions.json as any key or sessionId value. The UUID was generated by randomUUID() in rotate-session.mjs without relationship to any actual openclaw session. Most recent warden session key=agent:warden:main, sessionId=aca04841-f858-415e-b78c-f5b0e08a729c.
  implication: rotate-session.mjs creates a random UUID that has no connection to openclaw's actual session tracking. The --session-id flag is ignored by openclaw when it doesn't match, falling back to agent:warden:main.

- timestamp: 2026-02-22T22:55:00Z
  checked: openclaw sessions --json + live test of wakeAgentViaGateway calls
  found: Gateway delivery IS working — messages reach the correct warden session (agent:warden:main). The stale openclaw_session_id doesn't break delivery because openclaw routes by --agent warden. Issue 2 is a data consistency/stale-registry problem, not a broken delivery problem.
  implication: Issue 2 fix = update rotate-session.mjs to use the actual openclaw session ID (from warden/sessions/sessions.json) instead of randomUUID(). But this requires reading the correct sessionId at rotation time.

- timestamp: 2026-02-22T23:03:00Z
  checked: All 5 functional tests after fix
  found: Test 1 (isSessionInAskUserQuestionFlow with pending-answer file): PASS. Test 2 (isPromptFromTuiDriver exact queue command match): PASS. Test 3 (isPromptFromTuiDriver non-matching manual input): PASS. Test 4 (isSessionInAskUserQuestionFlow nonexistent session): PASS. Test 5 (registry sessionId matches actual openclaw session): PASS.
  implication: Both fixes verified correct.

## Resolution

root_cause: (Issue 1) UserPromptSubmit fires for ALL input including tui-driver-ask.mjs keystrokes (TUI navigation keys for AskUserQuestion answers). isPromptFromTuiDriver only guards against /gsd:* slash command matches, not keystroke sequences. There was no guard for AskUserQuestion answer flows. (Issue 2) rotate-session.mjs used randomUUID() for new openclaw_session_id but this UUID had no relationship to openclaw's actual session store — it was purely a random value that became stale immediately since openclaw had its own session (agent:warden:main → aca04841).
fix: (Issue 1) Added isSessionInAskUserQuestionFlow(sessionName) to lib/queue-processor.mjs — checks existsSync on pending-answer-{session}.json. Added check in event_user_prompt_submit.mjs between isPromptFromTuiDriver and cancelQueueForSession — skips cancellation if session is in AskUserQuestion flow. Exported from lib/index.mjs. (Issue 2) Updated rotate-session.mjs to read actual sessionId from agents/{agentId}/sessions/sessions.json (most recently updated session) via resolveActiveOpenclawSessionId(); throws if sessions.json is missing; exits without error if sessionId is already current. Also ran rotate-session.mjs to fix the stale registry immediately.
verification: 5 functional tests all PASS. Syntax check (node --check) on all changed files: OK. agent-registry.json now shows openclaw_session_id=aca04841-f858-415e-b78c-f5b0e08a729c matching the actual warden session.
files_changed:
  - events/user_prompt_submit/event_user_prompt_submit.mjs
  - lib/queue-processor.mjs (already in HEAD from quick-19 — isSessionInAskUserQuestionFlow was pre-committed)
  - lib/index.mjs
  - bin/rotate-session.mjs
  - config/agent-registry.json (gitignored — fixed on disk only)
